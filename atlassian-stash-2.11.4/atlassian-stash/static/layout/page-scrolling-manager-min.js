define("layout/page-scrolling-manager",["aui","bacon","jquery","util/bacon","util/function","util/scroll","util/region-scroll-forwarder","exports"],function(N,B,H,O,M,I,J,G){var D=H(window);function F(){var g;var W=H(window);var T=document.body;var Z=H(T);var V=H("#page");var h=V[0];var P=T.style.height;Z.addClass("scrolling-forwarded");var Q=new B.Bus();var X=new B.Bus();var U=new B.Bus();var Y=new B.Bus();var R=new B.Bus();var b=U.toProperty();var d=Y.skipDuplicates(function(j,i){return j.height===i.height&&j.clientHeight===i.clientHeight}).toProperty();var a=R.map(function(j){var i=V.offset();return{top:Math.round(j.top-i.top)}}).skipDuplicates(function(j,i){return j.top===i.top}).toProperty();U.onValue(function(i){Y.push(i.scrollSizing());R.push(i.offset())});b.onValue(function(i){g=i});b.sampledBy(O.getWindowSizeProperty().changes()).onValue(function(i){R.push(i.offset())});b.sampledBy(B.interval(1000)).takeUntil(Q).onValue(function(i){R.push(i.offset())});B.combineWith(function(k,j,i){return k.top+Math.max(j.height,j.clientHeight)+(i.height-j.clientHeight)},a,d,O.getWindowSizeProperty()).onValue(function(i){Z.height(i)});var c=I.fakeScroll(h);O.getWindowScrollProperty().takeUntil(Q).onValue(function(i){c(i.left,null)});var f;function S(){return new J(O.getWindowScrollProperty(),[{id:"pre",groupId:"outside",setScrollTop:function(i){c(null,i)},getHeight:function(){return(g.offset().top-V.offset().top)}},{id:"in",groupId:"inside",setScrollTop:function(i){g.scroll(null,i)},getHeight:function(){return Infinity}}])}var e=b.subscribe(function(i){f=S();a.takeUntil(Q).onValue(function(){f.heightsChanged()});e()});B.combineAsArray(X,a.sampledBy(X),d.sampledBy(X)).map(M.spread(function(i,k,j){return{scrollTop:i.scrollTop!=null?k.top+Math.max(0,Math.min(i.scrollTop,j.height-j.clientHeight)):null}})).onValue(function(i){if(i.scrollTop!=null){W.scrollTop(i.scrollTop)}});return{setTarget:function(i){U.push(i)},scroll:function(j,i){X.push({scrollTop:i})},refresh:function(){Y.push(g.scrollSizing());R.push(g.offset())},destroy:function(){Z.removeClass("scrolling-forwarded");c(0,0);T.style.height=P||null;X.end();Q.push(true);Q.end();Y.end();R.end();U.end();if(f){f.destroy()}}}}var A=false;var C;var K;function L(){if(A){throw new Error("acceptScrollForwardingRequests has already been called. It must be unregistered before it can be called again.")}A=true;C=null;return function(){if(K){N.log("Scroll control is not yet destroyed. Ongoing scroll requests will be ignored.");K.scrollTo=H.noop;K.destroy()}A=false}}function E(){var P;if(!A){return H.Deferred().reject({reason:"NOT_ACCEPTING"})}if(K){return H.Deferred().reject({reason:"CONTROL_TAKEN"})}H("#footer").hide();K=F();function Q(){D.scrollTop(Math.min(C,P.offset().top-H("#page").offset().top))}K.setTarget=(function(R){return function S(U){var T=R.apply(this,arguments);P=U;var V=!K;if(C!=null&&!V){Q();C=null}return T}})(K.setTarget);K.destroy=(function(R){return function S(){if(P){C=D.scrollTop();Q()}H("#footer").show();K=null;return R.apply(this,arguments)}})(K.destroy);return H.Deferred().resolve(K)}G.acceptScrollForwardingRequests=L;G._requestScrollControl=E});