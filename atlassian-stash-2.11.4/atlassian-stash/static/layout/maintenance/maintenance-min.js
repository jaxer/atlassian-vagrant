define("layout/maintenance",["aui","jquery","util/navbuilder","util/ajax","widget/confirm-dialog","widget/progress-bar","exports"],function(H,C,I,G,J,K,B){function D(L,N,M){L.val(M.cancelingButtonText).prop("disabled",true).toggleClass("disabled",true);N.update({message:M.cancelingDescription,percentage:100});N.reversed(true);N.active(true);C("#backup-description").hide();C("#content > header > h1").text(M.canceledHeader)}function A(L){location.href=L.redirectUrl}function E(M,L,O,N){if(L.task){if(L.task.state&&L.task.state!=="RUNNING"){return true}M.update(L.task.progress);if(L.task.progress.percentage===100){return true}}return undefined}function F(M,N){var L=false;var O=G.poll({url:M.pollUrl,pollTimeout:Infinity,interval:500,statusCode:{"404":function(){A(M);return false},"*":function(){return false}},tick:function(P,R,Q){return M.pollTickCallback(N,P,R,Q)}});O.cancel=function(){L=true};O.isCancelled=function(){return L};return O}B.init=function(M){var Q={pollUrl:H.contextPath()+"/mvc/maintenance",pollTickCallback:E,cancelTriggerSelector:".cancel-link",cancelFormSelector:".cancel-form",progressBarSelector:"#progress",redirectUrl:I.allProjects().build(),cancelButtonSelector:"#cancel",canceledHeader:stash_i18n("stash.web.maintenance.canceled.title","Maintenance Canceled"),cancelingButtonText:stash_i18n("stash.web.maintenance.canceling.button","Canceling..."),cancelingDescription:stash_i18n("stash.web.maintenance.canceling.description","Canceling maintenance."),hasCancelDialog:true,cancelDialogId:"cancel-maintenance-dialog",cancelDialogTitle:stash_i18n("stash.web.maintenance.dialog.title","Performing Maintenance"),cancelDialogTitleClass:"warning-header",cancelDialogDescription:stash_i18n("stash.web.maintenance.dialog.description","Are you sure you want to cancel maintenance?"),cancelDialogButtonText:stash_i18n("stash.web.maintenance.dialog.cancel","Cancel maintenance")};var N=C.extend({},Q,M);var L=C(N.cancelTriggerSelector);L.on("click",function(S){C(N.cancelFormSelector).addClass("visible");L.hide();S.preventDefault()});var P=K(N.progressBarSelector);var O=F(N,P).done(function(S){A(N)});if(N.hasCancelDialog){var R=new J({id:N.cancelDialogId,titleText:N.cancelDialogTitle,titleClass:N.cancelDialogTitleClass,panelContent:C("<p></p>").text(N.cancelDialogDescription),submitText:N.cancelDialogButtonText});R.addCancelListener(function(){O.resume();P.active(true)});R.addConfirmListener(function(T,S,U){O.cancel();U();D(S,P,N)});R.attachTo(N.cancelButtonSelector,function(){O.pause();P.active(false)});C(N.cancelFormSelector).find('input[name="token"]').each(function(){var S=C(this);var T=C(N.cancelButtonSelector);T.prop("disabled",!C.trim(S.val()));S.on("input",function(){T.prop("disabled",!C.trim(S.val()))})})}}});