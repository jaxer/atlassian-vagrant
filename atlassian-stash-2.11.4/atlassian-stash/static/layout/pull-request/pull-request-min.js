define("layout/pull-request",["jquery","util/events","underscore","memoir","aui","util/ajax","util/navbuilder","util/feature-loader","util/dom-event","model/page-state","model/pull-request","model/participant","widget/approve","widget/avatar-list","widget/confirm-dialog","widget/submit-spinner","feature/pull-request-edit","feature/pull-request/can-merge","feature/pull-request/merge-help","exports"],function(T,Q,n,B,N,U,J,g,k,M,X,m,Y,c,H,o,I,G,S,d){var W,E,e,D;var f=T.Deferred();function F(q,r){var p=J.rest().currentPullRequest()[q]();if(r){p=p.withParams({version:M.getPullRequest().getVersion()})}return p.build()}function l(q,p){q.click({action:p},i)}function h(q){if(q.length){var p={dialog:{person:M.getCurrentUser()&&M.getCurrentUser().toJSON(),pullRequest:W.toJSON()},ajax:{statusCode:{"400":function(){return false},"401":function(t,v,s,u,r){return T.extend({},r,{title:stash_i18n("stash.web.pull-request.merge.error.401.title","Could not merge pull request"),message:stash_i18n("stash.web.pull-request.merge.error.401.message","You no longer have permission to merge this pull request."),fallbackUrl:false,shouldReload:true})},"409":function(u,w,t,v,r){var s=v.errors&&v.errors.length&&v.errors[0];if(s&&(s.conflicted||(s.vetoes&&s.vetoes.length))){Q.trigger("stash.pull-request.cant.merge",null,W,s.conflicted,s.vetoes);Q.trigger("stash.pull-request.show.cant.merge.help");return false}}}}};Z(q,p);O(q)}}function R(p){if(p.length){var r="<p class='decline-message'>"+stash_i18n("stash.web.pull-request.decline.dialog.message","Are you sure you want to decline this pull request? This will close the pull request without merging.")+"</p>";var q={buttonSelector:".decline-pull-request",confirmDialog:{titleText:stash_i18n("stash.web.pull-request.decline.dialog.title","Decline Pull Request"),panelContent:r,submitText:stash_i18n("stash.web.button.decline","Decline")},ajax:{statusCode:{"401":function(u,w,t,v,s){return T.extend({},s,{title:stash_i18n("stash.web.pull-request.decline.error.401.title","Could not decline pull request"),message:stash_i18n("stash.web.pull-request.decline.error.401.message","You no longer have permission to decline this pull request."),fallbackUrl:false,shouldReload:true})}}}};K("decline",q)}}function i(p){p.preventDefault();if(E.hasClass("disabled")){return }E.addClass("disabled");e.show().spin("small");U.rest({url:F(p.data.action,true),type:"POST"}).done(function(){window.location.reload()}).fail(function(){E.removeClass("disabled");e.spinStop().hide()})}function K(t,r){var p=new H(T.extend({id:"pull-request-"+t+"-dialog",submitToHref:false,resizeOnShow:true,width:650,height:200},r.confirmDialog));var q;var s;p.addConfirmListener(function(AA,u,y,w,x){p.setButtonsDisabled(true);x.show();q=U.rest(T.extend({url:F(t,true),type:"POST"},r.ajax));var v=q;if(s){var z=s(q,u,y,w,x);if(z){v=z}}v.done(function(){window.location=J.currentPullRequest().build()}).fail(function(){y()}).always(function(){q=null})});p.addCancelListener(function(u){if(q){q.abort()}});p.setPromiseDecorator=function(u){s=u};p.attachTo(r.buttonSelector,r.onShow);return p}function Z(s,q){var t=N.dialog2(stash.feature.pullRequest.merge.dialog(q.dialog));T("body").append(t.$el);s.on("click",function(){t.show();t.$el.find(".confirm-button").focus()});var p;var r;t.$el.find(".confirm-button").on("click",function(){var x=new o(this,"before");j(t,true);x.show();p=U.rest(T.extend({url:F("merge",true),type:"POST"},q.ajax));var u=p;p.fail(function(AB,AC,z,AA){if(AB.status===400){var y=t.$el.find(".aui-dialog2-content");if(AA.errors){y.children(".aui-message").remove();y.prepend(stash.feature.pullRequest.merge.errors({errors:AA.errors}))}x.hide();j(t,false)}else{t.hide()}}).always(function(){p=null});if(!r){try{r=require("pullRequest/branchDeletion").getMergePromiseDecorator}catch(v){}}if(r){var w=r(u,function(){t.hide()});if(w){u=w}}u.done(function(){window.location=J.currentPullRequest().build()})});t.$el.find(".cancel-button").on("click",function(){if(p){p.abort();p=null}t.hide()});return t}function b(){Q.on("stash.widget.keyboard-shortcuts.register-contexts",function(p){p.enableContext("pull-request");f.resolve(p)});Q.on("stash.keyboard.shortcuts.requestGotoPullRequestsListHandler",function(p){(this.execute?this:N.whenIType(p)).execute(function(){window.location.href=J.currentRepo().allPullRequests().build()})});Q.on("stash.keyboard.shortcuts.requestChangePullRequestSectionHandler",function(p){(this.execute?this:N.whenIType(p)).execute(function(s){var r=parseInt(String.fromCharCode(s.which),10);var q=D.children().eq(r-1).children("a");if(B.nativeSupport()){q.click()}else{window.location.href=q.prop("href")}})})}function j(q,r){var p=q.$el.find(".aui-dialog2-footer-actions .aui-button");p.each(function(){var s=T(this);s.prop("disabled",r).toggleClass("disabled",r);if(r){s.attr("aria-disabled","true")}else{s.removeAttr("aria-disabled")}})}function O(q){var p;Q.on("stash.pull-request.cant.merge",function(s,t,r){if(!p){q.attr("aria-disabled","true").attr("disabled","disabled").attr("title",stash_i18n("stash.web.pull-request.merge.issue.tooltip","This pull request can''t be merged automatically."));p=T(stash.feature.pullRequest.mergeDisabledIcon({conflicted:t,vetoes:r})).insertBefore(q).tooltip({delayOut:200,gravity:"n",html:true,hoverable:true,offset:7}).on("click",function(u){u.preventDefault();T(".tipsy").hide();Q.trigger("stash.pull-request.show.cant.merge.help")})}});Q.on("stash.pull-request.can.merge",function(){if(p){q.attr("aria-disabled","false").removeAttr("disabled").removeAttr("title");p.remove();p=null}});G(W)}function A(){function p(q){q.addClass("active-tab").siblings().removeClass("active-tab")}f.done(function(q){n.each(D.children(),function(t,r){var v=T(t);var s=String(r+1);var u=stash_i18n("stash.keyboard-shortcuts.pull-request.switch.tabs","Switch to the {0} tab",v.text());q.addCustomShortcut("pull-request",[[s]],u);v.attr("title",(v.attr("title")||u)+stash_i18n("stash.keyboard-shortcuts.type.x"," (Type ''{0}'')",s))})});if(B.nativeSupport()){D.on("click","a",function(s){if(!k.openInSameTab(s)){return }var r=T(this),q=r.parent();if(!q.is(".active-tab")){p(q);Q.trigger("stash.layout.pull-request.urlRequested",null,r.prop("href"))}s.preventDefault()});Q.on("stash.page.pull-request.view.contextLoaded",function(q){p(D.find('[data-module-key="'+q.name+'"]'))})}}function a(p){return new c(p,W.getReviewers(),{pullRequestId:W.getId()})}function P(){function p(r){var s=W.getReviewers().findByUser(r.user);if(s){s.setApproved(r.approved);W.getReviewers().sort()}else{var q=W.getParticipants().findByUser(r.user);if(q){q.setApproved(r.approved);W.getParticipants().sort()}}}Q.on("stash.widget.approve-button.adding",p);Q.on("stash.widget.approve-button.removing",p);Q.on("stash.widget.approve-button.add.failed",p);Q.on("stash.widget.approve-button.remove.failed",p)}function V(){function p(r){var t=new m(r);var s=W.getReviewers().findByUser(t.getUser());if(!s){var q=W.getParticipants().findByUser(t.getUser());if(!q){W.addParticipant(t);return true}}return false}Q.on("stash.widget.approve-button.adding",function(q){p({approved:q.approved,user:q.user,role:"PARTICIPANT"})});Q.on("stash.feature.comments.commentAdded",function(q){if(q.author.name!==W.getAuthor().getUser().getName()){p({approved:false,user:q.author,role:"PARTICIPANT"})}});W.getParticipants().on("add",function(r){var q=M.getCurrentUser();if(q&&q.getName()===r.getUser().getName()){M.setIsWatching(true)}})}var L=new g({loadedEvent:"stash.page.pull-request.view.contextLoaded",unloadedEvent:"stash.page.pull-request.view.contextUnloaded",requestedEvent:"stash.page.pull-request.view.contextRequested"});function C(p,q){L.registerHandler("stash.pull-request.nav.diff",/^[^\?\#]*pull-requests\/\d+\/diff/,"page/pull-request/view/pull-request-view-diff");L.registerHandler("stash.pull-request.nav.overview",/^[^\?\#]*pull-requests\/\d+\/overview/,"page/pull-request/view/pull-request-view-overview");L.registerHandler("stash.pull-request.nav.commits",/^[^\?\#]*pull-requests\/\d+\/commits/,"page/pull-request/view/pull-request-view-commits");Q.on("stash.widget.keyboard-shortcuts.register-contexts",function(r){L.setKeyboardShortcuts(r);r.enableContext("pull-request")});Q.on("stash.layout.pull-request.urlRequested",function(r){if(r!==window.location.href){B.pushState(null,"",r)}});Q.on("stash.util.feature-loader.errorOccurred",function(r){if(r.code===g.NO_HANDLER){console.log("You did not register a handler for this page. Please call\nrequire('layout/pull-request').registerHandler(\n   'tab-web-item-module-key',\n   /^[^\\?\\#]*url-regex/,\n   {\n       load : function (contentElement) {},\n       unload : function (contentElement) {}\n   }\n)")}else{console.log(r.message)}});q.done(function(r){L.init(T(p).get(0))})}d.registerHandler=T.proxy(L.registerHandler,L);d.onReady=function(w,q,z,s,AB,u,y){M.setPullRequest(new X(w));M.extend("pullRequestViewInternal",function(){return{diffTreeHeaderWebItems:s,commitsTableWebSections:AB,maxChanges:u,relevantContextLines:y}});M.extend("isWatching");var t=T.Deferred();_PageDataPlugin.ready("com.atlassian.stash.stash-web-plugin:iswatching-provider","stash.internal.pull-request.view",function(AC){M.setIsWatching(AC.isWatching);t.resolve()});S.init();W=M.getPullRequest();var r=T(".merge-pull-request"),p=T(".decline-pull-request"),v=T(".reopen-pull-request"),x=T(".approve"),AA=new I(W);E=T(".pull-request-toolbar .aui-toolbar2-secondary");e=T("<div class='spinner'/>").prependTo(E.children(":first-child"));D=T(".content-body .aui-page-panel-content > .aui-tabs > .tabs-menu");h(r);R(p);l(v,"reopen");AA.bind(".edit-pull-request, .add-description");new Y(x,F("approve"));a(T(".reviewers"));V();P();b();A();C(z,t)}});