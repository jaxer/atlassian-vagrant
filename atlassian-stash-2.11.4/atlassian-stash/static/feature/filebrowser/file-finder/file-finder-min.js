define("feature/filebrowser/file-finder",["aui","jquery","underscore","util/events","util/ajax","util/function","util/navbuilder","util/regexp","model/path","widget/keyboard-controller","widget/paged-scrollable","exports"],function(I,E,S,B,N,J,H,U,Q,K,F,T){var G=K.ListKeyboardController;function P(V){var W=H.rest().currentRepo().files().all().at(V.getId());return W.build()}function D(X,V){var W=H.currentRepo().browse().path(X);if(!V.isDefault()){W=W.at(V.getDisplayId())}return W.build()}function C(V){return(V!==V.toUpperCase())?"["+U.escape(V.toUpperCase()+V)+"]":U.escape(V)}function A(V){return V.replace(/(^\s*)|(\s*$)/gi,"").replace(/[ ]{2,}/gi," ")}function L(W){if(W){var X="",Y=A(W).split(/\*|\s|(?=[A-Z0-9]|\/|\.|-|_)/g);Y=S.filter(Y,J.not(S.isEmpty));var Z=Y.length;if(Z){X+="("+S.map(Y[0].split(""),C).join("")+")";for(var V=1;V<Z;V++){X+=".*?("+S.map(Y[V].split(""),C).join("")+")"}return new RegExp("("+X+")","g")}}return null}function M(V,W){W=I.escapeHtml(W);return V?W.replace(V,"<strong>$1</strong>"):W}function R(W,V){var X=this;this._isLoaded=false;this.fileTableSelector=W;this.currentRevisionRef=V;this.resultSetId=0;this.$fileFinderInput=E(".file-finder-input");this.$textInput=E("input.filter-files");this.$finderTip=E("#file-finder-tip");this.$spinner=E("<div class='spinner'/>").hide().insertAfter(this.fileTableSelector);B.on("stash.page.filebrowser.revisionRefChanged",function(Y){X.currentRevisionRef=Y;X.files=undefined})}R.prototype.tips=[stash_i18n("stash.web.filefinder.tip.1","Filter by directory path e.g. ''<strong>/ssh pom.xml</strong>'' to search for ''src<strong>/ssh/pom.xml</strong>''."),stash_i18n("stash.web.filefinder.tip.2","Use camelCasing e.g. ''<strong>ProjME</strong>'' to search for ''<strong>ProjectModifiedE</strong>vent.java''."),stash_i18n("stash.web.filefinder.tip.3","Filter by extension type e.g. ''<strong>/repo .js</strong>'' to search for all ''<strong>.js</strong>'' files in the ''<strong>/repo</strong>'' directory."),stash_i18n("stash.web.filefinder.tip.4","Separate your search with spaces e.g. ''<strong>/ssh pom.xml</strong>'' to search for ''src<strong>/ssh/pom.xml</strong>''."),stash_i18n("stash.web.filefinder.tip.5","Use ↑ and ↓ arrow keys to navigate and ''<strong>return</strong>'' to view the file.")];R.prototype._bindKeyboardNavigation=function(){this._filesKeyboardController=new G(this.$textInput,E(this.fileTableSelector),{wrapAround:false,focusedClass:"focused-file",itemSelector:"tr.file-row",onSelect:function(V){window.location.href=V.find("a").attr("href")},requestMore:function(){var V=E.Deferred();window.scrollTo(0,document.documentElement.scrollHeight);setTimeout(function(){V.resolve()});return V}})};R.prototype._showSpinner=function(){E(".filebrowser-banner").empty();E(this.fileTableSelector).empty();this.$spinner.show().spin("large")};R.prototype._hideSpinner=function(){this.$spinner.spinStop().hide()};R.prototype.isLoaded=function(){return this._isLoaded};R.prototype.unloadFinder=function(){E(".breadcrumbs").removeClass("file-finder-mode");this.$textInput.blur().hide().val("");this.$fileFinderInput.removeClass("visible");this.$finderTip.removeClass("visible");this._isLoaded=false;if(this._filesKeyboardController){this._filesKeyboardController.destroy();this._filesKeyboardController=null}this.tableView.reset()};R.prototype.loadFinder=function(){E(".filebrowser-banner").empty();E(".breadcrumbs").addClass("file-finder-mode");this.$textInput.focus();if(!this._isLoaded){this.requestFiles();this._isLoaded=true}};R.prototype.requestFiles=function(){var V=this;this._showSpinner();if(this.files){this.onFilesLoaded();this._hideSpinner()}else{N.rest({url:P(V.currentRevisionRef)}).done(function(Y){var X=Y.values;V.files=[];for(var W=0;W<X.length;W++){V.files.push({name:X[W]})}V.onFilesLoaded()}).always(function(){V._hideSpinner()})}};R.prototype.onFilesLoaded=function(){var W=this;this.$fileFinderInput.addClass("visible");this.$textInput.show();var V=this.tips[Math.floor(Math.random()*this.tips.length)];this.$finderTip.html(stash_i18n("stash.web.filefinder.tip.label","Tip: ")+V).addClass("visible");this.showFiles();this._bindKeyboardNavigation();this._filesKeyboardController.moveToNext();var Z=this.$textInput,X=Z.val();function Y(a){W.showFiles(a);W._filesKeyboardController.setListElement(E(W.fileTableSelector));W._filesKeyboardController.moveToNext()}this.$textInput.unbind("keyup").on("keyup",function(a){if(a.keyCode===27){B.trigger("stash.feature.filetable.hideFind",W)}}).on("keyup",S.debounce(function(a){if(a.keyCode!==27&&X!==(X=Z.val())){Y(E(this).val())}},200)).focus();if(X){Y(X)}};R.prototype.showFiles=function(V){this.filteredFiles=this.files;var Z=L(V);if(this.tableView){this.tableView.reset()}if(Z&&this.files.length>0){this.filteredFiles=S.filter(this.files,function(a){Z.lastIndex=0;return Z.test(a.name)});Z.lastIndex=0;if(!E.browser.msie||parseInt(E.browser.version,10)>=9){var Y=new RegExp(Z.source+"(?!.*/)");var W=function(a){if(a.exactMatches){return a.exactMatches}return(a.exactMatches=(a.name.indexOf(V)>=0))};var X=function(a){if(a.matches){return a.matches}return(a.matches=Y.test(a.name))};this.filteredFiles.sort(function(a,f){var d=W(a),e=W(f);if(d!==e){return d?-1:1}var c=X(a),b=X(f);if(c===b){return a.name.localeCompare(f.name)}return c?-1:1})}}else{S.forEach(this.files,function(a){a.highlightedName=null;a.matches=null;a.exactMatches=null})}this._makeFileFinderView(Z)};R.prototype._makeFileFinderView=function(V){this.tableView=new O(this.filteredFiles,V,this.fileTableSelector,this.currentRevisionRef,this.resultSetId++);this.tableView.init()};function O(X,Y,W,V,Z){F.call(this,null,{pageSize:50});this.pattern=Y;this.fileTableSelector=W;this.filteredFiles=X;this.currentRevisionRef=V;this.resultSetId=Z}E.extend(O.prototype,F.prototype);O.prototype.requestData=function(Y,V){var W=this,X=this.filteredFiles.slice(Y,Y+V);S.forEach(X,function(Z){if(!Z.url){Z.url=D(new Q(Z.name),W.currentRevisionRef)}Z.highlightedName=M(W.pattern,Z.name)});return E.Deferred().resolve({values:X,size:X.length,isLastPage:(Y+V)>=this.filteredFiles.length})};O.prototype.attachNewContent=function(a,Z){var Y=E(this.fileTableSelector);if(Z==="html"){var X=E(stash.feature.filefinder.fileFinderTable({files:a.values,resultSetId:this.resultSetId}));Y.replaceWith(X)}else{var W=Z==="append",V=E(Y,"table > tbody");S.each(a.values,function(c){var b=E(stash.feature.filefinder.fileFinderRow(E.extend({},c,{name:c.highlightedName})));if(W){V.append(b)}else{V.prepend(b)}})}};T.FileFinder=R;R.highlightMatches=M;R.getPattern=L});