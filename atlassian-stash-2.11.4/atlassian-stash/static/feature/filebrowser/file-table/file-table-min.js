define("feature/filebrowser/file-table",["jquery","underscore","memoir","util/events","util/ajax","util/dom-event","util/navbuilder","model/page-state","model/path","model/revision-reference","exports"],function(D,Q,M,B,K,V,H,J,O,T,S){function A(X,Z,a,W){var Y=a&&a.getParent();if(Y){return F(X,Z,Y,W)}return""}function P(){var W,Y=window.location.href,X=M.state();if(X&&X.prevUrl){W=X.prevUrl}else{W=document.referrer}return R(W,Y)}function R(Y,a){var W,Z,X;if(!(Y&&a)||(typeof Y!=="string")||(typeof a!=="string")){return null}Y=Y.split("?")[0];a=a.split("?")[0];if(Y.length<a.length){return null}a=H.appendSlashToUrl(a);Z=H.currentRepo().build();X=new RegExp(Z.substring(0,Z.lastIndexOf("/"))+"/.*?/");a=H.appendSlashToUrl(Z)+a.split(X)[1];Y=H.appendSlashToUrl(Z)+Y.split(X)[1];W=Y.split(a)[1];if(W&&W.indexOf("/")>=0){W=W.substring(0,W.indexOf("/"))}return W?decodeURIComponent(W):null}function F(X,Y,Z,W){var a=H.project(X).repo(Y).browse().path(Z);if(W&&!W.isDefault()){return a.at(W.getId()).build()}else{return a.build()}}function C(X,W){D(".filebrowser-banner").replaceWith(stash.feature.filebrowser.warnings({isTruncated:W,message:stash_i18n("stash.web.filebrowser.toomanyfiles","There are too many files in this directory. Only showing the first {0}.",""+X)}))}function L(Y,W){var X=this;this.currentPath=Y;this.currentRevisionRef=W;B.on("memoir.changestate",function(a){var Z=a.state;if(!Z||(Z.path===X.currentPath.toString()&&Z.revisionRef.revisionName===X.currentRevisionRef.getId())){}else{if(!Z.children&&!Z.errors){X.requestData(J.getProject().getKey(),J.getRepository().getSlug(),new O(Z.path),new T(Z.revisionRef),{popState:true}).done(function(b){X.dataReceived(D.extend(Z,b))}).fail(function(d,e,c,b){X.dataReceived(D.extend(Z,b))})}else{X.dataReceived(Z)}}});M.initialState({path:Y.toString(),revisionRef:W.toJSON()});B.on("stash.page.*.revisionRefChanged",function(Z){if(X.currentRevisionRef.getId()!==Z.getId()){X.requestData(J.getProject().getKey(),J.getRepository().getSlug(),X.currentPath,Z)}});B.on("stash.page.*.urlChanged",function(Z){X.requestDataAtUrl(Z)})}function U(W){W.revisionRef=new T(W.revisionRef);W.path=new O(W.path);if(!E(W)){W.parent=new O(W.parent);Q.each(W.children.values,function(X){X.name=X.path.name;X.path=O.fromParentAndName(W.path,X.name);X.url=X.url||F(J.getProject().getKey(),J.getRepository().getSlug(),X.path,W.revisionRef)})}}L.prototype.reload=function(){this.requestData(J.getProject().getKey(),J.getRepository().getSlug(),this.currentPath,this.currentRevisionRef)};L.prototype.dataReceived=function(W){U(W);if(W.path){this.currentPath=W.path}if(W.revisionRef&&this.currentRevisionRef.getId()!==W.revisionRef.getId()){this.currentRevisionRef=W.revisionRef;B.trigger("stash.feature.filetable.revisionRefChanged",this,this.currentRevisionRef)}B.trigger("stash.feature.filetable.dataReceived",this,W)};L.prototype.requestData=function(X,Y,a,W,Z){return this.requestDataAtUrl(F(X,Y,a,W),W,Z)};var I=new RegExp("(?:/?([^?#]*))([?][^#]*)?");L.prototype.parsePathUrl=function(X){if(X&&X.length>0){var W=J.getProject().getKey(),Z=J.getRepository().getSlug(),a=H.project(W).repo(Z).browse().build();X=X.substring(X.indexOf(a)+a.length);var Y=X.match(I);if(Y&&Y.length>=2){var b={projectKey:W,repoSlug:Z,path:decodeURIComponent(Y[1])};if(Y.length===3){b.query=Y[2]}return b}}return{}};L.prototype.requestDataAtUrl=function(X,Z,W){var d=this,a=d.parsePathUrl(X),e=new O(a.path),b=a.query?a.query:"",c=H.rest().project(a.projectKey).repo(a.repoSlug).browse().path(e).build()+b;W=W||{};var Y=function(i){if(!W.popState){var h=d.data=D.extend({},i,{revisionRef:(Z||d.currentRevisionRef).toJSON(),projectKey:a.projectKey,repoSlug:a.repoSlug,path:a.path,prevUrl:window.location.href});var f=window.location.href,g=f.substring(window.location.href.indexOf(window.location.pathname));if(g!==X){M.pushState(h,"",X)}else{d.dataReceived(h)}}};B.trigger("stash.feature.filetable.showSpinner",this,true);return K.rest({url:c,statusCode:K.ignore404WithinRepository()}).done(function(f){Y(f)}).fail(function(h,i,g,f){Y(f)})};function G(W){var X=this;this.fileTableSelector=W;this.$spinner=D("<div class='spinner'/>").hide().insertAfter(this.fileTableSelector);if(M.nativeSupport()){D(document).on("click",W+" .folder a",function(Y){if(V.openInSameTab(Y)){B.trigger("stash.feature.filetable.urlChanged",X,D(this).attr("href"));Y.preventDefault()}})}else{D(document).on("click",W+" .folder a",function(Y){B.trigger("stash.feature.filetable.showSpinner",this)})}B.on("stash.feature.filetable.showSpinner",function(){D(".filebrowser-banner").empty();D(X.fileTableSelector).empty();X.$spinner.show().spin("large")});B.on("stash.feature.filetable.dataReceived",function(Z){var Y=P();X.update(Z);B.trigger("stash.feature.filetable.hideSpinner",this);if(E(Z)){return }if(Z.children.size===1&&Z.children.values[0].type===N){var a=D(X.fileTableSelector+" .folder a")[1];if(a.text!==Y){a.click()}}});B.on("stash.feature.filetable.hideSpinner",function(){X.$spinner.spinStop().hide()});this.focusInitialRow()}var N="DIRECTORY";G.prototype.getSortedFiles=function(W){if(!W||W.length===0){return W}return W.sort(function(Y,X){if(Y.type===N^X.type===N){return Y.type===N?-1:1}else{return Y.path.getName().toLowerCase().localeCompare(X.path.getName().toLowerCase())||(Y.path.getName()===X.path.getName()?0:Y.path.getName()<X.path.getName()?-1:1)}})};G.prototype.update=function(Z){if(E(Z)){this.handleError(Z)}else{var Y=Z.children.values,X=!Z.children.isLastPage;if(!X){Y=this.getSortedFiles(Y)}C(Y.length,X);var W=D(stash.feature.filebrowser.fileTable({files:Y,parentDirectoryUrl:A(J.getProject().getKey(),J.getRepository().getSlug(),Z.path,Z.revisionRef)}));D(this.fileTableSelector).replaceWith(W);this.focusInitialRow()}B.trigger("stash.feature.filetable.pathChanged",this,Z.path)};G.prototype.handleError=function(Y){var W=Y&&Y.errors&&Y.errors.length?Y.errors[0].message:stash_i18n("stash.web.ajax.unexpected.error","An unexpected error occurred.");var X=stash.feature.filebrowser.fileTable({files:[],isError:true,errorMessage:W});D(this.fileTableSelector).replaceWith(D(X))};G.prototype.getParentDirSelector=function(){return this.fileTableSelector+" tr.browse-up a"};G.prototype.focusInitialRow=function(){var X=D(this.fileTableSelector).find("tr.file-row").not(".browse-up"),Y,W=P();if(W){Y=X.filter(function(){return D(this).text()===W})}if(Y&&Y.length){Y.addClass("focused-file")}else{if(X.first().length){X.first().addClass("focused-file")}}};var E=function(W){return !(W&&W.children)};S.FileTableView=G;S.FileTable=L;S.getChildPathDifferenceBetweenUrls=R});