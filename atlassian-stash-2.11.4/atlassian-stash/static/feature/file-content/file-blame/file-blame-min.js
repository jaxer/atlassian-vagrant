define("feature/file-content/file-blame",["jquery","underscore","util/events","util/ajax","util/html","util/navbuilder","widget/submit-spinner","widget/loaded-range","model/page-state"],function(E,K,M,J,C,B,F,D,I){function G(O,P,N){return J.rest({url:O,data:{blame:true,noContent:true,start:P,limit:N}})}function H(N){return stash.feature.fileContent.fileBlameEntry({repository:I.getRepository().toJSON(),changeset:E.extend({id:N.commitHash,displayId:N.displayCommitHash},N)})}function A(N){return K.map(N,H).join("")}function L(P,N,T,Q){var R=E(P),U=new F(R,"before"),S=E(stash.feature.fileContent.fileBlame()).prependTo(E(N));this.$blameColumn=S;this.$blameButton=R;this.blameSpinner=U;this.loadedRange=new D();this.pendingPages=[];this.path=T;this.untilRevision=Q;this._enabled=!!R.attr("aria-pressed")&&R.attr("aria-pressed")==="true";S.toggleClass("expanded",this.isEnabled());var O=this;R.click(function(V){if(O.isButtonEnabled()){O.setEnabled(!O.isEnabled())}V.preventDefault()})}L.prototype.reset=function(){};L.prototype.isEnabled=function(){return this._enabled};L.prototype.setEnabled=function(O){O=!!O;if(this._enabled!==O){var N=this;this._enabled=O;this.$blameButton.attr("aria-pressed",N.isEnabled());N.$blameColumn.toggleClass("expanded",N.isEnabled());if(this.isEnabled()){this.loadPendingPages()}M.trigger("stash.feature.fileblame.enabledStateChanged",this,this.isEnabled())}};L.prototype.setButtonEnabled=function(N){this.$blameButton.attr("aria-disabled",!N)};L.prototype.isButtonEnabled=function(){return !this.$blameButton.attr("aria-disabled")||this.$blameButton.attr("aria-disabled")!=="true"};L.prototype.loadPendingPages=function(){if(this.pendingPages.length){this.setButtonEnabled(false);this.blameSpinner.show();var Q=K.min(this.pendingPages,function(S){return S.start}),N=K.max(this.pendingPages,function(S){return S.start+S.limit});this.pendingPages=[];var O=this,R=Q.start,P=N.start+N.limit-Q.start;return this.requestData(R,P).done(function(S){O.onDataLoaded(R,P,{start:R,size:P,isLastPage:N.isLastPage,blame:S})}).always(function(){O.setButtonEnabled(true);O.blameSpinner.hide()})}return E.Deferred().reject()};L.prototype.requestData=function(O,N){return G(B.currentRepo().browse().path(this.path).at(this.untilRevision.getId()).build(),O,N)};L.prototype.onDataLoaded=function(Q,N,P){if(this.isEnabled()){var O=this.loadedRange.getAttachmentMethod(Q,P.size);C.quickNDirtyAttach(this.$blameColumn[0],A(P.blame),O);this.loadedRange.add(Q,P.size,P.isLastPage)}else{this.pendingPages.push({start:Q,limit:P.size,isLastPage:P.isLastPage||false})}};return L});