define("feature/file-content/ediff/ediff-markers",["bacon","jquery","underscore","util/bacon","util/function","feature/file-content/ediff","feature/file-content/diff-view-segment-types"],function(G,B,Q,P,E,M,F){var A=B.browser.msie&&parseInt(B.browser.version,10)<9;var J=750;function H(S){return Q.pluck(S.lines,"line").join("\n")}function I(S,T){return((S.length<J)&&(T.length<J))}function C(T,U){if(A){return }var S=G.fromBinder(function(V){U.eachLine(V).done(function(){V(new G.End())});return B.noop});R(S).onValue(function(V){T.markText(V.line,V.from,V.to,V.options)})}function R(S){function T(U){return U[0].segment}return P.split(S,E.dot("segment")).slidingWindow(2,2).filter(E.spread(function(V,U){return T(V).type===F.REMOVED&&T(U).type===F.ADDED})).flatMap(E.spread(function(W,U){function V(Y,Z){return G.fromArray(Z).map(function(a){return Q.extend({},a,{line:Y[a.line]})})}var X=D(T(W),T(U));return V(W,X.from).merge(V(U,X.to))}))}function D(Y,V){function X(a){var Z=H(a);return{text:Z,tokens:M.tokenizeString(Z)}}var S=X(V);var U=X(Y);if(!I(S.tokens,U.tokens)){return{to:[],from:[]}}function T(a,Z){return Q.map(a,Q.partial(O,Z.text))}var W=M.diff(U.tokens,S.tokens);return{from:T(W.originalRegions,U),to:T(W.revisedRegions,S)}}function O(T,b){var X=T.slice(0,b.start);var U=T.slice(b.start,b.end);var Y=X.lastIndexOf("\n")+1;var V=U.lastIndexOf("\n")+1;var a=V?V+b.start:Y;var W=b.start-Y;var S=b.end-a;var c=X.split("\n").length-1;var Z=U.split("\n").length-1;return{line:c,from:{lineOffset:0,ch:W},to:{lineOffset:Z,ch:S},options:{className:"ediff-"+b.type}}}var L;function K(S){L=Q.partial(C,S.diffView);S.diffView.on("change",L);return{destroy:Q.partial(N,S.diffView)}}function N(S){S.off("change",L)}return{init:K,_convertLinesToMarkers:R}});