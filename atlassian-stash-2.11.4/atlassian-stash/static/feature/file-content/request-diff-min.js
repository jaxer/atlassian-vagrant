define("feature/file-content/request-diff",["jquery","util/ajax","util/navbuilder","feature/file-content/diff-view-options"],function(E,D,B,H){var A={};var F=-1;function G(I,J){if(E.isArray(J.diffs)&&J.diffs.length){J=_.find(J.diffs,function(K){if(K.destination){return K.destination.toString===I.getPath().toString()}else{if(I.getSrcPath()){return K.source.toString===I.getSrcPath().toString()}}return false})||J.diffs[0]}return J}function C(L,Q){if(L.getDiff()){return E.Deferred().resolve(E.extend({lineComments:Q.lineComments||[],fileComments:Q.fileComments||[]},L.getDiff()))}Q=Q||{};var M=Q.hasOwnProperty("ignoreWhitespace")?Q.ignoreWhitespace:H.get("ignoreWhitespace");var K=isNaN(Number(Q.contextLines))?F:Math.floor(Q.contextLines);var I=L.getCommitRange().getPullRequest();var O=B.rest().project(L.getRepository().getProject().getKey()).repo(L.getRepository().getSlug());O=I?O.pullRequest(I.getId()):O.changeset(L.getCommitRange());var J=O.diff(L).withParams({avatarSize:stash.widget.avatarSizeInPx({size:Q.avatarSize||"medium"}),markup:true,whitespace:M?"ignore-all":"",contextLines:K,withComments:Q.withComments}).build();if(A.hasOwnProperty(J)&&A[J].state()!=="rejected"){return A[J]}var P=D.rest({url:J,statusCode:Q.statusCode||D.ignore404WithinRepository()});var N=P.then(function(R){if(R.errors&&R.errors.length){return E.Deferred().rejectWith(this,[this,null,null,R])}else{R=G(L,R)}setTimeout(function(){delete A[J]});return R});A[J]=N.promise(P);return A[J]}return C});