define("feature/file-content/image-differ",["jquery","util/deprecation","util/events"],function(G,F,D){function H(I){this._$container=I}H.modes={TWO_UP:"two-up",BLEND:"blend",SPLIT:"split"};Object.freeze&&Object.freeze(H.modes);H.prototype.init=function(){var J=this;var L;var I;var K=this._$imgs=this._$container.find("img");this._$sinceImg=K.eq(0);this._$untilImg=K.eq(1);this._$untilRevision=this._$untilImg.parent();this._$sinceRevision=this._$sinceImg.parent();this._$revisions=this._$untilRevision.add(this._$sinceRevision);this._$untilRevisionLabel=J._$untilRevision.find("h5");this._$sinceRevisionLabel=J._$sinceRevision.find("h5");J.setMode(H.modes.TWO_UP);var M=G.Deferred();K.imagesLoaded().always(function(){var N=B(J._$sinceImg).done(function(P){L=P});var O=B(J._$untilImg).done(function(P){I=P});G.when(N,O).done(function(){var Q=(L.width===I.width)&&(L.height===I.height);var P=Q&&L.width>0;M.resolve(P)}).fail(function(){M.reject()})});return M};H.prototype.destroy=function(){this._cleanOldMode(this._mode);this._mode=null};H.prototype.setMode=function(I){if(this._mode!==I){this._onDiffModeChanged(I,this._mode);this._mode=I}};function A(J,I){J.onchange=I;J.oninput=I}function C(I){I.onchange=null;I.oninput=null}function B(J){if(J.data("natural-size")){return G.Deferred().resolve(J.data("natural-size"))}if(J[0].naturalWidth){var I={width:J[0].naturalWidth,height:J[0].naturalHeight};J.data("natural-size",I);return G.Deferred().resolve(I)}var L=new Image(),N=G.Deferred(),K=false,M=function(){if(!K){var O={width:L.width,height:L.height};J.data("natural-size",O);N.resolve(O);K=true}};L.onload=M;L.src=J[0].src;if(L.complete){M()}return N}H.prototype._cleanOldMode=function(I){switch(I){case H.modes.TWO_UP:this._cleanTwoUpDiff();break;case H.modes.BLEND:this._cleanBlendDiff();break;case H.modes.SPLIT:this._cleanSplitDiff();break}};H.prototype._onDiffModeChanged=function(J,I){this._$container.removeClass("two-up blend split").addClass(J);this._cleanOldMode(I);switch(J){case H.modes.TWO_UP:this._setupTwoUpDiff();break;case H.modes.BLEND:this._setupBlendDiff();break;case H.modes.SPLIT:this._setupSplitDiff();break}F.triggerDeprecated("stash.feature.fileContent.diffView.imageDiffModeChanged",this,J,I,"stash.feature.fileContent.imageDiffer.modeChanged","2.10","3.0");D.trigger("stash.feature.fileContent.imageDiffer.modeChanged",null,J,I)};H.prototype._cleanTwoUpDiff=G.noop;H.prototype._setupTwoUpDiff=G.noop;H.prototype._cleanBlendDiff=function(){var I=this._$container.children(".opacity-slider-container");var J=I.find("input");I.remove();this._$untilImg.css("opacity","");C(J[0])};H.prototype._setupBlendDiff=function(){var I=this;var J=G('<input type="range" min="0" max="1" step="0.01" value="1" />');this._$container.children(".image-diff-toolbar").after(G('<div class="opacity-slider-container" />').append(J));fdSlider.onDomReady();A(J[0],function(){I._$untilImg.css("opacity",parseFloat(G(this).val()))})};H.prototype._cleanSplitDiff=function(){this._$imgs.css("width","").css("height","");this._$revisions.css("width","");this._$untilRevision.css("margin-left","");this._$untilRevisionLabel.add(this._$sinceRevisionLabel).css("margin-left","").css("margin-right","");this._$untilImg.unwrap();this._$untilRevisionImageContainer.remove();delete this._$untilRevisionImageContainer;this._$revisions.unwrap();this._$splitContainer.remove();delete this._$splitContainer;if(this._onResize){D.off("window.resize.debounced",this._onResize);delete this._onResize}};function E(I,J){var K=I.data("margin_border_padding");if(K==null){K=I.outerWidth(true)-I.width();I.data("margin_border_padding",K)}return J-K}H.prototype._setSplitDiffElementProperties=function(Q,K,I){var M=E(this._$container,this._$container.parent().width());var J=E(K,M);var L=E(this._$sinceRevision,J);var O=E(this._$sinceImg,L);var N=Math.min(I.width,O);this._$imgs.width(N);this._$imgs.height(Math.floor((N/I.width)*I.height));Q.height(this._$imgs.outerHeight(true));var P=N+(L-O);this._$revisions.width(P);this._$untilRevision.css("margin-left",-P)};H.prototype._setupSplitDiff=function(){var I=this;return B(this._$imgs).done(function(K){I._$untilImg.wrap('<div class="image-container" />');I._$revisions.wrapAll('<div class="split-container" />');I._$untilRevisionImageContainer=I._$untilImg.parent();I._$splitContainer=I._$container.find(".split-container");var J;I._onResize=function(){I._setSplitDiffElementProperties(I._$untilRevisionImageContainer,I._$splitContainer,K);J=I._$sinceImg.outerWidth(true)};I._onResize();D.on("window.resize.debounced",I._onResize);if(K.width<50){I._$untilRevisionLabel.css("margin-left","-50px");I._$sinceRevisionLabel.css("margin-right","-50px")}else{if(K.width<100){I._$untilRevisionLabel.css("margin-left",-K.width);I._$sinceRevisionLabel.css("margin-right",-K.width)}}var L;I._$splitContainer.on("mouseenter",function(){L=I._$untilRevision.offset();I._$revisions.on("mousemove",M)});I._$splitContainer.on("mouseleave",function(){I._$revisions.off("mousemove",M)});var M=function(N){I._$untilRevisionImageContainer.css("width",Math.min(N.pageX-L.left,J))}})};return H});