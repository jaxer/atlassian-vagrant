define("feature/file-content/diff-handler",["jquery","util/ajax","util/navbuilder","util/promise","model/file-change","model/file-change-types","model/file-content-modes","feature/comments","feature/file-content/binary-view","feature/file-content/diff-message","feature/file-content/request-diff","feature/file-content/diff-handler/diff-handler-internal","feature/file-content/diff-view-options","feature/file-content/binary-diff-view","feature/file-content/side-by-side-diff-view","feature/file-content/unified-diff-view","exports"],function(F,L,P,Q,J,M,D,H,E,O,I,B,N,A,K,G,S){function R(U,W,V){var X=U.$container;var T=new J(U.fileChange);if(U.commentMode!==H.commentMode.NONE){var Y=V?_.groupBy(V.values,function(Z){return Z.anchor.line?"line":"file"}):{line:W.lineComments||[],file:W.fileComments||[]};return H.bindContext(X,new H.DiffAnchor(T),{lineComments:Y.line,fileComments:Y.file,commentMode:U.commentMode,relevantContextLines:U.relevantContextLines})}return null}function C(W,X,V,a){var Z=W.$container;var T=new J(W.fileChange);if(E.shouldRenderBinary(X)){return new A(X,W)}if(!X||!X.hunks||!X.hunks.length){O.renderEmptyDiff(Z,X,T);return{extraClasses:"empty-diff message-content"}}if(X.hunks[X.hunks.length-1].truncated){O.renderTooLargeDiff(Z,X,T,a);return{extraClasses:"too-large-diff message-content"}}var U=a?K:G;var Y=new U(X,F.extend({commentContext:V},W));if(V){V.setDiffView(Y)}Y.init();return Y}S.handler=function(X){var f=10;var b=10000;var d=X.contentMode===D.DIFF;var h=X.$container;var T=F('.diff-type-options .aui-dropdown2-radio[data-value="side-by-side"]');var U=new J(X.fileChange);var a=U.getType();var V=!(a===M.ADD||a===M.DELETE||X.isExcerpt);var g=!(F.browser.msie&&parseInt(F.browser.version,10)<9);function c(){return N.get("diffType")==="side-by-side"&&g&&V}X.withComments=X.commentMode!==H.commentMode.NONE;if(c()){X.contextLines=b;X.withComments=false}function Z(o){var m=new J(o.fileChange);var p=m.getRepository();var l=m.getCommitRange();var n=P.rest().project(p.getProject().getKey()).repo(p.getSlug());if(l.getPullRequest()){n=n.pullRequest(l.getPullRequest().getId())}else{n=n.commit(l)}var q=n.comments().withParams({avatarSize:stash.widget.avatarSizeInPx({size:o.avatarSize||"medium"}),path:o.fileChange.path.toString(),markup:true}).build();var r=L.rest({url:q,statusCode:o.statusCode||L.ignore404WithinRepository()});var s=r.then(function(t){if(t.errors&&t.errors.length){return F.Deferred().rejectWith(this,[this,null,null,t])}return t});return s.promise(r)}var e=c()?Z:F.noop;var Y=_.compact([I(U,X),e(X)]);var W=Q.whenAbortable.apply(Q,Y);function k(){if(g&&V){T.removeClass("disabled");return }if(!g){T.tooltip({gravity:"e",delayIn:0,title:"data-ie8-compatibility"})}else{if(!V){T.tooltip({gravity:"e",delayIn:0,title:"data-file-type-compatibility"})}}}function i(o,m){V=a?V:!B.isAddedOrRemoved(o);k();X.relevantContextLines=X.relevantContextLines||f;if(U.getConflict()){O.renderConflict(h,U)}var l=R(X,o,m);var n=C(X,o,l,c());return{extraClasses:n&&n.extraClasses,destroy:function(){if(l){l.destroy()}if(n&&n.destroy){n.destroy()}}}}function j(n,o,m,l){if(m==="abort"){return F.Deferred().resolve()}O.renderErrors(h,l);return F.Deferred().resolve({extraClasses:"diff-error message-content"})}return d&&W.thenAbortable(i,j)}});require("feature/file-content/diff-view-options-panel").init();require("stash/api/feature/files/file-handlers").register({weight:5000,handle:function(A){return require("feature/file-content/diff-handler").handler.apply(this,arguments)}});