define("feature/file-content/unified-diff-view",["jquery","underscore","util/deprecation","util/events","util/function","feature/comments","feature/file-content/diff-view","feature/file-content/diff-view-context","feature/file-content/diff-view-segment-types","feature/file-content/line-handle","feature/file-content/diff-view-file-types"],function(E,O,K,Q,N,J,B,G,D,C,I){function P(R){var T=R.destinationLine;var S=R.sourceLine;R.segments[0].lines=O.map(R.segments[0].lines,function(U,V){U.destination=T++;U.source=S++;return U});return R}function F(X,Y){if(!Y.linesAdded){return }var V=Y.diff;var T=G.getSeparatedHunkHtml(V.hunks,X.options.fileChange.getType());var S;var R=[];var U;var W;Y.eachLine(function(a){var Z=a.handles.FROM||a.handles.TO;if(a.hunk!==W){W=a.hunk;R.push(Z)}U=Z}).done(function(){switch(Y.type){case"INSERT":var d=R[0];var Z=X._editor.getLineNumber(d._handle);var a=Z===0;var b=X._editor.lastLine()-Y.linesAdded;var c=Z>b;if(V.hunks.length>1){R.shift();T.shift();T.pop();U=undefined}else{if(!a){R.shift();T.shift()}if(!c){T.pop();U=undefined}else{S=T.pop()}}break;case"INITIAL":if(R.length===T.length-1){S=T.pop()}break;default:throw new Error("Unrecognized change type: "+Y.type)}O.each(O.zip(T,R),N.spread(O.partial(M,X,!!"isAbove")));if(S){M(X,!"isAbove",S,U)}})}function M(W,S,R,V){if(!R){return }var T=E(R);var U=W.addLineWidget(V,T[0],{coverGutter:true,noHScroll:true,above:S});if(S){W.addLineClass(V,"wrap","first-line-of-hunk")}T.data("widget",U)}function L(R){R&&R.clear()}function H(V,Z,T){var S=V._editor.lastLine()===T;var R=0===T;var X=S?0:-1;var W="";var Y="";var U=0;V._editor.options.wholeLineUpdateBefore=R;if(R){Y="\n"}else{W="\n";U=V._editor.getLine(S?T:T+X).length}V._editor.getDoc().replaceRange(W+Z+Y,{line:T+X,ch:U});return S?T+1:T}function A(S,R){B.apply(this,arguments)}O.extend(A.prototype,B.prototype);A.prototype.init=function(){this.$container.addClass("unified-diff");K.triggerDeprecated("stash.feature.diffview.dataLoaded",null,0,10000,this.data,"stash.feature.fileContent.diffViewDataLoaded","2.10","3.0");this.on("change",O.partial(F,this));G.attachExpandContext(this.$container,this.options.fileChange,O.bind(this._expandContextLines,this));this.$container.append(stash.feature.fileContent.unifiedDiffView.layout());this._editor=this._createEditor({gutters:O.filter([this.options.commentContext&&this.options.commentContext.getGutterId(),"line-number-from","line-number-to"],O.identity)},this.$container.children(".diff-editor"));B.prototype.init.call(this);O.defer(O.bind(this._attachScrollBehavior,this))};A.prototype.destroy=function(){if(this._boundEvents){this._boundEvents.destroy();this._boundEvents=null}J.unbindContext(this.$container);this._editor=null;B.prototype.destroy.call(this)};A.prototype.setGutterMarker=function(R,T,S){this._editor.setGutterMarker(R._handle,T,S);return R};A.prototype.addLineClass=function(R,S,T){this._editor.addLineClass(R._handle,S,T);return R};A.prototype.removeLineClass=function(R,S,T){this._editor.removeLineClass(R._handle,S,T);return R};A.prototype.getLine=function(R){return R._handle.text};A.prototype.operation=function(R){return this._editor.operation(R)};A.prototype.refresh=function(){this._editor.refresh();this.trigger("resize")};A.prototype._acceptModification=function(V,T,S,R){var U=this;R=R||0;switch(S){case"INITIAL":this._editor.setValue(B._combineTexts(T));break;case"INSERT":R=H(this,B._combineTexts(T),R);break;default:throw new Error("Unrecognized change type: "+S)}O.each(T,function(W,X){var Y=new C(undefined,W.line.lineType,W.line.lineNumber,U._editor.getLineHandle(X+R));if(W.line.lineType!==D.ADDED){W._setHandle(I.FROM,Y)}if(W.line.lineType!==D.REMOVED){W._setHandle(I.TO,Y)}})};A.prototype._attachScrollBehavior=function(){var S=this;var T=this._editor;if(!T){return }var R=false;var U=this.$container.children(".diff-editor");this._requestWindowScrolls({scrollSizing:function(){return T.getScrollInfo()},scroll:function(V,W){R=true;T.scrollTo(null,W)},resize:function(W,V){U.height(V);S.refresh()},onSizeChange:function(V){S.on("resize",V)},onInternalScroll:function(V){T.on("scroll",function(){if(R){R=false;return }var W=T.getScrollInfo();V(W.left,W.top)})}})};A.prototype._editorForHandle=function(){return this._editor};A.prototype._expandContextLines=function(R,S,V){if(!this._editor){return }var U=this.getLineHandle(S);var T=this._editor.getLineNumber(U._handle);this.removeLineClass(U,"wrap","first-line-of-hunk");O.forEach(V,function(W,X){W.sourceSpan=W.destinationSpan=W.segments[0].lines.length;P(W)});if(V.length&&V[0].segments.length&&V[0].segments[0].lines.length){this._modifyDiff({hunks:V},"INSERT",T)}L(S.data("widget"));K.triggerDeprecated("stash.feature.diff-view.expanded",S,{},"stash.feature.fileContent.diffViewExpanded","2.10","3.0");Q.trigger("stash.feature.fileContent.diffViewExpanded",null,{$context:S,hunk:V,at:T})};return A});