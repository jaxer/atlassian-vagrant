define("feature/file-content/diff-view-context/diff-view-context-internal",["jquery","underscore","util/function","model/file-change-types","feature/file-content/diff-view-segment-types","exports"],function(E,I,H,B,A,D){var C={destinationLine:1,destinationSpan:0,sourceLine:1,sourceSpan:0};var G=H.eq(A.ADDED);D.isAdded=G;D.getSeparatedHunkHtml=function(R,N,L){function M(S){switch(S){case B.ADD:return A.ADDED;case B.DELETE:return A.REMOVED;default:return A.CONTEXT}}var K=M(N);var O=G(K);function Q(S){return{line:O?S.destinationLine:S.sourceLine,span:O?S.destinationSpan:S.sourceSpan}}function P(S){return(S.sourceLine+S.sourceSpan)-(S.destinationLine+S.destinationSpan)}return I.map(I.zip([C].concat(R),R.concat({})),function(V){var U=Q(V[0]);var Z=Q(V[1]);var S=Z.line>1;var T=U.span>0;var W=U.line+U.span;var X=Z.line-1;var Y=O?0:P(V[0]);return L(W,X,Y,K,S,T)})};D.fetchContext=function F(R,Q,P,K,N){var L=!isNaN(Q)?Q-R+1:N.maxLimit;function O(T,U,S){return T&&I.extend({},T,{lines:S==null?T.lines.slice(U):T.lines.slice(U,S)})}var M=function(S){return E.when(R===0?null:S(R,K+(!Q?1:0)),!Q?null:S(R+L-K,K)).then(function(U,T){if(!T){var V=U.lines.length>K;return{startSep:U.start+U.lines.length+(V?-1:0),contexts:V?[O(U,0,-1),null]:[U]}}else{if(!U){return{startSep:0,endSep:T.start,contexts:[null,T]}}else{return{startSep:U.start+K,endSep:T.start,contexts:[U,T]}}}})};if(L<N.maxLimit){return P(R,L).then(function(S){if(L<=K*2){return E.Deferred().resolve({startSep:0,endSep:0,contexts:[S]})}else{return M(function(T){return E.Deferred().resolve({start:T,lines:S.lines})}).then(function(T){return I.extend({},T,{contexts:[O(T.contexts[0],0,K),O(T.contexts[1],-K)]})})}})}else{return M(P)}};D.toHunks=function J(N,K){function L(O){return O+1}return function M(O){var Q=[];I.each(O.contexts,function P(R){if(R){Q.push({segments:[{type:K,lines:I.map(R.lines,function(S){return{line:S.text}})}],sourceLine:L(R.start),destinationLine:L(R.start)-N,isLastPage:R.isLastPage})}});return Q.length?Q:""}}});