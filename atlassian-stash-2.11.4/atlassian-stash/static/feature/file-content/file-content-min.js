define("feature/file-content",["jquery","underscore","memoir","require","util/deprecation","util/dom-event","util/events","util/promise","util/navbuilder","feature/comments","stash/api/feature/files/file-handlers","model/file-change-types","model/file-content-modes","model/content-tree-node-types"],function(C,N,M,B,I,O,P,Q,D,H,L,G,J,F){function A(T,R){var S=D.currentRepo().browse().path(T);if(R&&!R.isDefault()){S=S.at(R.getId())}return S.raw().build()}function K(R,T){var S=this;this._id=T||undefined;this._containerSelector=R;P.on("stash.feature.filehistory.revisionSelected",function(U){if(this===S.untilRevisionPicker){P.trigger("stash.feature.filecontent.untilRevisionChanged",S,U)}});this._lastInitPromise=Q.thenAbortable(C.Deferred().resolve())}K.contentType=C.extend({},J);I.obj(K.contentType,"FileContent.contentType.","require('model/file-content-modes')::","2.8","3.0");K.commentMode=H.commentMode;K.diffPreset={contentMode:J.DIFF,untilRevisionPicker:true,rawLink:false,sourceLink:false,modeToggle:true,changeTypeLozenge:false,changeModeLozenge:false,breadcrumbs:false,commentMode:K.commentMode.NONE};K.sourcePreset={contentMode:J.SOURCE,untilRevisionPicker:true,rawLink:true,sourceLink:false,modeToggle:true,changeTypeLozenge:false,changeModeLozenge:false,breadcrumbs:false,commentMode:K.commentMode.NONE};K.defaults={contentMode:J.SOURCE,untilRevisionPicker:false,rawLink:false,sourceLink:false,modeToggle:false,changeTypeLozenge:false,changeModeLozenge:false,fileIcon:false,breadcrumbs:false,scrollPaneSelector:undefined,commentMode:K.commentMode.REPLY_ONLY,pullRequestDiffLink:false,toolbarWebFragmentLocationPrimary:null,toolbarWebFragmentLocationSecondary:null};K.prototype.initToolbarItems=function(T,R){var V=C(this._containerSelector);var S=R.getCommitRange().getUntilRevision();var U=C(stash.feature.fileContent.main(C.extend({id:this._id,preloaded:!!R.getDiff(),sourceUrl:this._options.sourceUrl||this._options.modeToggle?D.currentRepo().browse().path(R.getPath()).at(T.getDisplayId()).until(S&&S.getId()).build():"",diffUrl:this._options.modeToggle?D.currentRepo().diff(R).at(T.getDisplayId()).build():"",fileChange:R.toJSON(),commentMode:this._options.commentMode},this._options)));this.$self&&this.$self.remove();this.$self=U.appendTo(V);this._initCommands();if(this._options.breadcrumbs){this.$breadcrumbs=U.find(".breadcrumbs")}else{this.$breadcrumbs=null}if(this._options.changeTypeLozenge){this.$changeTypeLozenge=U.find(".change-type-placeholder")}else{this.$changeTypeLozenge=null}if(this._options.changeModeLozenge){this.$changeModeLozenge=U.find(".change-mode-placeholder")}else{this.$changeModeLozenge=null}if(this._options.sourceLink){this.$viewSource=U.find(".source-view-link").tooltip({gravity:"ne"})}else{this.$viewSource=null}if(this._options.pullRequestDiffLink){U.find(".pull-request-diff-outdated-lozenge").tooltip({gravity:"ne"})}};K.prototype._initCommands=function(){var R=this.$self.children(".content-view");var S=this.$toolbar=this.$self.children(".file-toolbar");if(this._options.scrollPaneSelector==="self"){R.addClass("scroll-x")}if(this.untilRevisionPicker){this.untilRevisionPicker.destroy()}if(this._options.untilRevisionPicker){var T=B("feature/file-content/file-history");this.untilRevisionPicker=new T(S.find(".until-changeset-button"),"until-changeset")}else{this.untilRevisionPicker=null}if(this._options.rawLink){this.$viewRaw=S.find(".raw-view-link")}else{this.$viewRaw=null}if(this._options.modeToggle){this.$modeToggle=S.find(".mode-toggle").tooltip({gravity:"ne"})}else{this.$modeToggle=null}this.$sourceButton=S.find(".mode-source");this.$diffButton=S.find(".mode-diff");this.$commentButton=S.find(".add-file-comment-trigger");this.$commentButton.on("click",function(){var U=R.data("comment-context");if(U){U.addFileCommentClicked()}}).tooltip({gravity:"ne"})};K.prototype.initForContent=function(X,S,R){var U=S.getCommitRange().getUntilRevision();if(this.$viewSource){if(S.getType()===G.DELETE||S.getNodeType()===F.SUBMODULE){this.$viewSource.addClass("hidden")}else{this.$viewSource.attr("href",D.currentRepo().browse().path(S.getPath()).at(U&&U.getId()).build())}}if(this.$viewRaw){this.$viewRaw.attr("href",A(S.getPath(),U&&U.getRevisionReference()))}if(this.untilRevisionPicker){this.untilRevisionPicker.init(S.getPath(),U&&U.getRevisionReference(),X)}if(this.$breadcrumbs){this.$breadcrumbs.html(this.renderBreadCrumbs(S.getPath()))}if(this.$changeTypeLozenge){var Y=S.getSrcPath();if(S.getType()===G.RENAME){Y=Y.getName()}else{Y="/"+Y.getComponents().join("/<wbr>")}this.$changeTypeLozenge.append(stash.feature.fileContent.fileChangeTypeLozenge({changeType:S.getType(),previousPath:Y}));this.$changeTypeLozenge.find(".change-type-lozenge").tooltip({html:true})}if(this.$changeModeLozenge){var V=this.getFileChangedModeLozenge(S);if(V){this.$changeModeLozenge.append(C(V).tooltip())}}if(this.$modeToggle&&M.nativeSupport()){this.$modeToggle.on("click","a:not(.active,.disabled)",function(Z){if(!O.openInSameTab(Z)){return }Z.preventDefault();P.trigger("stash.feature.filecontent.requestedModeChange",this,C(this).hasClass("mode-diff")?J.DIFF:J.SOURCE)})}var T={fileChange:S.toJSON(),$container:this.$self.children(".content-view"),targetLine:R>0?R-1:null,contentMode:this._options.contentMode,commentMode:this._options.commentMode,lineComments:this._options.lineComments,relevantContextLines:this._options.relevantContextLines,isExcerpt:!!this._options.isExcerpt,enable:N.bind(this.toggleDisable,this,false),disable:N.bind(this.toggleDisable,this,true)};var W=C("<div />").addClass("file-content-spinner").appendTo(this.$self);return Q.spinner(W,L._handle(T).done(N.bind(function(Z){if(Z.extraClasses){this.$self.addClass(Z.extraClasses);this.extraClasses=Z.extraClasses}this.destroyView=N.isFunction(Z.destroy)?N.bind(Z.destroy,Z):C.noop},this)),"large")};K.prototype.toggleDisable=function(R){this.$self.find(".file-toolbar .aui-button").toggleClass("disabled",R).prop("disabled",R);if(R){P.trigger("stash.feature.filecontent.disabled",this,this.$self)}else{P.trigger("stash.feature.filecontent.enabled",this,this.$self)}};K.prototype.renderBreadCrumbs=function(S){var R=N.map(S.getComponents(),function(T){return{text:T}});return stash.widget.breadcrumbs.crumbs({pathComponents:R,primaryLink:this._options.pullRequestDiffLinkUrl})};K.prototype.getFileChangedModeLozenge=function(R){var U=R.getSrcExecutable(),S=R.getExecutable();var T=null;if((U==null&&S===true)||(U===false&&S===true)){T=true}else{if(U===true&&S===false){T=false}}if(T!==null){return C(stash.feature.fileContent.fileChangeModeLozenge({added:T}))}return null};K.prototype.init=function(R,U,V,S){var T=this._initInternal.bind(this,R,U,V,S);this._lastInitPromise=this.reset().thenAbortable(T,T);return this._lastInitPromise};K.prototype._initInternal=function(S,V,W,T){T=this._options=C.extend({},K.defaults,T);var R=S.getCommitRange(),U=V||R.getUntilRevision()&&R.getUntilRevision().getRevisionReference();if(T.changeTypeLozenge&&!S.getType()){throw new Error("Change type is required to show the change type lozenge.")}if(!R.getUntilRevision()&&(T.sourceLink||T.rawLink||T.untilRevisionPicker)){throw new Error("Revision info is required to show a link to the source or raw file, or a revision picker.")}this.initToolbarItems(U,S);return this.initForContent(U,S,W)};K.prototype.reset=function(){if(this._lastInitPromise){this._lastInitPromise.abort()}var R=this._resetInternal.bind(this);return Q.thenAbortable(this._lastInitPromise.then(R,R))};K.prototype._resetInternal=function E(){if(this.extraClasses){this.$self.removeClass(this.extraClasses)}if(N.isFunction(this.destroyView)){this.destroyView()}this.destroyView=null;this.extraClasses=null;return C.Deferred().resolve()};K.prototype.destroy=function(){this.reset()};return K});