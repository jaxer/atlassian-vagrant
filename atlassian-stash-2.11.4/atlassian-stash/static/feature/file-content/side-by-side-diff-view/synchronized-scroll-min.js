define("feature/file-content/side-by-side-diff-view/synchronized-scroll",["jquery","underscore","util/events","util/function","util/math","util/synchronized-scroll","feature/file-content/diff-view-segment-types","exports"],function(E,K,N,H,I,C,A,D){function P(T){var W=null;var S=0;var U=0;var V=0;var R=[];function Q(){if(W){W.end=S;W.from.end=U;W.to.end=V;R.push(W)}}K.forEach(T,function(X){if(!W||X.segment!==W.segment){Q();W={segment:X.segment,lineInfos:[],start:S,end:-1,from:{start:U,end:-1,lineInfos:[]},to:{start:V,end:-1,lineInfos:[]}}}S++;W.lineInfos.push(X);if(X.segment.type!==A.ADDED){U++;W.from.lineInfos.push(X)}if(X.segment.type!==A.REMOVED){V++;W.to.lineInfos.push(X)}});Q();return R}function M(R,Q){this._id=R;this._editor=Q;this._programmatic=false}M.prototype.getScrollInfo=function(){return this._editor.getScrollInfo()};M.prototype.scrollTo=function(Q,R){this._programmatic=this._programmatic||Q!=null||R!=null;this._editor.scrollTo(Q,R)};M.prototype.getAndUnsetProgrammaticScrollMarker=function(){var Q=this._programmatic;this._programmatic=false;return Q};function G(R,U,T,V,S,Q){this._editor=R;this._startIndex=U;this._endIndex=T;this._numLines=T-U;this._id=V;this._seg=S;this._cachedInfo=null;this._lineInfos=Q}G.prototype.getHeight=function(){return this._getCachedInfo().height};G.prototype.getOffsetTop=function(){return this._getCachedInfo().offsetTop-this._editor.getScrollInfo().top};G.prototype._getCachedInfo=function(){if(!this._cachedInfo){this._cachedInfo={height:this._numLines?this._editor.heightAtLine(this._endIndex,"local")-this._editor.heightAtLine(this._startIndex,"local"):0,offsetTop:this._editor.heightAtLine(Math.max(0,this._startIndex),"local")}}return this._cachedInfo};G.prototype._invalidateCache=function(){this._cachedInfo=null};function L(T,S){var Q,U,R;return{_id:"combined_"+K.pluck(T,"_id").join("_"),_setCombinedScrollable:function(V){R=V},getHeight:function(){if(Q==null){Q=T.map(function(V){return V.getHeight()}).reduce(H.binary(Math.max),0)}return Q},_getOffset:function(){if(U==null){U=S()}return U},getOffsetTop:function(){return this._getOffset()-R._getScrollTop()},_invalidateCache:function(){Q=null;U=null}}}function J(X,Q){this._id=X;var S=H.constant(0);Q=E.extend({initialScrollTop:0,getClientHeight:S,getScrollHeight:S},Q);var R=false;var U=Q.initialScrollTop;var W;this._getScrollTop=function T(){return U};function V(Y){U=I.clamp(0,Q.getScrollHeight())(Y)}this._scrollToNative=function(Y,Z){if(Z!=null){V(Z);if(W){W()}}};this._setScrollHandler=function(Y){W=Y};this.getScrollInfo=function(){return{top:U,left:0,height:Q.getScrollHeight(),width:0,clientHeight:Q.getClientHeight(),clientWidth:0}};this.scrollTo=function(Y,Z){if(Z!=null){R=true;V(Z)}};this.getAndUnsetProgrammaticScrollMarker=function(){var Y=R;R=false;return Y}}function O(W,V,S,Z,T){var U=[];var X=[];function h(k,i,m,j,l){return new G(k,i.start,i.end,l+"_"+i.start+"_"+i.end,m,j)}function d(k,l){var j=h(S,k.from,k.segment,k.from.lineInfos,"from");var i=h(Z,l.to,l.segment,l.to.lineInfos,"to");U.push(j);X.push(i)}var g=P(V);var f=K.reduce(g,function(j,i){if(j&&i.segment.type===A.ADDED){d(j,i);return null}if(j){d(j,j)}if(i.segment.type===A.REMOVED){return i}d(i,i);return null},null);if(f){d(f,f)}var e=K.zip(U,X);var a=K.compose(H.partialRight(K.reduce,I.add,0),H.partialRight(K.invoke,"getHeight"),K.take);var Q=T.includeCombinedRegions?K.reduce(e,function(i,j,k){var l=K.partial(a,i,k);i.push(L(j,l));return i},[]):[];var c={};if(Q.length){K.chain(U).zip(X,Q).forEach(H.spread(function(j,i,k){c[j._id]=[i,k];c[i._id]=[j,k];c[k._id]=[j,i]}))}else{K.forEach(e,H.spread(function(j,i){c[j._id]=[i];c[i._id]=[j]}))}function Y(i){return K.invoke.bind(K,i,"_invalidateCache")}S.on("change",Y(U.concat(Q)));Z.on("change",Y(X.concat(Q)));var b=Y(U.concat(X,Q));E(window).on("resize",b);W.on("widgetAdded",b);W.on("widgetChanged",b);W.on("widgetCleared",b);var R=N.chain().on("stash.feature.changeset.difftree.collapseAnimationFinished",b);return{fromRegions:U,toRegions:X,combinedRegions:Q,linkedFromAndToRegions:e,linkedRegionsByRegionId:c,destroy:function(){R.destroy();E(window).off("resize",b)}}}function F(Y,R,U,Q,Z){var X={};X[R._id]=Z.fromRegions;X[U._id]=Z.toRegions;if(Q){X[Q._id]=Z.combinedRegions}var c=K.compose(H.lookup(X),H.dot("_id"));var S=K.compose(H.lookup(Z.linkedRegionsByRegionId),H.dot("_id"));function T(f,e){var d=S(f)||[];return K.find(d,K.compose(H.eq(e._editor),H.dot("_editor")))}function a(d){d.scrollable.scrollTo(d.scrollLeft,d.scrollTop)}function W(d){Y.operation(K.forEach.bind(K,d,a));Y.trigger("sync-scroll")}function b(d,g,e){var h;if(e.includeHorizontal){h=W}else{var f=H.partialRight(K.map,H.unary(H.partialRight(K.omit,"scrollLeft")));h=K.compose(W,f)}return C.getScrollHandler({self:d,others:g,getRegions:c,getLinkedRegion:T,executeCommands:h})}var V={fromHandler:b(R,K.compact([U,Q]),{includeHorizontal:true}),toHandler:b(U,K.compact([R,Q]),{includeHorizontal:true})};if(Q){V.combinedHandler=b(Q,[R,U],{includeHorizontal:false})}return V}function B(X,S,Q,c,d){d=d||{};var W=O(X,S,Q,c,{includeCombinedRegions:d.includeCombinedScrollable});var T=new M("from",Q);var U=new M("to",c);var a=0;var R;if(d.includeCombinedScrollable){R=new J("combined",{getScrollHeight:function Z(){return K.chain(W.combinedRegions).invoke("getHeight").reduce(I.add,0).value()},getClientHeight:function b(){return a}})}var V=F(X,T,U,R,W);Q.on("scroll",V.fromHandler);c.on("scroll",V.toHandler);var Y={linkedFromAndToRegions:W.linkedFromAndToRegions,destroy:function(){Q.off("scroll",V.fromHandler);c.off("scroll",V.toHandler);W.destroy()}};if(R){R._setScrollHandler(V.combinedHandler);R.setClientHeight=function(e){a=e};K.invoke(W.combinedRegions,"_setCombinedScrollable",R);Y.combinedScrollable=R}return Y}D.setupScrolling=B});