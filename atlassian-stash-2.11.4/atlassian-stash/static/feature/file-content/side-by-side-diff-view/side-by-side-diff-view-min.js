define("feature/file-content/side-by-side-diff-view",["jquery","underscore","util/function","util/performance","util/svg","feature/comments","feature/file-content/diff-view","feature/file-content/diff-view-segment-types","feature/file-content/determine-language","feature/file-content/line-handle","feature/file-content/side-by-side-diff-view/synchronized-scroll","feature/file-content/diff-view-file-types"],function(G,Q,O,N,H,K,B,E,L,D,M,J){function P(S,R){B.apply(this,arguments)}Q.extend(P.prototype,B.prototype);P.prototype.init=function(){this.$container.addClass("side-by-side-diff");var S=this.options.fileChange.getPath().toString();var R=this._data.hunks[0].segments[0].lines[0].line;var T=L.fromFileInfo({firstLine:R,path:S,legacy:false});this.$container.append(stash.feature.fileContent.sideBySideDiffView.layout());this._fromEditor=this._createEditor({gutters:Q.filter([this.options.commentContext&&this.options.commentContext.getGutterId(),"line-number-from"],Q.identity)},this.$container.find(".side-by-side-diff-editor-from"));this._toEditor=this._createEditor({gutters:Q.filter([this.options.commentContext&&this.options.commentContext.getGutterId(),"line-number-to"],Q.identity)},this.$container.find(".side-by-side-diff-editor-to"));B.prototype.init.call(this)};P.prototype.setEditorMode=function(R){if(this._fromEditor&&this._toEditor){this._fromEditor.setOption("mode",R);this._toEditor.setOption("mode",R)}};P.prototype.destroy=function(){if(this._detachScrollingBehavior){this._detachScrollingBehavior();this._detachScrollingBehavior=null}K.unbindContext(this.$container);B.prototype.destroy.call(this);this._fromEditor=null;this._toEditor=null};P.prototype.setGutterMarker=function(R,T,S){this._editorForHandle(R).setGutterMarker(R._handle,T,S);return R};P.prototype.addLineClass=function(R,S,T){this._editorForHandle(R).addLineClass(R._handle,S,T);return R};P.prototype.removeLineClass=function(R,S,T){this._editorForHandle(R).removeLineClass(R._handle,S,T);return R};P.prototype.getLine=function(R){return R._handle.text};P.prototype.operation=function(S){var R=this;return this._fromEditor.operation(function(){return R._toEditor.operation(S)})};P.prototype.refresh=function(){this._fromEditor.refresh();this._toEditor.refresh();this.trigger("resize")};P.prototype._acceptModification=function(X,U,S){if(S!=="INITIAL"){throw new Error("Unrecognized change type: "+S)}var T=Q.filter(U,function(Y){return Y.line.lineType!==E.ADDED});var V=Q.filter(U,function(Y){return Y.line.lineType!==E.REMOVED});this._fromEditor.setValue(B._combineTexts(T));this._toEditor.setValue(B._combineTexts(V));Q.defer(Q.bind(this._attachScrollBehavior,this,U));function W(Z,Y){return Z.segment!==Y.segment&&Z.line.lineType===E.CONTEXT&&Y.line.lineType===E.CONTEXT}function R(Y,Z,a){var b;Q.forEach(Y,function(c,d){var e=Z.getLineHandle(d);c._setHandle(a,new D(a,c.line.lineType,c.line.lineNumber,e));if(b&&W(b,c)){Z.addLineClass(e,"wrap","paired-with-change")}b=c})}R(T,this._fromEditor,J.FROM);R(V,this._toEditor,J.TO)};var I={};I[J.FROM]="_fromEditor";I[J.TO]="_toEditor";P.prototype._editorForHandle=function(R){return this[I[R.fileType]]};P.prototype._attachScrollBehavior=function(U){var R=this;var W=this._fromEditor;var V=this._toEditor;if(!W){return }var T=M.setupScrolling(this,U,W,V,{includeCombinedScrollable:true});var S=R.$container.children(".diff-editor, .segment-connector-column");this._requestWindowScrolls({scrollSizing:function(){return T.combinedScrollable.getScrollInfo()},scroll:function(X,Y){if(Y!=null){T.combinedScrollable._scrollToNative(null,Y)}},resize:function(Y,X){T.combinedScrollable.setClientHeight(X);S.height(X);R.refresh()},onSizeChange:function(X){R.on("resize",X)},onInternalScroll:function(X){var Y=T.combinedScrollable.scrollTo;T.combinedScrollable.scrollTo=function(Z,a){Y.apply(this,arguments);X(null,a)}}}).then(function(){R.refresh()});this._initSegmentLinking(T.linkedFromAndToRegions);F(T.linkedFromAndToRegions);this._detachScrollingBehavior=function(){T.destroy()}};P.prototype._initSegmentLinking=function(U){var W=G(".segment-connector-column");var V=H.createElement("svg",{});W.append(V);var R=C.bind(null,U,V,this._getLineClasses);var S=N.enqueueCapped(requestAnimationFrame,function S(){V.setAttribute("height",W.height());V.setAttribute("width",W.width());R()});var T=N.enqueueCapped(requestAnimationFrame,R);this.on("sync-scroll",R);this.on("widgetAdded",T);this.on("widgetChanged",T);this.on("widgetCleared",T);this.on("resize",S);S()};function A(R){return R._seg&&R._seg.type!==E.CONTEXT&&R._numLines>0}function F(T){var S=Q.chain(T).find(function(V){return Q.some(V,A)}).find(A).value();if(S){var U=S._editor.getScrollInfo().clientHeight*0.45;var R=S.getOffsetTop()-U;if(R>0){S._editor.scrollTo(0,R)}}}function C(e,j,f){var k;var c=j.offsetHeight||parseFloat((k=window.getComputedStyle(j)).height,10);var h=j.offsetWidth||parseFloat(k.width,10);var b=h+1;var a=h*0.4;var X=h*0.6;var U=e.filter(function(l){return l.some(A)});var d=U.map(function Z(l){return l.map(function(n){var o=n.getOffsetTop();var m=o+n.getHeight();return{region:n,top:o+0.5,bottom:m+0.5,above:o<0,inside:m>0&&o<c,below:m>c}})}).filter(function i(l){return l.some(O.dot("inside"))||(l.some(O.dot("above"))&&l.some(O.dot("below")))});function V(l,m){return new H.PathBuilder().moveTo(-1,l.top).curve(a,l.top,X,m.top,b,m.top).lineTo(b,m.bottom).curve(X,m.bottom,a,l.bottom,-1,l.bottom).close().build()}function T(p,r){var q=p.region._lineInfos[0];var o=r.region._lineInfos[0];var m=q&&q.line||{conflictMarker:null,lineType:o.line.lineType};var n=o&&o.line||{conflictMarker:null,lineType:q.line.lineType};var l=f(m.lineType,m.conflictMarker,false)+" "+f(n.lineType,n.conflictMarker,false);return Q.chain(l.split(/\s+/)).unique().without("line").value().join(" ")}var W=d.map(O.spread(function(l,m){return{path:V(l,m),extraClasses:T(l,m)}}));while(j.hasChildNodes()){j.removeChild(j.firstChild)}var g=function(l){return(l.indexOf("added")!==-1)&&(l.indexOf("removed")!==-1)};var S=Q.once(function(m){var l=[{"class":"removed",offset:"0%"},{"class":"removed",offset:"30%"},{"class":"added",offset:"70%"},{"class":"added",offset:"100%"}];l=Q.map(l,H.createElement.bind(H,"stop"));return Q.reduce(l,function(o,n){o.appendChild(n);return o},H.createElement("linearGradient",{id:m}))});var Y="added-and-removed-svg-gradient";var R=W.map(function(m){var l={"class":"segment-connector "+m.extraClasses,d:m.path};if(g(m.extraClasses)){Q.extend(l,{fill:"url(#"+Y+")"})}return H.createElement("path",l)}).concat(S(Y)).reduce(function(m,l){m.appendChild(l);return m},document.createDocumentFragment());j.appendChild(R)}return P});