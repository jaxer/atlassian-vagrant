define("feature/file-content/file-history",["jquery","underscore","util/events","widget/paged-scrollable","model/revision","util/ajax","util/navbuilder"],function(B,H,I,F,C,G,D){function E(N,K){var M=this._$historyButton=B(N);this._id=K;this._scrollPaneSelector="#inline-dialog-"+K+" .file-history";this._listSelector=this._scrollPaneSelector+" > ul";var U=this;var V=function(X){if(X.keyCode===B.ui.keyCode.ESCAPE){U.hide();X.preventDefault()}},Q=function(X){if(U.isButtonEnabled()){U.show()}X.preventDefault()},O=function(X){U.hide();X.preventDefault()},R=this._itemClicked=function(a){U.hide();var c=B(this),Z=c.children("a"),X=Z.attr("data-id"),b=U._visibleChangesets[X],Y=new C(b);I.trigger("stash.feature.filehistory.revisionSelected",U,Y);a.preventDefault()};var S=null,L=false,P;var T=function(Y,X,Z){if(!L){L=true;P=Y.html(stash.feature.fileContent.fileHistory());P.on("click","li.changeset-list-item",R);Z();S=U._createScrollable();U._visibleChangesets={};setTimeout(function(){Y.find(".spinner").spin();S.init()},0)}else{Z();H.defer(function(){B(U._listSelector).find(":first a").focus()})}M.off("click",Q);M.on("click",O);B(document).on("keyup",V)};var J=function(){B(document).off("keyup",V);M.off("click",O);M.on("click",Q);if(B(document.activeElement).closest(U._scrollPaneSelector).length){document.activeElement.blur()}};var W=function(){U.hide();S&&S.reset();B(document).off("keyup",V);P&&P.off("click","li.changeset-list-item",R);L=false};this._inlineDialog=AJS.InlineDialog(M,K,T,{hideDelay:1000,width:420,noBind:true,hideCallback:J});M.on("click",Q);I.on("stash.page.*.revisionRefChanged",W);I.on("stash.page.*.pathChanged",W)}E.prototype.init=function(K,L,J){this._path=K;this._selectedRevisionRef=L;this._headRevisionRef=J};E.prototype.destroy=function(){this._inlineDialog.remove()};E.prototype.show=function(){this._inlineDialog.show();B(this._listSelector).find(":first a").focus()};E.prototype.hide=function(){this._inlineDialog.hide()};E.prototype._createScrollable=function(){var K=new F(this._scrollPaneSelector,{bufferPixels:0,pageSize:25});K.requestData=B.proxy(this.requestData,this);K.attachNewContent=B.proxy(this.attachNewContent,this);var L=K.onFirstDataLoaded;var J=this;K.onFirstDataLoaded=function(){B(J._listSelector).find(":first a").focus();return L.apply(this,arguments)};return K};E.prototype.requestData=function(K,J){this._inlineDialog.find(".spinner").spin();return G.rest({url:D.rest().currentRepo().commits().withParams({path:this._path.toString(),until:this._headRevisionRef.getId(),start:K,limit:J,avatarSize:stash.widget.avatarSizeInPx({size:"xsmall"})}).build()})};function A(K,J){H.forEach(K,function(L){J[L.id]=L})}E.prototype.attachNewContent=function(J){A(J.values,this._visibleChangesets);B(this._listSelector).append(B(stash.feature.fileContent.fileHistoryItems({historyPage:J,selectedCsid:(this._selectedRevisionRef&&this._selectedRevisionRef.getId())||"",lastPageMessage:stash_i18n("stash.web.filehistory.allhistoryfetched","No more history")})));B(this._scrollPaneSelector).children(".spinner").spinStop();if(J.isLastPage){B(this._scrollPaneSelector).children(".spinner").remove()}};E.prototype.setButtonEnabled=function(J){this._$historyButton.prop("disabled",!J).toggleClass("disabled",!J)};E.prototype.isButtonEnabled=function(){return !this._$historyButton.prop("disabled")};return E});