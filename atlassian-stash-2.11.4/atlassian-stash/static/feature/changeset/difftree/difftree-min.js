define("feature/changeset/difftree",["exports","jquery","aui","util/events","model/content-tree-node-types","util/navbuilder","util/ajax"],function(W,F,I,B,N,R,O){var D="/";var M=1000;var H=(F.browser.msie&&parseInt(F.browser.version,10)<9)?20:200;function Q(X,Z){Z=Z>=0?Z:H;var a=0;function Y(d){if(d.metadata.isDirectory){d.state="open";d.data.icon="aui-icon aui-icon-small aui-iconfont-devtools-folder-open";for(var c=0,b=d.children.length,e;c<b&&a<Z;c++){e=d.children[c];Y(e)}}else{if(d.metadata.isFile){a++}}}Y(X)}function P(Y,X){return Y.children?(X.children?(Y.data.title.toLowerCase()<X.data.title.toLowerCase()?-1:1):-1):(!X.children?(Y.data.title.toLowerCase()<X.data.title.toLowerCase()?-1:1):1)}function V(X){X.childrenByTypeAndComponent=undefined;for(var Z=0,Y=X.children.length,b,a;Z<Y;Z++){b=X.children[Z];if(b.metadata.isDirectory){a=[b.data.title];while(b.children.length===1&&b.children[0].metadata.isDirectory){b=b.children[0];a.push(b.data.title)}b.data.title=a.join(D);X.children[Z]=b;V(b)}}X.children.sort(P)}function E(h,e){var o={data:{icon:"aui-icon aui-icon-small aui-iconfont-devtools-folder-closed"},state:"closed",metadata:{isDirectory:true},children:[],childrenByTypeAndComponent:{}};for(var d=0,Z=h.length,g,Y;d<Z;d++){g=h[d];Y=o;for(var c=0,a=g.path.components.length,f,n,X;c<a;c++){f=g.path.components[c];n=(c+1===a?"F":"D")+f;if(Object.prototype.hasOwnProperty.call(Y.childrenByTypeAndComponent,n)){Y=Y.childrenByTypeAndComponent[n]}else{var b=c+1===a;if(b){var m=!!(g.attributes&&g.attributes.activeComments&&parseInt(g.attributes.activeComments[0],10));X={data:{title:f,icon:"aui-icon aui-icon-small "+(g.nodeType===N.SUBMODULE?"aui-iconfont-devtools-submodule":m?"aui-iconfont-devtools-file-commented":"aui-iconfont-devtools-file"),attr:{id:"change"+d,"class":"change-type-"+g.type+(g.conflict?" conflict":""),href:"#"+g.path.toString,title:g.conflict?stash_i18n("stash.web.pullrequest.tree.conflicted.file","Merge conflict"):m?stash_i18n("stash.web.pullrequest.tree.commented.file","This file has comments"):undefined}},metadata:{isFile:true,changeType:g.type,nodeType:g.nodeType,path:g.path,srcPath:g.srcPath,conflict:g.conflict,contentId:g.contentId,executable:g.executable,srcExecutable:g.srcExecutable}}}else{X={data:{title:f,icon:"aui-icon aui-icon-small aui-iconfont-devtools-folder-closed"},state:"closed",metadata:{isDirectory:true},children:[],childrenByTypeAndComponent:{}}}Y.children.push(X);Y=Y.childrenByTypeAndComponent[n]=X}}}V(o);Q(o,e);return o}function K(Z,X,Y){Y=Y||{};this._fileLimit=Y.maxChanges||M;this._$wrapper=F(Z);this._commitRange=X;this._hasOtherParents=!!Y.hasOtherParents}K.prototype.init=function(X){this._initiallySelectedPathComponents=X;this._firstCommentAddedHandler=_.bind(this._firstCommentAddedHandler,this);this._lastCommentDeletedHandler=_.bind(this._lastCommentDeletedHandler,this);B.on("stash.feature.comments.firstCommentAdded",this._firstCommentAddedHandler);B.on("stash.feature.comments.lastCommentDeleted",this._lastCommentDeletedHandler);if(!this.data){return this.requestData()}else{return this.dataReceived()}};K.prototype._firstCommentAddedHandler=function(){var X=this.getSelectedFile().find("a > ins");X.hide().removeClass("aui-iconfont-devtools-file").addClass("aui-iconfont-devtools-file-commented").fadeIn("slow")};K.prototype._lastCommentDeletedHandler=function(){var X=this.getSelectedFile().find("a > ins");X.hide().removeClass("aui-iconfont-devtools-file-commented").addClass("aui-iconfont-devtools-file").fadeIn("slow")};K.prototype.reset=function(){if(this._request){this._request.abort();this._request=null;this._interrupted=true}if(this._rendering){this._rendering=false;this._interrupted=true}B.off("stash.feature.comments.firstCommentAdded",this._firstCommentAddedHandler);B.off("stash.feature.comments.lastCommentDeleted",this._lastCommentDeletedHandler)};K.prototype.requestData=function(){var X=this;if(this._request){this._request.abort();this._request=null}this._request=O.rest({url:R.rest().currentRepo().changes(X._commitRange).withParams({start:0,limit:this._fileLimit}).build()});return this._request.always(function(){X._request=null}).then(function(Y){if(!Y){var Z=I.escapeHtml(stash_i18n("stash.web.pullrequest.tree.nodata","This pull request returned no data to display"));X.prependMessage(Z,"error");return F.Deferred().reject()}else{X._rendering=true;X._interrupted=false;X.isTruncated=!Y.isLastPage;X.data=E(Y.values);return X.dataReceived().done(function(){X._rendering=false})}})};function S(Y,X){return Y.substring(0,X.length)===X}function U(Y,X){return C(Y,X)||T(Y)}function C(b,d){if(!d){return null}d=d.slice(0);while(b&&b.children){var Y=d.shift(),X=!d.length;var Z=b.children.length;while(Z--){var a=b.children[Z],c=a.data.title;if(Y===c&&X===Boolean(a.metadata.isFile)){b=a;break}if(!X&&S(c,Y+D)){while(d.length>1&&S(c,Y+D+d[0])){Y+=D;Y+=d.shift()}if(c!==Y){return null}b=a;break}}if(Z<0){return null}}return b&&b.metadata&&b.metadata.isFile?b:null}function T(X){while(X&&X.children){X=X.children[0]}return X&&X.metadata&&X.metadata.isFile?X:null}function G(Y,a){if(Y===a){return[a]}var Z=Y.children?Y.children.length:0;while(Z--){var X=G(Y.children[Z],a);if(X){X.unshift(Y);return X}}return null}K.prototype.prependMessage=function(Y,X){this._$wrapper.find(".aui-message").remove();X=X||"warning";this._$wrapper.prepend(widget.aui.message[X]({extraClasses:"diff-tree-scm-message",contents:Y}))};K.prototype.dataReceived=function(){var i=this;var j=F.Deferred();function b(){if(!i._interrupted){j.resolve(i)}else{j.reject(i)}}var d=U(this.data,this._initiallySelectedPathComponents);var a;if(d){a=[d.data.attr.id];var f=G(this.data,d)||[];f.pop();while(f.length){f.pop().state="open"}}else{a=[]}var Y=true;var c;this._$wrapper.find(".aui-message").remove();if(this.isTruncated){var Z="";if(this._commitRange.getPullRequest()){Z=I.escapeHtml(stash_i18n("stash.web.pullrequest.tree.truncated","This pull request is too large to render. Showing the first {0} files.",this._fileLimit))}else{var g,e=this._commitRange.getUntilRevision(),X=this._commitRange.getSinceRevision();if(X){g="git diff-tree -C -r "+X.getId()+" "+e.getId()}else{g="git diff-tree -r --root "+e.getId()}Z=I.escapeHtml(stash_i18n("stash.web.changeset.tree.truncated","This changeset is too large to render. Showing the first {0} files. You can still retrieve it manually with the following Git command.",this._fileLimit))+'<p class="scm-command">'+I.escapeHtml(g)+"</p>"}this.prependMessage(Z,"warning")}if(this.data.children.length){this.$tree=this._$wrapper.children(".file-tree");this.$tree.fadeOut("fast",function(){i.$tree.empty().off(".jstree").jstree("destroy").on("loaded.jstree",function(){setTimeout(function(){Y=false;b()},0)}).jstree({json_data:{data:i.data.children,progressive_render:true},core:{animation:200},ui:{select_limit:1,selected_parent_close:false,initially_select:a},plugins:["json_data","ui"]}).on("before.jstree",function(m,l){if(l.func==="select_node"){var k=F(l.args[0]).parent();if(k.data("isFile")&&(!c||c[0]!==k[0])){c=k;B.trigger("stash.feature.changeset.difftree.selectedNodeChanged",i,k,Y)}else{if(k.data("isDirectory")){i.$tree.jstree("toggle_node",k);return false}}}}).on("open_node.jstree",function(l,k){var m=k.args[0];var n=m.children("a").children("ins");n.removeClass("aui-iconfont-devtools-folder-closed");n.addClass("aui-iconfont-devtools-folder-open");B.trigger("stash.feature.changeset.difftree.nodeOpening",i,m)}).on("after_open.jstree",function(l,k){var m=k.args[0];B.trigger("stash.feature.changeset.difftree.nodeOpened",i,m)}).on("close_node.jstree",function(m,l){var k=l.args[0];var n=k.children("a").children("ins");n.removeClass("aui-iconfont-devtools-folder-open");n.addClass("aui-iconfont-devtools-folder-closed");B.trigger("stash.feature.changeset.difftree.nodeClosing",i,k)}).on("after_close.jstree",function(m,l){var k=l.args[0];B.trigger("stash.feature.changeset.difftree.nodeClosed",i,k)}).on("loaded.jstree",function(l,k){B.trigger("stash.feature.changeset.difftree.treeInitialised",i,i)}).fadeIn("fast")})}else{this.$tree=undefined;var h=this._$wrapper.children(".file-tree");h.fadeOut("fast",function(){h.empty().off(".jstree").jstree("destroy");var k=I.escapeHtml(i._hasOtherParents?stash_i18n("stash.web.changeset.merge.tree.empty","There are no changes to this parent. Use the selector above to switch the parent."):stash_i18n("stash.web.changeset.tree.empty","There are no changes."));i.prependMessage(k,"info");setTimeout(b,0)})}return j.promise()};K.prototype.getSelectedFile=function(){var X=this.$tree;return X?X.jstree("get_selected"):null};K.prototype.selectFile=function(a){if(!this.$tree){return }var X=U(this.data,a),Y=this.getSelectedFile(),b=Y&&Y.data("path"),Z=b&&U(this.data,b.components);if(X&&X!==Z){this.$tree.jstree("deselect_all").jstree("select_node","#"+X.data.attr.id)}};K.prototype.openNextFile=function(){if(this.$tree){var X=F.jstree._reference(this.$tree),Z=this.getSelectedFile(),Y=L(X,X._get_next,X._get_next(Z));if(Y&&Y.length){Y.find("a").focus().click()}}};K.prototype.openPrevFile=function(){if(this.$tree){var X=F.jstree._reference(this.$tree),Z=this.getSelectedFile(),Y=J(X,X._get_prev(Z));if(Y&&Y.length){Y.find("a").focus().click()}}};function L(Y,Z,X){if(X&&X.length&&!X.hasClass("jstree-leaf")){Y.open_node(X);X=L(Y,Z,Z.call(Y,X))}return X}function J(Y,X){if(X&&!X.hasClass("jstree-leaf")){if(X.hasClass("jstree-closed")){Y.open_node(X);X=L(Y,A,A.call(Y,X))}else{if(X.length){X=J(Y,Y._get_prev(X))}}}return X}function A(X){return this._get_children(X).filter(".jstree-last")}W.DiffTree=K;W.computeTree=E;W.flattenTree=V;W.compareTreeNodes=P;W.getNodeToSelect=U;W.getPathFromRoot=G});