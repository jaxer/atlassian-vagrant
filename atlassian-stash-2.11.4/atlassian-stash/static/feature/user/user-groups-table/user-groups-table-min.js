define("feature/user/user-groups-table",["aui","jquery","underscore","util/ajax","util/error","util/navbuilder","feature/user/group-multi-selector","feature/user/group-table"],function(J,F,K,I,D,L,G,C){var E=".add-button";var B=".groups-multi-selector";var H=".delete-button";function A(M){C.call(this,F.extend({},{filterable:false,noneFoundMessageHtml:J.escapeHtml(stash_i18n("stash.web.users.groups.noneFound","This user is not a member of any group"))},M));this.username=this.$table.attr("data-username");this.onError=M.onError||D.showNonFieldErrors;this._initBindings=K.once(this._initBindings)}F.extend(A.prototype,C.prototype);A.prototype.buildUrl=function(O,M,N){return L.admin().users().addPathComponents("more-members").withParams({context:this.username,start:O,limit:M}).build()};A.prototype.init=function(){C.prototype.init.call(this);this._initBindings()};A.prototype.handleErrors=function(N){var M=this;K.each(N,function(O){M.onError(O.message)})};A.prototype.handleNewRows=function(M,N){this.$table.find("tbody")[N](stash.feature.user.userGroupsRows({groups:M.values}))};A.prototype.remove=function(O){var N=this;if(C.prototype.remove.call(this,O)){var M=this.$table.find("tbody > tr[data-name]").filter(function(){return F(this).attr("data-name")===O.name});M.fadeOut("fast",function(){M.remove();N.updateTimestamp()})}};A.prototype._initBindings=function(){var M=this;var N=new G(F(B,M.$table),{url:L.admin().users().addPathComponents("more-non-members").withParams({context:M.username}).build()});M.$table.on("click",E,function(Q){Q.preventDefault();var O=N.getSelectedItems();var P=K.pluck(O,"name");M._addGroups(M.username,P).done(function(){N.clearSelectedItems();M.add(K.map(O,function(R){return F.extend({justAdded:true},R)}))}).fail(function(T,U,R,S){M.handleErrors(M._extractErrors(S,R))})});M.$table.on("click",H,function(O){O.preventDefault();var P=F(O.target).closest("a").attr("data-for");M._removeGroups(M.username,P).done(function(){M.remove({name:P})}).fail(function(S,T,Q,R){M.handleErrors(M._extractErrors(R,Q))})})};A.prototype._addGroups=function(N,M){return I.rest({data:{user:N,groups:M},statusCode:{"403":false,"404":false},type:"POST",url:L.admin().users().addPathComponents("add-groups").build()})};A.prototype._removeGroups=function(N,M){return I.rest({data:{context:N,itemName:M},statusCode:{"403":false,"404":false,"409":false},type:"POST",url:L.admin().users().addPathComponents("remove-group").build()})};A.prototype._extractErrors=function(M){return M&&M.errors&&M.errors.length?M.errors:[{message:J.escapeHtml(stash_i18n("stash.web.users.group.unknown.error","An unknown error has occurred"))}]};return A});