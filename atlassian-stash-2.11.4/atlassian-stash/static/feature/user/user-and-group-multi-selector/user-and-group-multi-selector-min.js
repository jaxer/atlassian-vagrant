define("feature/user/user-and-group-multi-selector",["aui","jquery","underscore","util/promise","widget/searchable-multi-selector","feature/user/group-multi-selector","feature/user/user-multi-selector"],function(J,F,R,P,D,A,N){var T=D.PagedDataSource;var E={user:N.prototype.defaults.selectionTemplate,group:A.prototype.defaults.selectionTemplate};var H={user:N.prototype.defaults.resultTemplate,group:A.prototype.defaults.resultTemplate};var G={user:N.prototype.defaults.generateId,group:A.prototype.defaults.generateId};var K={user:N.prototype.defaults.generateText,group:A.prototype.defaults.generateText};function O(U){return{type:"group",entity:U}}function L(U){return{type:"user",entity:U}}function S(U){U=U||{};return R.map(U.users||[],L).concat(R.map(U.groups||[],O))}function M(V,U){U=F.extend(true,{},this.defaults,U);U.initialItems=S(U.initialItems);U.excludedItems=S(U.excludedItems);if(!U.dataSource){U.dataSource=new Q(new T(U.urls.user,U.urlParams.user),new T(U.urls.group,U.urlParams.group))}D.call(this,V,U)}F.extend(true,M.prototype,D.prototype,{defaults:{initialItems:{user:[],group:[]},excludedItems:{user:[],group:[]},urls:{user:N.prototype.defaults.url,group:A.prototype.defaults.url},urlParams:{user:N.prototype.defaults.urlParams,group:A.prototype.defaults.urlParams},hasAvatar:true,selectionTemplate:function(U){return E[U.type](U.entity)},resultTemplate:function(U){return H[U.type](U.entity)},inputTooShortTemplate:function(){return J.escapeHtml(stash_i18n("stash.web.user.and.group.multi.selector.help","Start typing to search for users and groups"))},noMatchesTemplate:function(){return J.escapeHtml(stash_i18n("stash.web.user.and.group.multi.selector.no.match","No matching users or groups found"))},generateId:function(U){return U.type+":"+G[U.type](U.entity)},generateText:function(U){return K[U.type](U.entity)}},getSelectedItems:function(){return R.reduce(D.prototype.getSelectedItems.call(this),function(U,V){U[V.type+"s"].push(V.entity);return U},{users:[],groups:[]})},setSelectedItems:function(U){D.prototype.setSelectedItems.call(this,S(U))},clearSelectedItems:function(){return this.setSelectedItems({})}});var B=F.Deferred().resolve({isLastPage:true,values:[]});function C(W,U){var X=K[W.type](W.entity);var V=K[U.type](U.entity);return X.toLowerCase().localeCompare(V.toLowerCase())}function I(V,U){return{values:V.values.concat(U.values).sort(C),isLastPage:V.isLastPage&&U.isLastPage}}function Q(U,V){this._userDataSource=U;this._groupDataSource=V}Q.prototype.clear=function(){this._userAtEnd=false;this._groupAtEnd=false;this._userDataSource.clear();this._groupDataSource.clear()};Q.prototype.nextPage=function(V){var U=this._userAtEnd?B:this._userDataSource.nextPage(V);U=U.then(R.bind(function(Y){this._userAtEnd=Y.isLastPage;Y.values=R.map(Y.values,L);return Y},this)).promise(U);var X=this._groupAtEnd?B:this._groupDataSource.nextPage(V);X=X.then(R.bind(function(Y){this._groupAtEnd=Y.isLastPage;Y.values=R.map(Y.values,O);return Y},this)).promise(X);var W=P.reduce(U,X);return W.then(I).promise(W)};return M});