define("feature/repository/hook-list",["aui","jquery","underscore","backbone-brace","util/config-form","util/ajax","widget/submit-spinner","util/navbuilder"],function(G,B,H,F,J,E,C,I){function D(L){var K=this._dialog=new G.Dialog({width:840,height:480,id:"repository-hook-dialog",closeOnOutsideClick:false,keypressListener:H.bind(function(M){if(M.keyCode===B.ui.keyCode.ESCAPE){M.stopImmediatePropagation();this.close()}},this)});K.addHeader(" ").addPanel("",'<div class="hook-config-contents"/>').addSubmit(stash_i18n("stash.web.button.enable","Enable"),H.bind(this.saveHook,this)).addButton(stash_i18n("stash.web.button.disable","Disable"),H.bind(this.disableHook,this),"button-panel-disable-button").addCancel(stash_i18n("stash.web.button.cancel","Cancel"),H.bind(this.close,this));this._hook=L;B("#repository-hook-dialog").on("submit","form",H.bind(function(M){M.preventDefault();this.saveHook()},this))}D.prototype._resize=function(){H.delay(H.bind(this._dialog.updateHeight,this._dialog))};D.prototype._getConfigContents=function(){return this.$(".hook-config-contents")};D.prototype.saveHook=function(){var K=new C(this.$(".button-panel-submit-button",this._dialog.getPage(0).buttonpanel),"before").show();this._dialog.disable();this._configForm.save(this._hook.getEnabled()?H.bind(this._hook.saveSettings,this._hook):H.bind(this._hook.enable,this._hook)).done(H.bind(this.close,this)).fail(H.bind(this._resize,this)).fail(H.bind(this._dialog.enable,this._dialog)).always(H.bind(K.remove,K))};D.prototype.disableHook=function(){var K=this._hook.disable();K.always(H.bind(this.close,this))};D.prototype.$=function(K){return B("#repository-hook-dialog").find(K)};D.prototype.close=function(){this._dialog.remove();this._hook=null;this._configForm=null};D.prototype.show=function(){var M=this._hook;if(!M.getDetails().getConfigFormKey()){throw new Error("Dialog without configuration cannot be shown")}this.$(".dialog-title").text(M.getDetails().getName());var L=this._getConfigContents().empty();L.spin("large");var K=this._configForm=new J(L,M.getDetails().getConfigFormKey());K.loadAndRender(H.bind(M.loadSettings,M)).done(H.bind(this._resize,this));this.$(".button-panel-disable-button")[M.getEnabled()?"show":"hide"]();this.$(".button-panel-submit-button").text(M.getEnabled()?stash_i18n("stash.web.button.save","Save"):stash_i18n("stash.web.button.enable","Enable"));this._dialog.show();return this};var A=F.View.extend({initialize:function(){this.collection.on("change:enabled",H.bind(this.changeEnabledState,this));this.currentHookPageStart=this.$("tbody > tr").length;this.$loadMoreLink=this.$(".load-more");H.bindAll(this,"onHooksLoaded")},events:{"click .load-more":"loadMore","click .hook-name a":"configureHook","click .edit-button":"configureHook","click .mode-enabled":"enableHook","click .mode-disabled":"disableHook"},loadMore:function(K){K.preventDefault();this.$loadMoreLink.next(".spinner").show().spin();E.rest({url:I.rest().currentRepo().hooks().build(),type:"GET",data:{type:this.options.hookType,start:this.currentHookPageStart,limit:25}}).done(this.onHooksLoaded)},onHooksLoaded:function(K){this.$el.children("tbody").append(stash.feature.repository.hookRows({values:K.values}));this.currentHookPageStart+=K.size;if(K.isLastPage){this.$loadMoreLink.closest(".load-more-row").hide()}this.$loadMoreLink.next(".spinner").spinStop().hide()},configureHook:function(M){M.preventDefault();var K=B(M.target).closest("tr").attr("data-key");var L=this.collection.get(K);if(L){this.createDialog(L)}},enableHook:function(N){N.preventDefault();var L=B(N.target);var K=L.closest("tr").attr("data-key");var M=this.collection.get(K);if(!M.getConfigured()&&M.getDetails().getConfigFormKey()){this.createDialog(M)}else{this.changeEnabledStateNow(M,M.enable(),true)}},disableHook:function(N){N.preventDefault();var L=B(N.target);var K=L.closest("tr").attr("data-key");var M=this.collection.get(K);this.changeEnabledStateNow(M,M.disable(),false)},createDialog:function(L){var K=new D(L);K.show()},changeEnabledStateNow:function(L,M,K){this.changeEnabledStateWithStatus(L,K);M.fail(H.bind(this.changeEnabledState,this,L))},changeEnabledState:function(K){this.changeEnabledStateWithStatus(K,K.getEnabled())},changeEnabledStateWithStatus:function(L,K){var M=this.$('tr[data-key="'+L.getDetails().getKey()+'"] .cell-actions');M.html(stash.feature.repository.hookActions({enabled:K}))}});return A});