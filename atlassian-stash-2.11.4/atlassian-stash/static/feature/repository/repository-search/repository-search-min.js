define("feature/repository/repository-search",["jquery","underscore","xregexp","util/navbuilder","util/events","widget/searchable-selector"],function(F,C,G,H,D,B){var E=null;D.on("stash.feature.repositories.recent.loaded",function(I){E=I});var A=function(L,J,I){I=I||{};I.externalSearchField=L;var K=this.init(J,I);K._bindSearchFieldEvents();return K};F.extend(A.prototype,B.prototype);A.prototype._generatePreloadData=function(){if(E==null){return null}var I;var K=this._parseSearchTerm(this._getSearchTerm());if(K){var L=K.projectName&&new RegExp("^"+G.escape(K.projectName),"i");var J=K.repositoryName&&new RegExp("^"+G.escape(K.repositoryName),"i");I=C.filter(E.values,function(M){return(K.projectName==null||M.project.name.match(L)!=null)&&(K.repositoryName==null||M.name.match(J)!=null)})}else{I=E.values}I.sort(function(N,M){return(K&&K.projectName?N.project.name.localeCompare(M.project.name):0)||N.name.localeCompare(M.name)||N.id-M.id});return C.extend({},E,{values:I,size:I.length,isLastPage:false})};A.prototype.defaults=F.extend({},B.prototype.defaults,{extraClasses:"repository-search-dialog",url:H.rest().allRepos().withParams({avatarSize:stash.widget.avatarSizeInPx({size:"xsmall"})}).build(),queryParamsBuilder:function(J,L,I){var K=this._parseSearchTerm(J);if(K==null){return null}return{start:L,limit:I,name:K.repositoryName,projectname:K.projectName}},dataTransform:function(K,I){var J=this._parseSearchTerm(I);if(J==null){return K}return F.extend({repositorySearchTerm:J.repositoryName,projectSearchTerm:J.projectName},K)},preloadData:A.prototype._generatePreloadData,alwaysShowPreload:true,followLinks:true,resultsTemplate:stash.feature.repository.repositorySearchResults,noResultsText:stash_i18n("stash.web.repository-search.results.empty","No repositories matching your search"),noMoreResultsText:stash_i18n("stash.web.repository-search.results.end","No more repositories"),adjacentItems:false,clearResultsOnSearch:false,popUpOffsetY:1});A.prototype._bindSearchFieldEvents=function(){var I=this;this.$searchField.on("keydown.repository-search",function(J){if(J.which===F.ui.keyCode.ENTER){J.preventDefault()}});this.$searchField.on("keyup.repository-search",function(J){var K=I.dialog.is(":visible");if(!K&&J.which===F.ui.keyCode.ESCAPE){F(this).blur()}})};A.prototype._parseSearchTerm=function(I){I=F.trim(I);if(I===""||I==="/"){return null}var K={};var J=I.lastIndexOf("/");if(J===-1){K.projectName=null;K.repositoryName=I}else{K.projectName=F.trim(I.substr(0,J));K.repositoryName=F.trim(I.substr(J+1))}return K};A.prototype._showSpinner=function(I){I.$scrollElement.find(".spinner").hide();this.$searchField.addClass("loading").next(".spinner").spin()};A.prototype._hideSpinner=function(){this.$searchField.removeClass("loading").next(".spinner").spinStop()};return A});