define("feature/repository/source-target-selector",["jquery","underscore","util/events","util/ajax","util/navbuilder","feature/repository/related-repository-selector","feature/repository/branch-selector"],function(G,C,D,F,H,B,E){function A(L,K,M,J,I){this.init.apply(this,arguments)}A.prototype.defaults={showChangesetBadges:true};A.prototype.init=function(N,M,P,L,K){var J=this;J.refSelectors={};J.options=G.extend({},J.defaults,K);var O=[{name:"source",repository:M},{name:"target",repository:P}];var I=B.constructDataPageFromPreloadArray(C.chain(O).pluck("repository").union(L).compact().uniq(function(Q){return Q.getId()}).invoke("toJSON").value());C.each(O,function(S){var Q=G("."+S.name+"Branch",N);var T=Q.next("input");var R=G("."+S.name+"Repo",N);var U=R.next("input");var V={$headChangesetSpinner:G("<div class='spinner'/>").insertAfter(T),branchSelector:new E(Q,{id:S.name+"BranchDialog",context:S.name,repository:S.repository,field:T}),repoSelector:new B(R,{id:S.name+"RepoDialog",context:S.name,repository:S.repository,field:U,preloadData:I}),getBranch:function(){return this.branchSelector.getSelectedItem()},getRepo:function(){return this.repoSelector.getSelectedItem()}};J.refSelectors[S.name]=V});D.on("stash.feature.repository.revisionReferenceSelector.revisionRefChanged",function(Q,R){var S=J.refSelectors[R];if(J.options.showChangesetBadges){J._updateChangesetBadge(S,Q)}if(R==="source"){J.refSelectors.target.repoSelector.$trigger.focus()}D.trigger("stash.feature.repository.sourceTargetSelector."+R+".revisionRefChanged",J,Q)});D.on("stash.feature.repository.repositorySelector.repositoryChanged",function(R,Q){var S=J.refSelectors[Q];S.branchSelector.setRepository(R);S.branchSelector.$trigger.focus();if(J.options.showChangesetBadges){J._updateChangesetBadge(S,null)}D.trigger("stash.feature.repository.sourceTargetSelector."+Q+".repositoryChanged",J,R)});return J};A.prototype._updateChangesetBadge=function(M,I){var J=this,L=M.branchSelector.$trigger.siblings(".changeset-badge-detailed").hide();if(I){M.$headChangesetSpinner.show().spin("small");var K=M.getRepo();F.rest({url:H.rest().project(K.getProject()).repo(K).commit(I.getLatestChangeset()).build()}).done(function(O){var N=G(stash.feature.changeset.changesetBadge.detailed({changeset:O,repository:K.toJSON()})).hide();L.replaceWith(N);N.fadeIn()}).always(function(){M.$headChangesetSpinner.spinStop().hide()})}else{L.empty()}};A.prototype.branchesSelected=function(){return !!(this.refSelectors.source.getBranch()&&this.refSelectors.target.getBranch())};A.prototype.refsAreEqual=function(){var J=this.refSelectors.source.getBranch();var I=this.refSelectors.target.getBranch();return !!(J&&J.isEqual(I))};A.prototype.getSourceRepository=function(){return this.refSelectors.source.getRepo()};A.prototype.getTargetRepository=function(){return this.refSelectors.target.getRepo()};A.prototype.getSourceBranch=function(){return this.refSelectors.source.getBranch()};A.prototype.getTargetBranch=function(){return this.refSelectors.target.getBranch()};return A});