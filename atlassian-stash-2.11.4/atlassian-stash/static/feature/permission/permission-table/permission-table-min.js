define("feature/permission/permission-table",["jquery","underscore","util/ajax","util/function","util/warn-before-unload","model/page-state","feature/permission/multi-selector","exports"],function(D,K,I,H,B,J,F,C){function G(Q,M){function P(R){return I.rest({url:Q[M+"s"]().none().build(),type:"GET",data:R})}function L(R){return I.rest({url:Q[M+"s"]().build(),type:"GET",data:R})}function O(R,S){return I.rest({url:Q[M+"s"]().withParams({permission:R,name:S}).build(),type:"PUT",statusCode:{"400":false,"403":false,"404":false,"409":false}})}function N(R){return I.rest({url:Q[M+"s"]().withParams({name:R}).build(),type:"DELETE",statusCode:{"400":false,"403":false,"404":false,"409":false}})}return{getMembers:L,getNonMembers:P,setPermission:O,removePermissions:N}}function A(L){this._delegate=L;this._pageReceived=K.bind(this._pageReceived,this);this.clear()}A.prototype.clear=function(){this._nextPageStart=0};A.prototype.nextPage=function(L){return this._delegate.getNonMembers({start:this._nextPageStart,filter:L,avatarSize:stash.widget.avatarSizeInPx({size:"xsmall"})}).done(this._pageReceived)};A.prototype._pageReceived=function(L){this._nextPageStart=L.nextPageStart||(L.start+L.size)};function E(M,O,L,N,Q,P){this._entityType=N;if(this._entityType==="user"){this._text=E.userText;this._rowTemplate=stash.feature.permission.userPermissionRow;this._isEntityCurrentUser=function(R){return J.getCurrentUser()&&R.name===J.getCurrentUser().getName()}}else{this._text=E.groupText;this._rowTemplate=stash.feature.permission.groupPermissionRow;this._isEntityCurrentUser=H.constant(false)}this._dataSource=G(O,this._entityType);this._permissions=K.pluck(L,"name");this._initialPermission=this._permissions[this._permissions.length-1];this._permissionNames=K.pluck(L,"i18nName");this._currentUserHighestPerm=Q;this._pageSize=50;this._addedEntities=[];this.opts=P||{};this._wireComponents(M);this._initAddMultiSelector();this._initRows();this._initLoadMoreButton();this.refresh()}E.text={entityList:{buttonLoadMoreText:stash_i18n("stash.web.permission.table.load.more","Load more")},pendingModification:stash_i18n("stash.web.pending.request","You have made permission changes that have not yet reached Stash. If you leave this page, those changes will be lost."),cantGrantHigherPerms:function(L){return stash_i18n("stash.web.permission.table.cantgranthigher.tooltip","You cannot grant the {0} permission",L)},inheritedPerm:stash_i18n("stash.web.permission.table.inheritedperm.tooltip","This permission is inherited from a higher permission")};E.userText=D.extend(true,{inactiveEntity:function(L){return stash_i18n("stash.web.permission.table.inactive.user","{0} is deleted or marked as inactive in a remote directory",L)},cantRevokeHigherPerms:function(L){return stash_i18n("stash.web.permission.table.cantrevokehigheruser.tooltip","You cannot change permissions for a {0} ",L)},cantGrantSelfHigherPerms:function(L){return stash_i18n("stash.web.permission.table.cantgrantselfhigher.tooltip","You cannot grant yourself the {0} permission",L)},implicitPerm:stash_i18n("stash.web.permission.table.basePerm.tooltip","To remove this permission, click the X to the right to remove the entire row."),noMoreItemsText:stash_i18n("stash.web.permission.table.users.none.added","All users already have permissions set.")},E.text);E.groupText=D.extend(true,{inactiveEntity:function(L){return stash_i18n("stash.web.permission.table.invisible.group","{0} is deleted",L)},cantRevokeHigherPerms:function(L){return stash_i18n("stash.web.permission.table.cantrevokehighergroup.tooltip","You cannot change permissions for a {0} group",L)},implicitPerm:stash_i18n("stash.web.permission.table.basePerm.tooltip","To remove this permission remove the group row"),noMoreItemsText:stash_i18n("stash.web.permission.table.groups.none.added","All groups already have permissions set.")},E.text);E.prototype._wireComponents=function(L){this._$container=D(L);this._$tbody=this._$container.find("tbody");this._$noResults=this._$container.find(".no-results-row");this._$loadMore=this._$container.find(".load-more");this._$spinner=D(this._$loadMore).parent().append('<div class="permissions-spinner" />').find(".permissions-spinner")};E.prototype._getModalItem=function(L){return{content:D(stash.feature.permission.permissionModalItem({entity:L,isUser:this._entityType==="user",inactiveText:this._text.inactiveEntity(L.name)})),id:L.name}};E.prototype._initAddMultiSelector=function(){var L=this;this._multiSelector=new F({el:this._$container.find(".permission-multi-selector-container")[0],entityType:this._entityType,add:function(M){return L._dataSource.setPermission(M.permission,K.pluck(M.entities,"name")).done(function(){L._addedEntities.push.apply(L._addedEntities,K.map(M.entities,function(N){var O={permission:M.permission};O[L._entityType]=N;return O}));L.refresh()})},dataSource:new A(this._dataSource)})};E.prototype._updateErrors=function(L,O){var N=L.closest("tr"),M=N.attr("data-entity-id");N.closest("tbody").find(".permission-error").remove();return O.fail(function(S,T,R,P){if(P&&P.errors){var Q=N.children("td").length;D.each(P.errors,function(U){N.after(stash.feature.permission.errorPermissionRow({entityId:M,numRows:Q,message:P.errors[U].message}))})}})};E.prototype._spinWhilePending=function(L,N){if(N&&N.state()==="pending"){L.closest("tr").find(":checkbox").prop("disabled",true);var M=D('<div class="spinner" />');M.insertAfter(L);L.addClass("hidden");M.spin("small");N.always(function(){L.removeClass("hidden");M.spinStop().remove()})}};E.prototype._getAllCheckboxes=function(L){return L.parent().parent().find(":checkbox")};E.prototype._getCheckboxStates=function(L){return D.map(L,function(M){return{checked:D(M).prop("checked"),disabled:D(M).prop("disabled")}})};E.prototype._restoreCheckboxStates=function(M,L){D.each(L,function(N,P){var O=D(M.get(N));O.prop("checked",P.checked).prop("disabled",P.disabled).toggleClass("disabled",P.disabled)})};E.prototype._setChecked=function(P,O,L){this._restoreCheckboxStates(this._getAllCheckboxes(P),L);O.prop("checked",false).prop("title","");var Q=P.parent().nextAll().children(":checkbox").prop("checked",true).prop("disabled",true).addClass("disabled").prop("title",this._text.inheritedPerm);P.prop("title",Q.length?"":this._text.implicitPerm);P.prop("checked",true).prop("disabled",!Q.length).toggleClass("disabled",!Q.length);var M=P.closest("[data-entity-id]").attr("data-entity-id");var N=this._entityType;K.each(this._addedEntities,function(R){if(R[N].name===M){R.permission=P.val()}})};E.prototype._initRows=function(){var L=this;this._$tbody.on("change",":checkbox",function(){var U=D(this);var O=U.parent();var N=O.next();var R=O.parent().attr("data-entity-id");var T,P;var Q,W;if(this.checked){while(N.length&&!N.children(":checked").length){N=N.next()}T=N.children(":checkbox");P=U;Q=T.prop("value");W=this.value}else{T=U;P=N.children(":checkbox");Q=this.value;W=P.prop("value")}var M=[];if(W){M.push(L._dataSource.setPermission(W,R))}var S=L._getCheckboxStates(L._getAllCheckboxes(P));var V=D.when.apply(D,M);L._spinWhilePending(U,V);L._updateErrors(U,V);V.done(function(){L._setChecked(P,T,S)}).fail(function(Z,a,Y,X){L._setChecked(T,P,S)});B(V,L._text.pendingModification)}).on("click",".delete-button",function(S){var R=D(this),O=R.parents("tr").first(),N=O.attr("data-entity-id"),Q=O.find(":checkbox"),M=L._getCheckboxStates(Q);var P=L._dataSource.removePermissions(N);L._spinWhilePending(R,P);L._updateErrors(R,P);P.done(function(){L._numLoaded--;L._addedEntities=K.filter(L._addedEntities,function(U){var V=U[L._entityType].name===N;if(V&&!U.loaded){L._numLoaded++}return !V});if(!O.siblings().length&&!L._$loadMore.is(":visible")){var T=L._$noResults.find("div");T.css("opacity",0);L._$noResults.show();T.animate({opacity:1},500)}O.remove()}).fail(function(){L._restoreCheckboxStates(Q,M)});B(P,L._text.pendingModification);S.preventDefault();return false})};E.prototype._initLoadMoreButton=function(M){var L=this;this._$loadMore.click(function(N){L._loadItems();N.preventDefault()})};E.prototype._renderRow=function(L,Q,S,N){var T=this;var O=K.isUndefined(Q)?T._permissions.length-1:K.indexOf(this._permissions,Q);var R=K.indexOf(this._permissions,S);var M=O<R;var P=T._permissionNames[O];return this._rowTemplate({entity:L,entityPermissions:K.map(this._permissions,function(W,V,a){var Z=T._permissionNames[V];var Y=W===Q;var X=V<R;var U=K.any(a.slice(0,V),H.eq(Q));return{name:W,granted:Y,inherited:U,privileged:X,tooltip:(function(){if(M){return""}else{if(X&&!Y){if(T._isEntityCurrentUser(L)){return T._text.cantGrantSelfHigherPerms(Z)}else{return T._text.cantGrantHigherPerms(Z)}}else{if(U){return T._text.inheritedPerm}else{if(V===T._permissions.length-1){return T._text.implicitPerm}else{return""}}}}}())}}),tooltip:M?T._text.cantRevokeHigherPerms(P):"",showAddedLozenge:N,showRemovePermsButton:N||(O>=R),linkToEntities:J.getCurrentUser()&&J.getCurrentUser().getIsAdmin()})};E.prototype._loadItems=function(){var L=this;this._$spinner.spin("small");if(!this._numLoaded){L._$tbody.empty();L._$noResults.hide()}if(!this._numLoaded&&this._addedEntities.length){L._$tbody.append(K.chain(this._addedEntities).sortBy(function(M){return M[L._entityType].name}).reduce(function(N,M){return N+L._renderRow(M[L._entityType],M.permission,L._currentUserHighestPerm,true)},"").value())}L._dataSource.getMembers({start:L._numLoaded,limit:L._pageSize,avatarSize:stash.widget.avatarSizeInPx({size:"xsmall"})}).done(function(N){if(L.opts.preProcessMembers){N=L.opts.preProcessMembers(N,L._entityType)}L._$spinner.spinStop();L._$loadMore.toggleClass("hidden disabled",N.isLastPage);if(N.values.length){L._$noResults.hide()}else{if(!N.start&&!L._addedEntities.length){L._$noResults.show()}}L._numLoaded+=N.values.length;var O=K.chain(L._addedEntities).pluck(L._entityType).pluck("name").invoke("toLowerCase").value();var M=K.chain(N.values).filter(function(P){var Q=D.inArray(P[L._entityType].name.toLowerCase(),O);if(Q!==-1){L._addedEntities[Q].loaded=true}return Q===-1}).value();if(M.length){L._$tbody.append(K.reduce(M,function(P,Q){return P+L._renderRow(Q[L._entityType],Q.permission,L._currentUserHighestPerm)},""))}L._$noResults.find("div").show()})};E.prototype.refresh=function(L){if(L){this._addedEntities=[]}this._numLoaded=0;K.each(this._addedEntities,function(M){M.loaded=false});this._loadItems()};C.initialise=function(L,M,O,N){return K.map(["user","group"],function(P){return new E("#"+P+"-permissions-table",L,M,P,O,N)})}});