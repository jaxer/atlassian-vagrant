define("feature/permission/multi-selector",["backbone-brace","jquery","underscore","feature/user/group-multi-selector","feature/user/user-multi-selector"],function(D,F,C,E,B){var A={user:B,group:E};function H(I,J){return function(){return C.pluck(I(),J)}}var G=D.View.extend({events:{"click .add-button":"_onClickAdd"},initialize:function(K){var J=this.$el.find(".permission-multi-selector");this._$addButton=this.$el.find(".add-button");var I=A[K.entityType];if(!I){throw"Unknown entity type: "+K.entityType}this._delegate=new I(J,{dataSource:K.dataSource});if(!(C.isFunction(K.add))){throw"must provide an add function"}var L=this.$el.find(".permission-type-dropdown");L.on("click","a",C.bind(this._onSelectPermission,this));this._permission=L.find("li:first-child").attr("data-value");this._delegate.on("change",C.bind(this._onChangeEntitySelection,this));this._onChangeEntitySelection();this.$el.on("keydown",C.bind(function(M){if(M.which===F.ui.keyCode.ENTER&&M.target.tagName==="INPUT"&&this.getSelected().length){M.preventDefault();this._addSelected()}},this))},getSelected:function(){return this._delegate.getSelectedItems()},getPermission:function(){return this._permission},showError:function(J){this.clearError();var I=this._$errors=F("<div></div>");var K=J&&J.errors&&J.errors.length?J.errors:[{message:stash_i18n("stash.web.permission.multiselector.unexpected.error","An unexpected error occurred. Consult your system logs for more information.")}];C.forEach(K,function(L){F('<p class="error-message"></p>').text(L.message).appendTo(I)});I.appendTo(this.$el.children("th"))},clearError:function(){if(this._$errors){this._$errors.remove();this._$errors=null}},clear:function(){this.clearError();this._delegate.clearSelectedItems();this._setAddButtonDisabled(true)},_addSelected:function(){this._setAddButtonDisabled(true);F.when(this.options.add({entities:this.getSelected(),permission:this.getPermission()})).always(C.bind(this._setAddButtonDisabled,this,false)).done(C.bind(this.clear,this)).fail(C.bind(function(L,K,J,I){this.showError(I)},this))},_setAddButtonDisabled:function(I){this._$addButton.toggleClass("disabled",I).prop("disabled",I)},_onClickAdd:function(I){I.preventDefault();this._addSelected()},_onSelectPermission:function(J){J.preventDefault();var I=F(J.target);this._permission=I.closest("li").attr("data-value");this.$el.find(".permission-type-trigger").text(I.text())},_onChangeEntitySelection:function(){this._setAddButtonDisabled(!(this.getSelected().length))}});return G});