define("feature/pull-request/pull-request-activity",["jquery","util/events","underscore","util/ajax","util/navbuilder","util/client-storage","util/scroll","model/page-state","model/commit-range","model/file-change","model/file-content-modes","model/path","widget/paged-scrollable","feature/comments","feature/file-content"],function(C,A,S,F,O,I,N,M,G,L,B,R,E,H,J){function P(T){(this.execute?this:AJS.whenIType(T)).execute(function(){var U=C(".general-comment-form");N.scrollTo(U);U.find("textarea").focus()})}function D(T){T.closest(".diff-comment-activity, .file-comment-activity").remove()}function K(X,V,W,U,T){this._$container=C(X);this.pullRequest=V;this.pullRequestPathComponents={projectKey:M.getProject().getKey(),repoSlug:M.getRepository().getSlug(),pullRequestId:this.pullRequest.getId()};this.fromType=W;this.fromId=U;this.dataLoadedEvent="stash.feature.pullRequestActivity.dataLoaded";this._$spinner=C('<div class="spinner"/>').insertAfter(this._$container);E.call(this,T.scrollableElement||X,{pageSize:25,dataLoadedEvent:this.dataLoadedEvent,autoLoad:"next"})}C.extend(K.prototype,E.prototype);K.prototype.init=function(U){this.renderedDiffFileContents=[];E.prototype.init.call(this,U);this._inited=true;if(!this.loadedRange.isEmpty()){this.renderedDiffFileContents=this.renderedDiffFileContents.concat(K.renderDiffs(this._$container.children(".diff-comment-activity"),U.diffCommentData,new G({pullRequest:this.pullRequest})))}H.bindContext(this._$container,new H.PullRequestAnchor(this.pullRequestPathComponents));var T=this;this._approvalHandler=function(V){T.addApprovalActivity(V.approved,V.user,new Date())};A.on("stash.widget.approve-button.added",this._approvalHandler);A.on("stash.widget.approve-button.removed",this._approvalHandler);A.on("stash.feature.comments.lastCommentDeleted",D);A.on("stash.keyboard.shortcuts.pullrequest.addCommentHandler",P)};K.prototype.reset=function(){A.off("stash.widget.approve-button.added",this._approvalHandler);A.off("stash.widget.approve-button.removed",this._approvalHandler);A.off("stash.feature.comments.lastCommentDeleted",D);A.off("stash.keyboard.shortcuts.pullrequest.addCommentHandler",P);S.chain(this.renderedDiffFileContents).pluck("inlineInfo").pluck("fileContent").invoke("destroy").value();delete this.renderedDiffFileContents;S.invoke(this.fileCommentContexts,"destroy");delete this.fileCommentContexts;H.unbindContext(this._$container);E.prototype.reset.call(this);this.currentTime=undefined;this._inited=false};K.prototype.checkCommentIsNew=function(T){T.isUnread=T.updatedDate>this.lastViewed&&(!M.getCurrentUser()||T.author.name!==M.getCurrentUser().getName());if(T.comments.length){S.each(T.comments,S.bind(this.checkCommentIsNew,this))}};K.prototype.checkCommentActivitiesAreNew=function(U){var T=this;S.each(U,function(V){if(V.action==="COMMENTED"){T.checkCommentIsNew(V.comment)}})};K.prototype.requestData=function(W,T){var U=this;var V=W===0&&!S.isUndefined(this.fromType)&&!S.isUndefined(this.fromId)?{fromType:this.fromType,fromId:this.fromId}:{};this._$spinner.spin("large");return F.rest({url:O.rest().project(this.pullRequestPathComponents.projectKey).repo(this.pullRequestPathComponents.repoSlug).pullRequest(this.pullRequestPathComponents.pullRequestId).activities().withParams(C.extend(V,{start:W,limit:T,avatarSize:stash.widget.avatarSizeInPx({size:"medium"}),markup:true})).build(),statusCode:{"404":function(b,d,Z,c,X){var a=U.fromType==="activity"?stash_i18n("stash.web.pull-request.activity.notfound.title","Activity not found"):stash_i18n("stash.web.pull-request.comment.notfound.title","Comment not found");var Y=U.fromType==="activity"?stash_i18n("stash.web.pull-request.activity.notfound.message","The requested activity does not exist."):stash_i18n("stash.web.pull-request.comment.notfound.message","The requested comment does not exist. It may have been deleted.");return C.extend({},X,{title:a,titleClass:"confirm-header",message:Y,fallbackTitle:stash_i18n("stash.web.pull-request.activity.notfound.fallback.title","Ok"),fallbackUrl:O.project(U.pullRequestPathComponents.projectKey).repo(U.pullRequestPathComponents.repoSlug).pullRequest(U.pullRequestPathComponents.pullRequestId).overview().build(),canClose:false,shouldReload:false})}}}).done(function(Z,b,a){if(!U.currentTime){var Y=new Date(a.getResponseHeader("Date")).getTime(),X=I.buildKey("last-viewed","pull-request");U.currentTime=isNaN(Y)?new Date().getTime():Y;U.lastViewed=I.getItem(X)||U.currentTime;I.setItem(X,U.currentTime)}U.checkCommentActivitiesAreNew(Z.values)}).fail(function(){U._$spinner.spinStop()})};K.prototype.attachContent=function Q(U,T){this._$container[U==="html"?"append":U](T)};K.prototype.decorateForFocus=function(X){var V=this.fromType==="activity";var Y;if(V){var T=parseInt(this.fromId,10);S.some(X.values,function(a,Z){if(a.id===T){a.isFocused=true;Y=T;return true}return false})}else{var U=parseInt(this.fromId,10);var W=function(Z){if(Z.id===U){Z.isFocused=true;return true}else{if(Z.comments){return S.some(Z.comments,function(a){return W(a)})}}return false};S.some(X.values,function(a,Z){if(a.comment&&W(a.comment)){Y=a.id;return true}return false})}return Y};K.prototype.onAttachFirstPermalinkPage=function(X,T){var b=this;var a=C(stash.feature.pullRequest.loadPreviousActivities());this.attachContent(T,a);var V=a.find("a");var Y=a.append(C('<div class="spinner"/>'));var W=X.previousPageStartId,U=X.values[0].id;function Z(){V.hide();Y.spin("large");var c=b.loadedRange.pageBefore(b.options.pageSize);F.rest({url:O.rest().project(b.pullRequestPathComponents.projectKey).repo(b.pullRequestPathComponents.repoSlug).pullRequest(b.pullRequestPathComponents.pullRequestId).activities().withParams(C.extend(c,{avatarSize:stash.widget.avatarSizeInPx({size:"medium"}),markup:true})).build()}).done(function(f,h,g){b.loadedRange.add(f.start,f.size,f.isLastPage,f.nextPageStart);var d;S.any(f.values,function(j,i){if(j.id===U){d=i;return true}});var e=f.values.slice(0,d);b.checkCommentActivitiesAreNew(e);b.attachActivities(e,function(i){a.after(i)});if(f.isFirstPage||b.loadedRange.reachedStart()){V.unbind("click");a.remove();Y.remove()}else{U=W;W=f.previousPageStartId}A.trigger(b.dataLoadedEvent,b,f.start,f.limit,f)}).always(function(){Y.spinStop();V.show()})}V.click(function(c){c.preventDefault();Z()})};K.prototype.attachActivities=function(X,W){var V=this;var Y=0;var T=new G({pullRequest:this.pullRequest});var U=C(S.map(X,function(c){var b=stash.feature.pullRequest.activityListItem({activity:c,pullRequest:V.pullRequest.toJSON(),commitRange:T.toJSON(),isNew:false});Y++;return b}).join(""));var Z=S.reduce(X,function(c,b){c[b.id]=b;return c},{});W(U);this.fileCommentContexts=K.addBreadcrumbsAndBindFileComments(U.filter(".file-comment-activity"),Z,T);var a=K.renderDiffs(U.filter(".diff-comment-activity"),Z,T);this.renderedDiffFileContents=this.renderedDiffFileContents.concat(a);this._$container.find(".pull-request-diff-outdated-lozenge").tooltip({gravity:"ne"});return a};K.prototype.attachNewContent=function(Z,T){var d=this;var U=C("#pull-request-activity > li.comment-form-container");var X=!S.isUndefined(this.fromId)&&!S.isUndefined(this.fromType);var b=this.fromType==="comment";var Y=U.siblings().length===0;var c;if(X&&Y){c=this.decorateForFocus(Z)}if(X&&!Z.isFirstPage&&Y){this.onAttachFirstPermalinkPage(Z,T)}var a=this.attachActivities(Z.values,function(e){d.attachContent(T,e)});this._$spinner.spinStop();if(Z.isLastPage){this._$spinner.remove()}function V(f){if(!d._inited){return }var e=b?C(".comment.focused",f):C(".activity-item.focused",f);if(e.length){N.scrollTo(e,{waitForImages:true,cancelIfScrolled:true,duration:400});return }if(b){A.once("stash.feature.comments.commentContainerAdded",V)}}if(c!=null){var W=S.findWhere(a,{activityId:c});if(W){W.inlineInfo.initPromise.done(V.bind(null,null))}else{V()}}};K.renderDiffForComment=function(a,Y,U){var Z=new J(a);var X=U.getPullRequest().getToRef().getRepository();var T=L.fromDiff(Y.diff,U,X);var W=Y.commentAnchor?(Y.commentAnchor.orphaned===false):true;var V=Z.init(T,undefined,undefined,{commentMode:J.commentMode.REPLY_ONLY,lineComments:[Y.comment],isExcerpt:true,contentMode:B.DIFF,changeTypeLozenge:false,changeModeLozenge:false,fileIcon:true,breadcrumbs:true,scrollPaneSelector:"self",pullRequestDiffLink:true,pullRequestDiffCurrent:W,pullRequestDiffLinkUrl:O.currentPullRequest().diff().change(T.getPath()).build(),toolbarWebFragmentLocationPrimary:"stash.pull-request.activity.diff.toolbar.primary",toolbarWebFragmentLocationSecondary:"stash.pull-request.activity.diff.toolbar.secondary"});return{fileContent:Z,initPromise:V}};K.renderDiffs=function(W,U,T){var V=[];S.each(W,function(Y){var X=Number(Y.getAttribute("data-activityid"));V.push({activityId:X,el:Y,data:U[X]})});return S.map(V,function(X){return{activityId:X.activityId,inlineInfo:K.renderDiffForComment(C(X.el).find(".detail"),X.data,T)}})};K.addBreadcrumbsAndBindFileComments=function(V,U,T){var W=[];V.each(function(){var c=C(this);var Z=c.attr("data-activityid");var a=U[Z];var e=new R(a.commentAnchor.path);var Y=a.commentAnchor?(a.commentAnchor.orphaned===false):true;var d=S.map(e.getComponents(),function(f){return{text:f}});c.find(".breadcrumbs").append(stash.widget.breadcrumbs.crumbs({pathComponents:d,primaryLink:Y?O.currentPullRequest().diff().change(e).build():undefined}));var X=new L({repository:M.getRepository(),commitRange:T,path:e});var b=H.bindContext(c,new H.DiffAnchor(X),{commentMode:H.commentMode.REPLY_ONLY});W.push(b)});return W};K.prototype.addApprovalActivity=function(W,T,V){var U=C("#pull-request-activity .comment-form-container");C(stash.feature.pullRequest.activityApprovalListItem({user:T,action:W?"APPROVED":"UNAPPROVED",activityDate:V})).hide().insertAfter(U).fadeIn("slow")};K.prototype.handleErrors=C.noop;return K});