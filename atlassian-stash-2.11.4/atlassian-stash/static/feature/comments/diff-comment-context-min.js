define("feature/comments/diff-comment-context",["jquery","underscore","util/events","util/function","feature/comments/comment-collection","feature/comments/comment-context","feature/comments/diff-comment-container","feature/comments/anchors","feature/file-content/diff-view-segment-types","feature/file-content/diff-view-file-types"],function(E,I,K,H,C,D,J,A,G,F){var B=A.LineAnchor;return D.extend({events:{"click .line:not(.expanded):not(.conflict-marker) .add-comment-trigger":"addCommentClicked"},initialize:function(){I.bindAll(this,"onDiffChange","onFileCommentsResized");this.setDiffView(this.options.diffView);this._commentsById=this.options.lineComments&&I.indexBy(this.options.lineComments,H.dot("id"));this.$el.toggleClass("commentable",this.options.allowCommenting);this.renderFileComments();D.prototype.initialize.apply(this,arguments);var L=this._getFileCommentContainer();if(L){this._initializeFileCommentContainer(L)}},_initializeFileCommentContainer:function(L){L.on("resize",this.onFileCommentsResized)},_getFileCommentContainer:function(){var M=this.options.anchor;var L=M.getId();if(this.includesContainer(L)){return this._containers[L]}},_registerContainer:function(M,N,L){this._containers[M]=new J({anchor:L,context:this,el:N,name:M});return this._containers[M]},addFileCommentClicked:function(){var L=this.addCommentContainerForFile();L.openNewCommentForm()},addCommentClicked:function(N){N.preventDefault();var M=E(N.target).closest(".line");var L=this.addCommentContainerForLine(M);L.openNewCommentForm()},addCommentContainerForFile:function(){var M=this._getFileCommentContainer();if(M){return M}var L=E(stash.feature.comments(this.options.anchor.toJSON()));L.appendTo(this.$(".file-comments"));this.registerContainer(L[0],this.options.anchor);M=this._getFileCommentContainer();this._initializeFileCommentContainer(M);return M},addCommentContainerForLine:function(P,L){var O=this.getLineAnchor(P);var N=P.lineType?P:this.diffView.getLineHandle(P);var M=O.getId();if(!this.includesContainer(M)){this._containers[M]=new J({anchor:O,collection:L?new C(L,{anchor:O}):undefined,context:this,lineHandle:N,name:M})}return this._containers[M]},destroy:function(L){if(!L){if(this.diffView){this.diffView.off("change",this.onDiffChange)}this.$el.removeClass("commentable")}D.prototype.destroy.apply(this,arguments)},findContainerElements:function(){return this.$(".line .comment-box, .file-comments > .comment-container")},getAnchor:function(L){if(E(L).closest(".file-comments").length){return this.options.anchor}return this.getLineAnchor(E(L).closest(".line"))},getGutterId:function(){return this.options.allowCommenting?"add-comment-trigger":null},getLineAnchor:function(M){var L=M.lineType?M:this.diffView.getLineHandle(M);return new B(this.options.anchor,L.lineType,L.lineNumber,L.fileType)},renderFileComments:function(){var L=this.options.anchor.toJSON().commitRange;this.$el.prepend(stash.feature.fileComments({comments:this.options.fileComments,commitRange:L}))},addAnchoredComments:function(){var L=this;var O=this.diffView;var N=this.options.lineComments;if(N&&N[0]&&!N[0].anchor){return }function M(P){return I.chain(P).filter(function(Q){return !!(Q.anchor&&Q.anchor.line)}).groupBy(function(Q){return(Q.anchor.fileType||"")+Q.anchor.line}).value()}I.forEach(M(N),function(P){var Q=P[0].anchor;var R=O.getLineHandle({fileType:Q.fileType,lineType:Q.lineType,lineNumber:Q.line});if(R){L.addCommentContainerForLine(R,P)}})},onFileCommentsResized:function(){this.trigger("fileCommentsResized")},onDiffChange:function(N){if(N.type!=="INITIAL"&&N.type!=="INSERT"){return }if(N.type==="INITIAL"){this.addAnchoredComments()}var M=this.diffView;var L=this;N.eachLine(function(S){var Q=S.line;var R;var T=Q.lineType==="ADDED"||Q.lineType==="REMOVED";var O=!S.attributes.expanded||T;if(O&&(L.options.allowCommenting&&N.type==="INITIAL")){R=stash.feature.addCommentTrigger()}else{R=stash.feature.dummyCommentTrigger({relevantContextLines:L.options.relevantContextLines})}if(S.handles.FROM){M.setGutterMarker(S.handles.FROM,L.getGutterId(),E(R)[0])}if(S.handles.TO&&S.handles.FROM!==S.handles.TO){M.setGutterMarker(S.handles.TO,L.getGutterId(),E(R)[0])}if(Q.commentIds){var P=I.chain(Q.commentIds).map(H.lookup(L._commentsById)).filter(I.identity).value();if(P.length){L.addCommentContainerForLine(S.handles.FROM||S.handles.TO,P)}}if(L.unrestoredDrafts.length&&N.type==="INITIAL"){I.chain(S.handles).compact().uniq().forEach(L.restoreDraftsForLine.bind(L))}})},restoreDraftsForLine:function(L){var N=E.extend({line:L.lineNumber,lineType:L.lineType},{fileType:L.fileType});var M=this.getUnrestoredDraftsForLine(N);if(M.length){this._restoreDraftsToContainer(this.addCommentContainerForLine(L),M)}},_restoreDraftsToContainer:function(L,M){I.forEach(M,L.restoreDraftComment.bind(L));this.unrestoredDrafts=I.difference(this.unrestoredDrafts,M)},restoreDrafts:function(){var L=this;if(!this.options.allowCommenting){this.unrestoredDrafts=I.filter(this.unrestoredDrafts,function(M){return(M.id||M.parent)&&(L.$el.is(".file-comment-activity")||M.anchor.line)})}this.restoreDraftFileComments()},restoreDraftFileComments:function(){var L=I.reject(this.unrestoredDrafts,function(M){return M.anchor.line});if(L.length){this._restoreDraftsToContainer(this.addCommentContainerForFile(),L)}},getUnrestoredDraftsForLine:function(N){var M=I.compose(H.partialRight(I.omit,"path","srcPath"),this.unifyAnchorFileTypes);var O=I.isEqual.bind(I,M(N));var L=I.compose(O,M,H.dot("anchor"));return I.filter(this.unrestoredDrafts,L)},unifyAnchorFileTypes:function(M){var N=((M.lineType===G.CONTEXT||M.lineType===G.REMOVED)&&M.fileType===F.FROM);var L=(M.lineType===G.ADDED&&M.fileType===F.TO);if(N||L){return I.omit(M,"fileType")}return M},clarifyAmbiguousDraftProps:function(M){var L=D.prototype.clarifyAmbiguousDraftProps.call(this,M);L.anchor=this.unifyAnchorFileTypes(L.anchor);return L},setDiffView:function(L){if(this.diffView){this.diffView.off("change",this.onDiffChange)}this.diffView=L;if(L){this.diffView.on("change",this.onDiffChange)}}})});