define("widget/markup-preview",["jquery","underscore","util/ajax","util/dom-event","util/events","util/navbuilder","widget/keyboard-shortcuts","exports"],function(I,N,M,E,O,A,H,G){function K(P){return M.rest({type:"POST",url:A.rest().markup().preview().build(),data:P,dataType:"json"})}function L(U,P,R,Q){U.addClass("rendering");Q.spin("medium");var S=U.data("preview");if(!S.request){var T=P.val();P.attr("disabled","disabled");S.request=K(T).done(function(V){R.html(V.html);U.addClass("previewing");if(S.callback){S.callback()}}).fail(function(){S.request=null;D(U)}).done(function(){S.request=null;U.removeClass("rendering")}).always(function(){Q.spinStop()})}}function D(Q){Q.removeClass("rendering previewing");var P=Q.data("preview");if(P){if(P.request){P.request.abort()}P.text.removeAttr("disabled");if(Q.is(":not(.collapsed)")&&P.text.is(":visible")){P.text.focus()}if(P.callback){P.callback()}}}function B(P){return P.is(".rendering, .previewing")}function J(S,P,R,Q){return function(T){T.preventDefault();if(B(S)){D(S)}else{L(S,P,R,Q)}}}var F={trigger:".preview-button",text:"textarea",preview:".preview-markup",spinner:".preview-spinner"};G.defaults=F;G.bindTo=function(S,Q){var P=I(S);Q=I.extend({},F,Q);N.each(Q,function(V,U){if(V&&N.isString(V)){Q[U]=P.find(V)}});if(!P.data("preview")){var R=J(P,Q.text,Q.preview,Q.spinner);var T={handler:R,tooltip:{close:function(){}}};P.data("preview",I.extend(T,Q));Q.preview.on("click",R);Q.trigger.on("click",R);if(C){T.tooltip=H.addTooltip(Q.trigger,C);P.on("keydown.markup.preview",function(U){if(String.fromCharCode(U.which).toLowerCase()==="p"&&E.isCtrlish(U)&&U.shiftKey){R(U);if(B(P)){Q.trigger.focus()}else{Q.text.focus()}}else{if(E.isCtrlish(U)&&U.which===I.ui.keyCode.ENTER){P.submit()}}})}}};G.hideIfVisible=function(Q){var P=I(Q);if(B(P)){D(P)}};G.unbind=function(Q){var P=I(Q);this.hideIfVisible(P);var R=P.data("preview");if(R){R.preview.off("click",R.handler);R.trigger.off("click",R.handler);P.off("keydown.markup.preview");R.tooltip.remove();P.removeData("preview")}};var C="ctrl+shift+p";O.on("stash.keyboard.shortcuts.requestPreviewComment",function(P){C=P})});