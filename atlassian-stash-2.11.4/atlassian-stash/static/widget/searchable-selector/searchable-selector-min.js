define("widget/searchable-selector",["aui","jquery","underscore","util/ajax","util/dom-event","util/events","util/promise","widget/paged-scrollable","widget/keyboard-controller"],function(L,D,M,K,H,N,B,J,G){var C=G.TabKeyboardController;var E=G.ListKeyboardController;var I=0;function F(P,O){return this.init.apply(this,arguments)}F.prototype.defaults={id:null,extraClasses:null,namespace:"searchable-selector",url:null,tabs:null,searchable:true,searchPlaceholder:null,queryParamKey:"filter",queryParamsBuilder:null,pageSize:20,statusCodeHandlers:{},followLinks:false,hideDialogOnSelect:true,itemSelectedEvent:"stash.widget.searchableSelector.itemSelected",context:null,field:null,itemDataKey:"item",template:stash.widget.searchableSelector,resultsTemplate:stash.widget.searchableSelectorResults,noResultsText:null,noMoreResultsText:null,triggerContentTemplate:stash.widget.searchableSelectorTriggerContent,triggerPlaceholder:null,preloadData:null,alwaysShowPreload:false,dataTransform:null,postOptionsInit:null,clearResultsOnSearch:true,popUpOffsetX:0,popUpOffsetY:-1};F.constructDataPageFromPreloadArray=function(O){if(!M.isArray(O)){return null}return{values:O,isLastPage:false,size:O.length,start:0,limit:O.length}};F.prototype.tabOptionKeys=["label","url","resultsTemplate","noResultsText","noMoreResultsText","dataTransform","queryParamKey","preloadData","searchPlaceholder"];F.prototype.init=function(Q,P){var O=this;this.instanceId=I++;this.$trigger=D(Q);this.setOptions(P);this.scrollables=[];this.scrollableDataStores=[];if(!this._getOptionVal("id")){this.options.id=this._getOptionVal("namespace")+"-"+this.instanceId}if(this.options.tabs&&this.options.tabs.length){this.tabs=M.map(this.options.tabs,function(U){return D.extend(true,{},M.pick(O.options,O.tabOptionKeys),U)})}var T=this._getOption("postOptionsInit");if(M.isFunction(T)){T.call(this)}var S;this.blockShortcutPropagation=S=function(U){var V=(this===document);if(U.keyCode===D.ui.keyCode.ESCAPE){U[V?"stopImmediatePropagation":"stopPropagation"]();O.dialog.hide()}else{if(!V){U.stopPropagation()}}};var R=O._getOptionVal("externalSearchField");this.dialog=L.InlineDialog(this.$trigger,this._getOptionVal("id"),function(V,U,W){if(!V.data("initialised")){O._initialiseDialogContent(V)}W();if(!R){M.defer(M.bind(O.setFocus,O))}},{offsetX:this._getOptionVal("popUpOffsetX"),offsetY:this._getOptionVal("popUpOffsetY"),noBind:!!R,hideCallback:function(){if(O.$content.is(document.activeElement)||D.contains(O.$content[0],document.activeElement)){O.$trigger.focus()}D(document).add(O.dialog).off("keydown keypress",S)},initCallback:function(){D(document).add(O.dialog).on("keydown keypress",S)}});if(this._getOptionVal("searchable")&&R){this.$searchField=D(R);this._initialiseSearchOnInput()}if(this.$trigger.find(".name").length){this._selectedItem=this._getItemFromTrigger()}L.bind("hide.dialog",function(V,U){if(O.$trigger.closest(U.dialog.popup.element).length){O.dialog.hide()}});return this};F.prototype.getSelectedItem=function(){return this._selectedItem};F.prototype.setSelectedItem=function(O){if(D.isPlainObject(O)&&O.id!=null){if(!this._selectedItem||this._selectedItem.id!==O.id){this._itemSelected(O)}}};F.prototype.clearSelection=function(){this._selectedItem=null;if(this._getOptionVal("field")){D(this._getOptionVal("field")).val("")}this.resetTrigger()};F.prototype._getItemFromTrigger=function(){var O=this.$trigger.find(".name");return D.extend({},this._buildObjectFromElementDataAttributes(O),{name:O.text()})};F.prototype._buildObjectFromElementDataAttributes=function(O){return D(O).data(this._getOptionVal("itemDataKey"))};F.prototype._initialiseDialogContent=function(P){var O=this;var Q=this._getOptionVal("searchable");var R=this._getOptionVal("externalSearchField");P.append(this._getOption("template")({id:this._getOptionVal("id"),tabs:this.tabs,searchable:!R&&Q,searchPlaceholder:this._getOptionVal("searchPlaceholder"),extraClasses:this._getOptionVal("extraClasses")}));P.closest(".aui-inline-dialog").addClass("searchable-selector-dialog");if(Q&&!R){this.$searchField=P.find("input.filter");this._initialiseSearchOnInput()}if(this.tabs){var S=P.find("ul.tabs-menu a");S.on("tabSelect",function(U,T){O.currentTabId=T.tab.parent().data("tab-id");if(O._getOptionVal("searchable")||O._getDataStoreForScrollable().length===0){O._populateScrollable()}O._resultsKeyboardController.setListElement(O._getCurrentScrollable().$scrollElement.find("ul.results-list"));if(Q){O.$searchField.focus()}O._updateSearchPlaceholder()});S.on("click",function(T){if(D(this).parent().hasClass("active-tab")){T.stopPropagation();T.preventDefault()}});S.on("keydown",function(U){if(U.keyCode===D.ui.keyCode.ENTER){var T=D(this);if(T.parent("li").hasClass("active-tab")){U.preventDefault()}else{T.click()}}});L.tabs.setup()}P.find(".results").each(function(){O.scrollables.push(O._createScrollable(D(this)));O.scrollableDataStores.push([])});P.on("click",".result a",function(T){O.selectItem(T,D(this))});this._initialiseKeyboardNavigation(P);this._populateScrollable();this.$content=P;P.data("initialised",true)};F.prototype._initialiseSearchOnInput=function(){var P=this;var Q=this._getSearchTerm();var R=this._getOptionVal("externalSearchField");var S=B.delay(M.bind(this._handleSearchInput,this),350);var O=M.bind(function(){if(Q!==(Q=this._getSearchTerm())){if(!this._pendingSearch){this._pendingSearch=S(Q);this._pendingSearch.always(function(){P._pendingSearch=null})}else{this._pendingSearch.reset(Q)}}},this);this.$searchField.on("keydown.searchable-selector input.searchable-selector",M.bind(function(T){if(R){if(T.which===D.ui.keyCode.ESCAPE){this._pendingSearch&&this._pendingSearch.abort()}else{if(T.which===D.ui.keyCode.DOWN&&this._shouldSearch(Q)){this.dialog.show()}else{if(T.which===D.ui.keyCode.ENTER&&!this.dialog.is(":visible")){this._pendingSearch&&this._pendingSearch.done(function(){var U=P._getCurrentScrollable().$scrollElement.find("ul.results-list li.result:first");P._clickItem(U)})}}}}M.defer(O)},this))};F.prototype._handleSearchInput=function(O){var P=this._getOptionVal("externalSearchField");if(P){if(this._shouldSearch(O)){if(!this.dialog.is(":visible")){this.dialog.show()}return this._populateScrollable()}else{this.dialog.hide();return D.Deferred().reject().promise()}}else{return this._populateScrollable()}};F.prototype._initialiseKeyboardNavigation=function(Q){var R=this;var P;var S=false;var O=function(U){var V=R.dialog.is(":visible");if(R._getOptionVal("externalSearchField")&&!V){return }if(S&&!V){R.$trigger.click()}else{R._clickItem(U)}};if(this._resultsKeyboardController){this._resultsKeyboardController.destroy()}if(this.$searchField){P=this.$searchField}else{if(this.tabs){P=Q.find("ul.tabs-menu")}else{P=this.$trigger;S=true}}var T=R._getCurrentScrollable().$scrollElement.find("ul.results-list");this._resultsKeyboardController=new E(P,T,{wrapAround:false,focusedClass:"focused",itemSelector:"li.result",requestMore:function(){var U=R._getCurrentScrollable().loadAfter();return U&&U.then(function(V){return V.isLastPage})},onSelect:function(U){if(R._pendingSearch){R._pendingSearch.done(function(){var V=T.find("li.result:first");if(V.length){O(V)}})}else{O(U)}},focusIntoView:true,adjacentItems:R._getOptionVal("adjacentItems")});if(this._tabKeyboardController){this._tabKeyboardController.destroy()}if(D.browser.mozilla||D.browser.webkit){Q.addClass("override-focus-style")}this._tabKeyboardController=new C(Q)};F.prototype._clickItem=function(O){O.children("a").each(function(){this.click()})};F.prototype.setFocus=function(){if(this.$searchField){this.$searchField.focus()}else{if(this.tabs){this.$content.find("ul.tabs-menu a").first().focus()}else{this.$trigger.focus()}}};F.prototype._createScrollable=function(O){var P=new J(O,{pageSize:this._getOptionVal("pageSize"),bufferPixels:0,preventOverscroll:true});P.requestData=M.bind(this.getResults,this,P);P.attachNewContent=M.bind(this.addResultsToList,this,P,false);return P};F.prototype._populateScrollable=function(P){P=P||this._getCurrentScrollable();this._emptyScrollable(P);var O=this._getPreloadData();var R=0;if(O){R=this.addResultsToList(P,true,O)}var Q=P.init();if(R>0){return D.Deferred().resolve().promise()}else{return Q}};F.prototype._getPreloadData=function(){var P=this._getOptionVal("preloadData");var Q=this._getSearchTerm();if(P&&(this._getOptionVal("alwaysShowPreload")||Q==="")){var O=this._getOption("dataTransform");if(M.isFunction(O)){P=O.call(this,P,Q)}}else{P=null}return P};F.prototype._emptyScrollable=function(O){O=O||this._getCurrentScrollable();O.reset();this._getDataStoreForScrollable(O).length=0;if(this._getOptionVal("clearResultsOnSearch")){O.$scrollElement.children("ul.results-list").empty()}};F.prototype._getCurrentScrollable=function(){return this.scrollables[this.tabs&&this.currentTabId?this.currentTabId:0]};F.prototype._getDataStoreForScrollable=function(P){if(!P){return this.scrollableDataStores[this.tabs&&this.currentTabId?this.currentTabId:0]}var O=M.indexOf(this.scrollables,P);if(O!==-1){return this.scrollableDataStores[O]}else{return null}};F.prototype._getSearchTerm=function(){return(this.$searchField)?this.$searchField.val():""};F.prototype._updateSearchPlaceholder=function(){if(this.$searchField){this.$searchField.attr("placeholder",this._getOptionVal("searchPlaceholder"))}};F.prototype._getOptionVal=function(O){return this._getOption(O,true)};F.prototype._getOption=function(O,Q){var P;if(this.tabs&&M.contains(this.tabOptionKeys,O)){P=this.tabs[this.currentTabId||0][O]}else{P=this.options[O]}return(Q)?A(P,this):P};F.prototype.setOptions=function(O){this.options=D.extend(true,{},this.defaults,O)};F.prototype.getResults=function(T,V,O){var P=this;if(this.currentXHR&&this.currentXHR.abort){this.currentXHR.abort()}var S=this._getOption("queryParamsBuilder")||this._defaultQueryParamsBuilder;var R=S.call(this,this._getSearchTerm(),V,O);if(R===null){return D.Deferred().reject().promise()}var U=T.$scrollElement.children("ul.results-list");this._showSpinner(T);U.scrollTop(U[0].scrollHeight);var Q=this.currentXHR=K.rest({url:this._getOptionVal("url"),data:R,statusCode:this._getOptionVal("statusCodeHandlers")});Q.always(function(){P._hideSpinner(T);P.currentXHR=null});return Q};F.prototype._showSpinner=function(O){O.$scrollElement.children(".spinner").show().spin()};F.prototype._hideSpinner=function(O){O.$scrollElement.children(".spinner").spinStop().hide()};F.prototype._shouldSearch=function(O){var P=this._getOption("queryParamsBuilder")||this._defaultQueryParamsBuilder;return P.call(this,O,0,this._getOptionVal("pageSize"))!=null};F.prototype._defaultQueryParamsBuilder=function(P,R,O){var Q={start:R,limit:O};if(this._getOptionVal("searchable")){Q[this._getOptionVal("queryParamKey")]=P}return Q};F.prototype.addResultsToList=function(U,P,S){var W=this._getOption("dataTransform");var V;if(M.isFunction(W)){S=W.call(this,S,this._getSearchTerm())}if(!P&&(V=this._getPreloadData())){S=this.dedupeData(S,V)}S=D.extend({},S,{isPreload:P,noResultsText:this._getOptionVal("noResultsText"),noMoreResultsText:this._getOptionVal("noMoreResultsText")});var T=D(this._getOption("resultsTemplate")(S));var R=this._getDataStoreForScrollable(U);R.push.apply(R,S.values);var Q=U.$scrollElement.children("ul.results-list");var O=S.start===0&&!(V&&V.size>0)&&(!P||S.size>0);if(O){Q.empty()}Q.append(T).attr("data-last-updated",new Date().getTime());if(O&&S.size>0){this._resultsKeyboardController.moveToNext()}return S.size};F.prototype.dedupeData=function(P,O){if(P&&P.values&&O&&O.values){P=D.extend(true,{},P);P.values=M.reject(P.values,function(Q){return M.find(O.values,function(R){return Q.id===R.id})})}return P};F.prototype.selectItem=function(Q,P){var R=P.data("id");var O=M.find(this._getDataStoreForScrollable(),function(S){return S.id===R});if(P.attr("href")!=="#"&&(this._getOptionVal("followLinks")||!H.openInSameTab)){}else{Q.preventDefault()}if(!this._selectedItem||this._selectedItem.id!==O.id){this._itemSelected(O)}if(this._getOptionVal("hideDialogOnSelect")){this.dialog.hide()}};F.prototype._itemSelected=function(O){this._selectedItem=O;if(this._getOptionVal("field")){D(this._getOptionVal("field")).val(O.id)}this.updateTrigger({item:O});N.trigger(this._getOptionVal("itemSelectedEvent"),this,O,this._getOptionVal("context"))};F.prototype.updateTrigger=function(O){if(!this._getOptionVal("externalSearchField")){this.$trigger.html(this._getOption("triggerContentTemplate")(O||{}))}};F.prototype.resetTrigger=function(){this.updateTrigger({text:this._getOptionVal("triggerPlaceholder")})};F.prototype.destroy=function(){if(this.blockShortcutPropagation){D(document).add(this.dialog).off("keydown keypress",this.blockShortcutPropagation)}if(this._getOptionVal("externalSearchField")){this.$searchField.off(".searchable-selector")}if(this.dialog){this.dialog.hide();this.dialog.remove();this.dialog=null}if(this._resultsKeyboardController){this._resultsKeyboardController.destroy();this._resultsKeyboardController=null}if(this._tabKeyboardController){this._tabKeyboardController.destroy();this._tabKeyboardController=null}this.$trigger=null;this.scrollables=null;this.scrollableDataStores=null;this.tabs=null;this._initialiseDialogContent=D.noop};function A(P,O){return M.isFunction(P)?P.call(O):P}return F});