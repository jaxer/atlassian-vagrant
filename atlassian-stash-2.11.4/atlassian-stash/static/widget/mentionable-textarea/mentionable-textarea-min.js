define("widget/mentionable-textarea",["aui","aui/progressive-dataset","backbone","jquery","underscore","xregexp","util/events","util/navbuilder","model/page-state","model/stash-user","widget/autocomplete-dialog"],function(G,J,H,B,I,E,L,C,F,D,K){function A(){this.init.apply(this,arguments)}A.defaults={$container:B(document.body),selector:"textarea",dialogId:"mention-autocomplete-dialog"};A.prototype.init=function(N){var M=this;if(this.options){this.reset()}this.options=B.extend({},A.defaults,N);var O=[];if(F.getPullRequest()){O=I.map([F.getPullRequest().getAuthor()].concat(F.getPullRequest().getReviewers().models,F.getPullRequest().getParticipants().models),function(P){return P.getUser()})}else{if(F.getCommitParticipants&&F.getCommitParticipants()){O=F.getCommitParticipants().pluck("user")}}this.datasource=new J(O,{queryEndpoint:C.rest().users().build(),queryParamKey:"filter",queryData:{avatarSize:stash.widget.avatarSizeInPx({size:"small"})},maxResults:5,model:D,matcher:this.matcher});this.datasource.parse=function(P){return P.values};this.datasource.getFilteredResults=function(Q){var P=this.filter(function(R){return(!!this.matcher(R,Q))},this);if(this._maxResults){P=I.first(P,this._maxResults)}return P};I.bindAll(this,"onKeyDown","onKeyPress","onPaste","onDocumentClick","updateDialogAnchorPosition","updateResults","onActivity","selectItem","highlightMatches");this.datasource.on("respond",this.updateResults);this.datasource.on("activity",this.onActivity);this.isMentioningSelector=I.map(this.options.selector.split(","),function(P){return B.trim(P)+".isMentioning"}).join(", ");this.options.$container.on("keypress",this.options.selector,this.onKeyPress);this.options.$container.on("keydown",this.isMentioningSelector,this.onKeyDown);this.options.$container.on("paste",this.isMentioningSelector,this.onPaste)};A.prototype.onKeyDown=function(M){if(!this.dialog){return }switch(M.which){case B.ui.keyCode.ENTER:case B.ui.keyCode.TAB:this.selectHighlightedItem();M.preventDefault();break;case B.ui.keyCode.UP:this.dialog.moveSelectionUp();M.preventDefault();break;case B.ui.keyCode.DOWN:this.dialog.moveSelectionDown();M.preventDefault();break;case B.ui.keyCode.ESCAPE:this.endAutocomplete();M.preventDefault();M.stopPropagation();break;case B.ui.keyCode.BACKSPACE:case B.ui.keyCode.DELETE:this.onKeyPress(M);break}};A.prototype.onKeyPress=function(M){if(M.which){I.defer(I.bind(function(N){var O=B(N.target);if(!O.hasClass("isMentioning")){if(String.fromCharCode(N.which)==="@"){this.beginAutocomplete(O)}}else{this.updateAutocomplete()}},this),M)}};A.prototype.onPaste=function(){I.defer(I.bind(this.updateAutocomplete,this))};A.prototype.onDocumentClick=function(P){var O=P.target;var M=[];this.$textarea&&M.push(this.$textarea);this.dialog&&M.push(this.dialog.$el);var N=I.any(M,function(Q){return Q.is(O)||B.contains(Q[0],O)});if(!N){this.endAutocomplete()}};A.prototype.beginAutocomplete=function(N){var M=N.getSelection().start-1;if(M>0&&/^\w$/.test(N.val().substr(M-1,1))){return }this.$textarea=N;this.$textarea.addClass("isMentioning");this.mentionTriggerPos=M;this.resultsCollection=new H.Collection();this.dialog=new K({id:this.options.dialogId,collection:this.resultsCollection,minZIndex:this.options.$container.css("z-index"),anchor:this.getCaretDocumentCoordinates(this.$textarea),template:stash.widget.mentionableTextarea.dialog,highlighter:this.highlightMatches});this.dialog.on("itemSelected",this.selectItem);L.on("window.resize.debounced",this.updateDialogAnchorPosition);B(document).on("click focusin mousedown",this.onDocumentClick);this.updateAutocomplete()};A.prototype.updateAutocomplete=function(){if(!this.$textarea){return }this.currentCaretPos=this.$textarea.getSelection().start;var M=this.$textarea.val().substring(this.mentionTriggerPos,this.currentCaretPos);if(!M||M.indexOf("@")!==0||M.indexOf("\n")!==-1){this.endAutocomplete()}else{M=M.substr(1);this.datasource.query(M)}};A.prototype.updateDialogAnchorPosition=function(){I.defer(I.bind(function(){if(this.dialog&&this.$textarea){this.dialog.updateAnchorPosition(this.getCaretDocumentCoordinates(this.$textarea))}},this))};A.prototype.updateResults=function(M){if(this.resultsCollection){this.resultsCollection.query=M.query;this.resultsCollection.reset(M.results)}};A.prototype.onActivity=function(M){this.dialog&&this.dialog.toggleSpinner(M.activity)};A.prototype.endAutocomplete=function(){if(this.$textarea){this.$textarea.removeClass("isMentioning");this.$textarea=null}this.mentionTriggerPos=undefined;this.currentCaretPos=undefined;if(this.dialog){this.dialog.off("itemSelected",this.selectItem);this.dialog.remove();this.dialog=null}this.resultsCollection=null;L.off("window.resize.debounced",this.updateDialogAnchorPosition);B(document).off("click focusin mousedown",this.onDocumentClick)};A.prototype.selectHighlightedItem=function(){this.selectItem(this.dialog.getSelectedItemIndex())};A.prototype.selectItem=function(O){var N=this.resultsCollection.at(O);if(N){var M=this.escapeUsername(N.getName()),S=this.$textarea.val(),R=S.substring(0,this.mentionTriggerPos+1),Q=S.substring(this.currentCaretPos,S.length),P=R.length+M.length+1;if(Q.charAt(0)!==" "){Q=" "+Q}this.$textarea.val(R+M+Q);this.$textarea.setSelection(P,P)}this.endAutocomplete()};A.prototype.matcher=function(N,O){if(F.getCurrentUser()&&N.getName()===F.getCurrentUser().getName()){return false}var M=E.cache("(\\b|^|[^\\p{L}\\p{N}])"+E.escape(O),"i"),P=[N.getName(),N.getEmailAddress(),N.getDisplayName()];return I.any(P,function(Q){return !!(Q&&M.test(Q))})};A.prototype.getMatchParts=function(P,O){var N=E.cache("(^|.*?(\\b|\\())("+E.escape(O)+")(.*)","i"),M={text:P};if(P.toLowerCase().indexOf(O.toLowerCase())>-1){P.replace(N,function(R,T,S,Q,U){M={prefix:T,match:Q,suffix:U}})}return M};A.prototype.highlightMatches=function(M,O){var N=this;M.find(".avatar-with-name, .email-address").each(function(){var P=B(this).contents().filter(function(){return this.nodeType===3}),Q=I.reduce(N.getMatchParts(P.text(),O),function(R,S,T){return R+((T==="match")?"<b>"+G.escapeHtml(S)+"</b>":G.escapeHtml(S))},"");P.replaceWith(Q)});return M};A.prototype.getCaretDocumentCoordinates=function(O){var M=O.offset(),N=O.getCaretPosition();N.top+=M.top;N.left+=M.left;return N};A.prototype.escapeUsername=function(M){if(/^\w*$/.test(M)){return M}else{return'"'+M.replace(/"/g,'\\"')+'"'}};A.prototype.reset=function(){this.destroy();delete this.options;delete this.datasource;delete this.$textarea;delete this.dialog;delete this.resultsCollection;delete this.mentionTriggerPos;delete this.currentCaretPos};A.prototype.destroy=function(){if(this.dialog){this.dialog.off("itemSelected",this.selectItem);this.dialog.remove()}this.datasource.off("respond",this.updateResults);this.datasource.off("activity",this.onActivity);this.options.$container.off("keypress",this.options.selector,this.onKeyPress);this.options.$container.off("keydown",this.isMentioningSelector,this.onKeyDown);this.options.$container.off("paste",this.isMentioningSelector,this.onPaste);L.off("window.resize.debounced",this.updateDialogAnchorPosition);B(document).off("click focusin mousedown",this.onDocumentClick)};return A});