define("widget/searchable-multi-selector",["aui","jquery","underscore","util/ajax","util/events","util/function","util/promise"],function(L,H,M,K,N,J,D){function B(Q,P){this._$field=Q;P=this._options=H.extend(true,{},this.defaults,P);if(!(P.dataSource)){if(P.url){P.dataSource=new E(P.url,P.urlParams)}else{throw"either a dataSource or url must be supplied"}}P.dataSource=new G(P.dataSource,P.debounceInterval);if(!(M.isFunction(P.selectionTemplate))){throw"a selectionTemplate must be a function"}if(!(M.isFunction(P.resultTemplate))){throw"a resultTemplate must be a function"}this._selectedItems=[];this._initialItems=P.initialItems.slice(0);this._excludedIds=M.map(P.excludedItems,P.generateId);I(this)}H.extend(true,B.prototype,N.createEventMixin("stash.widget.searchable.multi.selector"),{defaults:{minimumInputLength:1,extraClasses:null,dropdownClasses:null,debounceInterval:300,initialItems:[],excludedItems:[],urlParams:{},hasAvatar:false,inputTooShortTemplate:function(){return L.escapeHtml(stash_i18n("stash.web.multi.selector.help","Start typing to search"))},noMatchesTemplate:function(){return L.escapeHtml(stash_i18n("stash.web.multi.selector.no.match","No matches found"))},generateId:function(P){return P.id||P.name},generateText:function(P){return P.displayName||P.name}},getSelectedItems:function(){return M.pluck(this._selectedItems,"item")},setSelectedItems:function(P){this._initialItems=P.slice(0);this._$field.auiSelect2("val",M.map(P,this._options.generateId))},clearSelectedItems:function(){this.setSelectedItems([])}});function E(Q,P){this._url=Q;this._urlParams=P;this.clear();this._pageReceived=M.bind(this._pageReceived,this)}E.prototype.clear=function(){this._nextPageStart=0};E.prototype.nextPage=function(P){return K.rest({url:this._url,data:H.extend({},this._urlParams,{start:this._nextPageStart,filter:P})}).done(this._pageReceived)};E.prototype._pageReceived=function(P){this._nextPageStart=P.nextPageStart||(P.start+P.size)};B.PagedDataSource=E;function G(P,Q){this.clear=M.bind(P.clear,P);this.nextPage=D.delay(M.bind(P.nextPage,P),Q)}function A(P){var Q=H(".select2-drop-active > .select2-results");if(!Q.length){return }if(Q.children(".select2-result-selectable").length===0&&Q.children(".select2-disabled").length){H('<li class="select2-no-results"></li>').html(P._options.noMatchesTemplate()).appendTo(Q)}}function C(P,Q){return{id:P.generateId(Q),text:P.generateText(Q),item:Q}}function O(Q,P){return M.reject(Q,function(R){return(R.id===P.id)})}function F(P){P&&P.abort&&P.abort()}function I(Q){var R=Q._options;var S=Q._$field;var T=Q._excludedIds;var U=M.bind(C,null,R);var P=[];S.auiSelect2({hasAvatar:R.hasAvatar,query:function(V){if(V.page<=1){R.dataSource.clear();M.forEach(P,F);P=[]}var W=R.dataSource.nextPage(H.trim(V.term));W=W.then(function(X){return{results:M.chain(X.values).map(U).filter(function(Y){return M.indexOf(T,Y.id)===-1}).value(),more:!(X.isLastPage)}}).promise(W);P.push(W);W.always(function(){P=M.reject(P,J.eq(W))}).done(V.callback)},formatSelection:function(V){return R.selectionTemplate(V.item)},formatResult:function(V){return R.resultTemplate(V.item)},initSelection:function(W,X){var V=M.map(Q._initialItems,U);Q._selectedItems=V;X(V)},separator:"|!|",multiple:true,minimumInputLength:R.minimumInputLength,formatInputTooShort:R.inputTooShortTemplate,formatNoMatches:R.noMatchesTemplate,containerCssClass:["searchable-multi-selector",R.extraClasses].join(" "),dropdownCssClass:["searchable-multi-selector-dropdown",R.dropdownClasses].join(" "),openOnEnter:false}).on("change",function(V){if(V.removed){Q._selectedItems=O(Q._selectedItems,V.removed)}if(V.added){Q._selectedItems.push(V.added)}Q.trigger("change")}).on("open",M.bind(A,null,this))}return B});