define("widget/keyboard-shortcuts",["aui","jquery","underscore","util/events","exports"],function(H,D,J,K,B){var E=navigator.platform.indexOf("Mac")!==-1,L=/^[cC]trl$/i,I="\u2318";var A={};function G(M){if(!(this instanceof G)){return new G(M,registry)}this._$trigger=M;this._dialog=new H.Dialog({width:830,height:580,id:"keyboard-shortcut-dialog",closeOnOutsideClick:true});this._bind();this._enabledContexts=[]}G.prototype._setRegistry=function(M){this._registry=M};G.prototype._initContent=function(){this._dialog.addHeader(stash_i18n("stash.web.keyboardshortcuts.header","Keyboard Shortcuts"));this._dialog.addPanel("",stash.widget.keyboardShortcutsContent({contextNames:J.keys(A),contexts:J.values(A)}));this._dialog.addCancel(stash_i18n("stash.web.button.close","Close"),function(M){M.hide()})};G.prototype._bind=function(){var M=this;this._$trigger.on("click",function(N){M._show();N.preventDefault()})};G.prototype.enableContext=function(M){if(D.inArray(M,this._enabledContexts)!==-1){return }this._registry.enableContext(M);this._enabledContexts.push(M)};G.prototype.resetContexts=function(){H.trigger("remove-bindings.keyboardshortcuts");this._enabledContexts=[];H.trigger("add-bindings.keyboardshortcuts")};G.prototype._show=function(){if(!this._hasShown){this._initContent();this._hasShown=true}this._dialog.show();this._dialog.updateHeight();this._dialog.getCurrentPanel().body.find(".keyboard-shortcut-help").focus()};G.prototype.addCustomShortcut=function(N,P,O,Q){var M=C({keys:P,context:N,displayContext:Q,description:O},{convertOSModifier:false})};G.convertOSModifier=function(M){return(E)?M.replace(L,I):M};function C(M,N){M=D.extend({},M);M.keys=J.map(M.keys,function(O){return J.map(O,function(P){if(J.all(["key","modifiers"],J.partial(J.has,P))){return P}var Q=(P.length>1)?P.split("+"):P;if(!J.isArray(Q)||Q.length===1){return P}return{key:Q.pop(),modifiers:N&&N.convertOSModifier===false?Q:J.map(Q,G.convertOSModifier)}})});if(!M.displayContext){M.displayContext=G._contextDisplayInfo[M.context]?G._contextDisplayInfo[M.context].displayName:M.context.replace(/\b[a-z]/g,function(O){return O.toUpperCase()})}if(!A[M.displayContext]){A[M.displayContext]=[]}A[M.displayContext].push(M)}G.internalizeShortcuts=function(M){J.each(M,C)};G._contextDisplayInfo={branch:{displayName:stash_i18n("keyboard.shortcuts.context.repository","Within A Repository")},"branch-list":{displayName:stash_i18n("keyboard.shortcuts.context.branch-list","Branch list")},changeset:{displayName:stash_i18n("keyboard.shortcuts.context.changeset","Changeset")},commits:{displayName:stash_i18n("keyboard.shortcuts.context.commits","Commit List")},"diff-tree":{displayName:stash_i18n("keyboard.shortcuts.context.diff-tree","Changeset")},"diff-view":{displayName:stash_i18n("keyboard.shortcuts.context.diff-view","Diff View")},filebrowser:{displayName:stash_i18n("keyboard.shortcuts.context.filebrowser","Directory Browsing")},global:{displayName:stash_i18n("keyboard.shortcuts.context.global","Global")},"pull-request":{displayName:stash_i18n("keyboard.shortcuts.context.pull-request","Within A Pull Request")},"pull-request-list":{displayName:stash_i18n("keyboard.shortcuts.context.pull-request-list","Pull Request List")},"pull-request-overview":{displayName:stash_i18n("keyboard.shortcuts.context.pull-request","Within A Pull Request")},sourceview:{displayName:stash_i18n("keyboard.shortcuts.context.sourceview","Source View")}};var F;B.onReady=function(){F=new G(D(".keyboard-shortcut-link"));var M=D.Deferred();D(document).ready(function(){setTimeout(function(){M.resolve()},0)});H.bind("register-contexts.keyboardshortcuts",function(O,N){F._setRegistry(N.shortcutRegistry);F.enableContext("global");M.done(function(){K.trigger("stash.widget.keyboard-shortcuts.register-contexts",F,F)})});H.bind("shortcuts-loaded.keyboardshortcuts",function(O,N){G.internalizeShortcuts(N.shortcuts)});H.params["keyboardshortcut-hash"]="bundled";H.trigger("initialize.keyboardshortcuts")};B.addTooltip=function(N,P){var M=J(P.split("+")).chain().map(G.convertOSModifier).map(function(Q){if(Q==="shift"){return stash_i18n("stash.keyboard-shortcuts.key.shift","Shift")}else{if(Q==="ctrl"){return G.convertOSModifier(stash_i18n("stash.keyboard-shortcuts.key.ctrl","Ctrl"))}else{return Q}}}).value().join(" + ");var O=N.attr("title");N.attr("title",O+stash_i18n("stash.keyboard-shortcuts.type"," (Type ''{0}'')",M));return{remove:function(){N.attr("title",O)}}};B.showDialog=function(){if(F){F._show()}}});