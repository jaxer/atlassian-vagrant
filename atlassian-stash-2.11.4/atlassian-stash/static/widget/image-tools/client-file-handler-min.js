define("widget/image-tools/client-file-handler",["jquery","underscore"],function(C,B){function A(D){return this.init(D)}A.typeFilters={all:/.*/,application:/^application\/.*/,audio:/^audio\/.*/,image:/^image\/.*/,imageWeb:/^image\/(jpeg|png|gif)$/,text:/^text\/.*/,video:/^video\/.*/};A.prototype.defaults={fileTypeFilter:A.typeFilters.all,fileCountLimit:Infinity,fileSizeLimit:20*1024*1024,onSuccess:C.noop,onError:C.noop};A.prototype.init=function(D){this.options=C.extend({},this.defaults,D);if(D&&!D.fileSizeLimit){this.options.fileSizeLimit=this.defaults.fileSizeLimit}if(D&&!D.fileCountLimit){this.options.fileCountLimit=this.defaults.fileCountLimit}B.bindAll(this,"handleFiles","filterFiles");return this};A.prototype.handleFiles=function(F,E){var D=this.filterFiles(F);if(D.valid.length>0){B.isFunction(this.options.onSuccess)&&this.options.onSuccess(D.valid)}else{B.isFunction(this.options.onError)&&this.options.onError(D.invalid)}};A.prototype.filterFiles=function(E){var H=B.isRegExp(this.options.fileTypeFilter)?this.options.fileTypeFilter:this.defaults.fileTypeFilter,D=this.options.fileSizeLimit,G={byType:[],bySize:[],byCount:[]},F=B.filter(E,function(I){if(!H.test(I.type)){G.byType.push(I);return false}if(I.size>D){G.bySize.push(I);return false}return true});if(F.length>this.options.fileCountLimit){G.byCount=F.slice(this.options.fileCountLimit);F=F.slice(0,this.options.fileCountLimit)}return{valid:F,invalid:G}};return A});