define("widget/image-tools/image-upload-and-crop",["jquery","underscore","widget/image-tools/image-explorer","widget/image-tools/client-file-reader","widget/image-tools/drag-drop-file-target","widget/image-tools/client-file-iframe-uploader","widget/image-tools/upload-interceptor","widget/image-tools/canvas-cropper","util/text"],function(E,H,J,F,G,I,A,B,D){function C(L,K){if(!C.isSupported()){throw new Error("This browser doesn't support ImageUploadAndCrop.")}this.init.apply(this,arguments)}C.isSupported=function(){return B.isSupported()};C.prototype.defaults={HiDPIMultiplier:2,dragDropUploadPrompt:stash_i18n("stash.web.drag.drop.image.prompt","Drag and drop image here"),onImageUpload:E.noop,onImageUploadError:E.noop,onCrop:E.noop,outputFormat:"image/png",fallbackUploadOptions:{},initialScaleMode:J.scaleModes.containAndFill,scaleMax:1,fileSizeLimit:5*1024*1024,maxImageDimension:2000};C.prototype.init=function(N,M){this.options=E.extend({},this.defaults,M);this.$container=N;H.bindAll(this,"crop","resetState","_onFileProcessed","setImageSrc","validateImageResolution","_onFilesError","_onFileError","_resetFileUploadField","_onErrorReset");this.imageExplorer=new J(this.$container.find(".image-explorer-container"),{initialScaleMode:this.options.initialScaleMode,scaleMax:this.options.scaleMax,onErrorReset:this._onErrorReset});if(F.isSupported()){this.clientFileReader=new F({onRead:this._onFileProcessed,onError:this._onFilesError,fileTypeFilter:F.typeFilters.imageWeb,fileCountLimit:1,fileSizeLimit:this.options.fileSizeLimit});this.dragDropFileTarget=new G(this.imageExplorer.get$ImageView(),{uploadPrompt:this.options.dragDropUploadPrompt,clientFileHandler:this.clientFileReader})}else{this.$container.addClass("filereader-unsupported");var L=E.extend({onUpload:this._onFileProcessed,onError:this._onFileError},this.options.fallbackUploadOptions);this.clientFileReader=new I(L)}this.uploadIntercepter=new A(this.$container.find(".image-upload-field"),{replacementEl:this.$container.find(".image-upload-field-replacement"),clientFileHandler:this.clientFileReader});var K=this.imageExplorer.get$Mask();this.canvasCroppper=new B(K.width()*this.options.HiDPIMultiplier,K.height()*this.options.HiDPIMultiplier,{outputFormat:this.options.outputFormat});this.options.cropButton&&E(this.options.cropButton).click(this.crop)};C.prototype.crop=function(){var L=this.imageExplorer.getMaskedImageProperties(),K=this.canvasCroppper.cropToDataURI(this.imageExplorer.get$SourceImage()[0],L.maskedAreaImageX,L.maskedAreaImageY,L.maskedAreaWidth,L.maskedAreaHeight);H.isFunction(this.options.onCrop)&&this.options.onCrop(K)};C.prototype.resetState=function(){this.imageExplorer.clearError();this._resetFileUploadField()};C.prototype._onFileProcessed=function(L){if(L){if(!isNaN(this.options.maxImageDimension)){var K=this.validateImageResolution(L);K.done(H.bind(function(N,M){this.setImageSrc(L)},this)).fail(H.bind(function(N,M){this._onFileError(stash_i18n("stash.web.avatar.error.file.resolution","The selected image size is {0}px * {1}px. The maximum allowed image size is {2}px * {2}px",N,M,this.options.maxImageDimension))},this))}else{this.setImageSrc(L)}}else{this._onFileError()}};C.prototype.setImageSrc=function(K){this.imageExplorer.setImageSrc(K);H.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(K);this._resetFileUploadField()};C.prototype.validateImageResolution=function(N){var K=E.Deferred(),M=new Image(),L=this;M.onload=function(){if(this.naturalWidth>L.options.maxImageDimension||this.naturalHeight>L.options.maxImageDimension){K.reject(this.naturalWidth,this.naturalHeight)}else{K.resolve(this.naturalWidth,this.naturalHeight)}};M.src=N;return K};C.prototype._onFilesError=function(L){if(L&&L.bySize&&L.bySize.length){var K=H.first(L.bySize);this._onFileError(AJS.escapeHtml(stash_i18n("stash.stash.web.avatar.error.file.too.big",'File "{0}" is {1} which is larger than the maximum allowed size of {2}',D.abbreviateText(K.name,50),D.formatSizeInBytes(K.size),D.formatSizeInBytes(this.options.fileSizeLimit))))}else{this._onFileError()}};C.prototype._onFileError=function(K){var M=stash_i18n("stash.web.avatar.error.adding.file.title","There was an error uploading your image"),L=K||stash_i18n("stash.web.avatar.error.adding.file.contents","Please check that your file is a valid image and try again.");this.imageExplorer.showError(M,L);this._resetFileUploadField();H.isFunction(this.options.onImageUploadError)&&this.options.onImageUploadError(K)};C.prototype._resetFileUploadField=function(){var K=this.$container.find("#image-upload-and-crop-upload-field").prop("form");K&&K.reset()};C.prototype._onErrorReset=function(K){if(K){H.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(K)}};return C});