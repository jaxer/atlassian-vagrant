define("widget/image-tools/client-file-iframe-uploader",["jquery","underscore","widget/image-tools/client-file-handler"],function(D,B,A){function C(E){return this.init(E)}D.extend(C.prototype,A.prototype);C.prototype.defaults=D.extend({},A.prototype.defaults,{uploadURL:"",uploadFieldName:"file",onUpload:D.noop,responseHandler:function(F,G){var E;try{E=JSON.parse(D(F).html())}catch(H){G.reject()}if(E){G.resolve(E)}else{G.reject()}}});C.prototype.states={IN_PROGRESS:"IN_PROGRESS",IDLE:"IDLE"};C.prototype.init=function(E){B.bindAll(this,"createHiddenIframe","onIframeLoad","handleFiles","setStateInProgress","setStateIdle","cancelUpload");this.options=D.extend({},this.defaults,E);this.$uploadIframe=this.createHiddenIframe();if(this.options.cancelTrigger){this.$cancelTrigger=D(this.options.cancelTrigger);this.$cancelTrigger.click(B.bind(function(){this.cancelUpload()},this))}this.state=this.states.IDLE;return this};C.prototype.createHiddenIframe=function(){return D("<iframe>").attr("name","hidden-upload-iframe").hide().appendTo(document.body).on("load",this.onIframeLoad)};C.prototype.onIframeLoad=function(E){if(this.state===this.states.IN_PROGRESS){this.requestPromise.done(this.options.onUpload).fail(this.options.onError);this.options.responseHandler(E.target.contentDocument.body,this.requestPromise)}};C.prototype.handleFiles=function(F,E){if(this.state===this.states.IN_PROGRESS){this.cancelUpload()}if(!this.$fileSourceElem){this.$fileSourceElem=D(E);this.$fileSourceElem.attr("name",this.options.uploadFieldName);if(!this.$fileSourceElem.prop("form")){this.$fileSourceElem.wrap("<form>")}var G=D(this.$fileSourceElem.prop("form"));G.addClass("hidden-upload-form").attr("action",this.options.uploadURL).attr("method","post").attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").attr("target",this.$uploadIframe.attr("name"));this.$spinner=D('<div class="spinner"></div>').insertBefore(this.$fileSourceElem);if(D.isPlainObject(this.options.extraData)){B.each(this.options.extraData,function(I,H){D('<input type="hidden">').attr("name",H).val(I).appendTo(G)})}}this.$fileSourceElem.prop("form").submit();this.requestPromise=D.Deferred();this.requestPromise.always(this.setStateIdle);this.setStateInProgress()};C.prototype.setStateInProgress=function(){this.state=this.states.IN_PROGRESS;if(this.$spinner){this.$spinner.spin()}if(this.$fileSourceElem){this.$fileSourceElem.attr("disabled","disabled")}};C.prototype.setStateIdle=function(){this.state=this.states.IDLE;if(this.$spinner){this.$spinner.spinStop()}if(this.$fileSourceElem){this.$fileSourceElem.removeAttr("disabled")}this.requestPromise=null};C.prototype.cancelUpload=function(){this.$uploadIframe.remove();this.setStateIdle();this.$uploadIframe=this.createHiddenIframe()};return C});