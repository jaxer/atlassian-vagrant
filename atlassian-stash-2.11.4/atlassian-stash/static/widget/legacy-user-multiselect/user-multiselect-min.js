define("widget/user-multiselect",["aui","underscore","util/ajax","util/deprecation","util/navbuilder","widget/user-multiselect-commons"],function(B,C,F,E,G,D){function A(){return B.escapeHtml(stash_i18n("stash.web.user-multiselect.nomatch","No matching user found"))}function H(M,L,J,K){var N,I=this;this._initialUsers=L;this._$textfield=M;this._selectedUsers=[];var O=0;M.select2(N={ajax:{transport:function(P){var Q=P.success;delete P.success;return F.rest.apply(F,arguments).done(Q).done(function(){D.showNoResultsIfAllDisabled(A)})},url:K||G.rest().users().build(),data:function(P,Q){return{filter:D.filterSearchTerm(P),start:Q>1?O:0,limit:D.fetchLimit,avatarSize:D.avatarSize}},results:function(Q,P){O=Q.nextPageStart;var R=C.chain(Q.values).map(function(S){return{id:S.name,text:S.displayName,user:S}});if(J&&J.length){R=R.reject(function(S){return C.indexOf(J,S.user.name)>=0})}Q.values=R.value();Q.size=Q.values.length;return{more:!Q.isLastPage,results:Q.values}}},formatSelection:function(P){return D.formatUserSelection(P.user)},formatResult:function(P){return D.formatUserResult(P.user)},initSelection:function(P,R){var Q=[];C.each(I._initialUsers,function(S){Q.push({id:S.name,text:S.displayName||S.name,user:S})});I._selectedUsers=Q;R(Q)},separator:"|!|",multiple:true,minimumInputLength:D.minimumInputLength,formatInputTooShort:D.formatInputTooShort,formatNoMatches:A,containerCssClass:D.containerCssClass,dropdownCssClass:D.dropdownCssClass,quietMillis:D.quietMillis}).on("change",C.bind(this.updateSelectedUsers,this))}H.prototype.getSelectedUsers=function(){return this._selectedUsers};H.prototype.clearSelected=function(){this._initialUsers=[];this._$textfield.auiSelect2("val",[])};H.prototype.updateSelectedUsers=function(I){if(I.removed){this._selectedUsers=C.reject(this._selectedUsers,function(J){return(J.id===I.removed.id)})}if(I.added){this._selectedUsers.push(I.added)}};return E.construct(H,"widget/user-multiselect","feature/user/user-multi-selector","2.5","3.0")});