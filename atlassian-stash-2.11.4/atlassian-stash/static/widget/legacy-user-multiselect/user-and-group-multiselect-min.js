define("widget/user-and-group-multiselect",["aui","jquery","underscore","util/ajax","util/deprecation","util/navbuilder","widget/user-multiselect-commons"],function(K,D,L,J,F,A,I){function H(M){return{id:"user:"+M.name,text:M.displayName||M.name,user:M}}function C(M){return{id:"group:"+M,text:M,group:{name:M,displayName:M}}}function B(M,N){return M.id&&M.id.indexOf(N)===0}function G(){return K.escapeHtml(stash_i18n("stash.web.user-and-group-multiselect.nomatch","No matching users or groups found"))}function E(P,O,S,N){var M=this;var R=0,Q=0;this._initialUsers=O;this._initialGroups=S;this._$textfield=P;this._selectedUsers=[];this._selectedGroups=[];function T(V,U){if(V===U){return 0}else{if(!V.text){return -1}else{if(!U.text){return 1}}}return V.text.toLowerCase().localeCompare(U.text.toLowerCase())}P.select2({query:function(W){if(W.page<=1){R=0;Q=0}var U={filter:I.filterSearchTerm(W.term),limit:I.fetchLimit};var X;if(R!==null){X=J.rest({url:A.rest().users().build(),data:D.extend(true,{},U,{start:W.page>1?R:0,avatarSize:I.avatarSize})}).then(function(Y){R=Y.isLastPage?null:Y.nextPageStart;return Y.values})}else{X=[]}var V;if(Q!==null){V=J.rest({url:A.rest().groups().build(),data:D.extend(true,{},U,{start:W.page>1?Q:0})}).then(function(Y){Q=Y.isLastPage?null:Y.nextPageStart;return Y.values})}else{V=[]}D.when(X,V).then(function(a,Y){var Z=L.map(a,H).concat(L.map(Y,C));if(N&&N.length){Z=L.reject(Z,function(b){return B(b,"user")&&L.indexOf(N,b.user.name)>=0})}W.callback({results:Z.sort(T),more:!!(R||Q)})})},formatSelection:function(U){if(B(U,"user")){return I.formatUserSelection(U.user)}else{if(B(U,"group")){return I.formatGroupSelection(U.group)}else{throw new Error("unknown entity "+JSON.stringify(U))}}},formatResult:function(U){if(B(U,"user")){return I.formatUserResult(U.user)}else{if(B(U,"group")){return I.formatGroupResult(U.group)}else{throw new Error("unknown entity "+JSON.stringify(U))}}},initSelection:function(V,X){var W=L.map(M._initialUsers,H);var U=L.map(M._initialGroups,C);M._selectedUsers=W;M._selectedGroups=U;X([].concat(W,U))},separator:"|!|",multiple:true,minimumInputLength:I.minimumInputLength,formatInputTooShort:I.formatInputTooShort,formatNoMatches:G,containerCssClass:I.containerCssClass,dropdownCssClass:I.dropdownCssClass,quietMillis:I.quietMillis}).on("change",L.bind(this.updateSelectedEntities,this)).on("open",function(){I.showNoResultsIfAllDisabled(G)})}E.prototype.getSelectedUsers=function(){return L.pluck(this._selectedUsers,"user")};E.prototype.getSelectedGroups=function(){return L.pluck(this._selectedGroups,"group")};E.prototype.setSelected=function(M){this._initialUsers=M.users;this._initialGroups=M.groups;this._$textfield.auiSelect2("val",L.pluck(M.users,"name").concat(M.groups))};E.prototype.clearSelected=function(){this.setSelected({users:[],groups:[]})};E.prototype.updateSelectedEntities=function(M){if(M.removed){this.removeFromEntityList(M.removed)}if(M.added){this.addToEntityList(M.added)}};E.prototype.addToEntityList=function(M){if(B(M,"user")){return this._selectedUsers.push(M)}else{if(B(M,"group")){return this._selectedGroups.push(M)}else{throw new Error("can not add invalid entity "+M)}}};E.prototype.removeFromEntityList=function(M){var N=function(O){return L.reject(O,function(P){return(P.id===M.id)})};if(B(M,"user")){this._selectedUsers=N(this._selectedUsers)}else{if(B(M,"group")){this._selectedGroups=N(this._selectedGroups)}else{throw new Error("can not remove invalid entity "+M)}}};return F.construct(E,"widget/user-and-group-multiselect","feature/user/user-and-group-multi-selector","2.5","3.0")});