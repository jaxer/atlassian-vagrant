define("widget/branch-selector",["jquery","underscore","util/events","aui","util/ajax","util/function","util/navbuilder","util/deprecation","widget/paged-scrollable","model/revision-reference","widget/keyboard-controller"],function(E,N,O,L,K,I,C,H,J,B,G){var D=G.TabKeyboardController,F=G.ListKeyboardController;var M=function(P,R,Q){this._updateUrls(P,R);this._pageSize=10;this._options=Q||{};this._mode=M.type.BRANCH};M.prototype={init:function(R){this._context=R||document;var P=this;this._wireComponents();L.tabs.change(E("#branch-selector-tab-"+this._mode.id));this.changeMode(this._mode);this.reset();var S=this._textInput,Q=S.val();this._textInput.on("keypress.branch-selector",function(T){if(T.which>0){P._resultsKeyboardController.blur()}});this._textInput.on("keyup.branch-selector",N.debounce(function(){if(Q!==(Q=S.val())){P.populateBranchList()}},350));this._tagTab.add(this._branchTab).append("<div class='spinner'/>").on("click","a",function(V){var U=E(this),W=U.parent();var T=new B({id:W.attr("data-id"),displayId:E.trim(U.text()),latestChangeset:W.attr("data-csid"),type:P._mode.id,isDefault:W.attr("data-default")==="true"});O.trigger("stash.widget.branchselector.revisionRefChanged",P,T,P._options.context);V.preventDefault()});this._tabMenu.on("tabSelect.branch-selector","a",function(U,T){P.changeMode(M.type.from(T.tab.data("type")));P.populateBranchList()});this._tabMenu.on("click.branch-selector",".active-tab a",function(T){T.preventDefault()});this._tabMenu.on("keydown.branch-selector",".menu-item a",function(T){if(T.keyCode===E.ui.keyCode.ENTER){if(E(this).parent("li").hasClass("active-tab")){T.preventDefault()}else{E(this).click()}}})},reset:function(){this._textInput.off(".branch-selector");this._tagTab.add(this._branchTab).off(".branch-selector");this._tabMenu.off(".branch-selector")},_requestBranchList:function(U,P){var R=this._getSearchData(this._getSearchTerm());R=E.extend(R,{start:U,limit:P});var S=this._refList.children(".spinner").show().spin();this._refList.scrollTop(this._refList[0].scrollHeight);var Q=this;if(this.currentXHR){this.currentXHR.abort()}var T=this.currentXHR=K.rest({url:this._urls[this._mode.id],data:R,statusCode:K.ignore404WithinRepository()}).always(function(){S.spinStop().hide();Q.currentXHR=null});return T},_getSearchData:function(P){if(P){return{filterText:P}}return{}},_getBranchList:function(){return this._refScrollable.init()},_getBranchListElement:function(){return this._refList.find("ul.branch-list")},changeMode:function(P){this._mode=P;this._refList=M.type.isBranch(P)?this._branchTab:this._tagTab;this._refScrollable=M.type.isBranch(P)?this._branchScrollable:this._tagScrollable;this._textInput.attr("placeholder",P.filterText);this._resultsKeyboardController.setListElement(this._refList);this.focusFilter()},_createScrollable:function(R){var P=this,Q=new J(R,{pageSize:this._pageSize,bufferPixels:0});Q.requestData=function(T,S){return P._requestBranchList(T,S)};Q.attachNewContent=function(V){if(!P._options.disableLinks){var U=C.parse(window.location.href);N.each(V.values,function(W){var X=U.clone();if(W.isDefault){X.deleteQueryParam("at")}else{X.replaceQueryParam("at",W.displayId)}W.url=X.toString()})}var T=E(stash.widget.branchSelectorItems({branchesPage:V,branchSelectorType:P._mode.id,isFirstPage:V.start===0})),S=P._getBranchListElement();S.append(T);if(V.start===0){P._resultsKeyboardController.moveToNext()}};return Q},_getSearchTerm:function(){return this._textInput.val()},_wireComponents:function(){var P=this;L.tabs.setup();this._tabMenu=E(".tabs-menu",this._context);this._textInput=E("input",this._context);this._branchTab=E("#branch-pane",this._context);this._tagTab=E("#tag-pane",this._context);this._branchScrollable=this._createScrollable(this._branchTab);this._tagScrollable=this._createScrollable(this._tagTab);if(this._resultsKeyboardController){this._resultsKeyboardController.destroy()}this._resultsKeyboardController=new F(this._textInput,this._refList,{wrapAround:false,focusedClass:"focused",itemSelector:"li.result",requestMore:function(){var R=P._refScrollable.loadAfter();return R&&R.then(I.dot("isLastPage"))},onSelect:function(R){R.children("a").click()},focusIntoView:true});if(this._tabKeyboardController){this._tabKeyboardController.destroy()}var Q=E.browser.mozilla||E.browser.webkit;if(Q){this._context.addClass("override-focus-style")}this._tabKeyboardController=new D(this._context)},clearBranchList:function(){this._getBranchListElement().empty()},populateBranchList:function(){this.clearBranchList();this._getBranchList()},focusFilter:function(){this._textInput.focus()},setProjectAndRepo:function(P,Q){this._updateUrls(P,Q);O.trigger("stash.widget.branchselector.repoChanged",this,P,Q,this._options.context)},_updateUrls:function(P,Q){this._urls={tag:C.rest().project(P).repo(Q).tags().build(),branch:C.rest().project(P).repo(Q).branches().build()}}};var A=M.type={TAG:{id:"tag",name:stash_i18n("stash.web.revisionref.tags.name","Tag"),filterText:stash_i18n("stash.web.filebrowser.branchselector.tags.placeholder","Search tags")},BRANCH:{id:"branch",name:stash_i18n("stash.web.revisionref.branches.name","Branch"),filterText:stash_i18n("stash.web.filebrowser.branchselector.branches.placeholder","Search branches")},isTag:function(P){return P===A.TAG||P===A.TAG.id},isBranch:function(P){return P===A.BRANCH||P===A.BRANCH.id},from:function(P){if(A.isTag(P)){return A.TAG}else{if(A.isBranch(P)){return A.BRANCH}}L.log("Unknown BranchSelector type "+P);return null}};return H.construct(M,"widget/branch-selector","feature/repository/revision-reference-selector or feature/repository/branch-selector","2.4","3.0")});