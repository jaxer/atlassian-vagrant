define("widget/avatar-picker-dialog",["jquery","underscore","widget/image-tools/image-upload-and-crop","util/navbuilder","util/text"],function(C,A,F,E,B){function D(G){if(!D.isSupported()){throw new Error("This browser doesn't support AvatarPickerDialog.")}return this.init(G)}D.isSupported=function(){return F.isSupported()};D.prototype.defaults={dialogTitle:stash_i18n("stash.web.avatar.picker.title","Upload an avatar"),dialogOptions:{width:384,height:610,id:"avatar-picker-dialog",closeOnOutsideClick:false,keypressListener:C.noop},onCrop:C.noop,trigger:null};D.prototype.init=function(G){A.bindAll(this,"initDialogContent","_onImageUpload","_onImageUploadError","_toggleDoneButtonEnabled","chooseAvatar","hide","show");this.options=C.extend(true,{},this.defaults,G);this.$dialog=new AJS.Dialog(this.options.dialogOptions);this.initDialogContent();this._toggleDoneButtonEnabled(false);this.imageUploadAndCrop=new F(this.$dialog.getCurrentPanel().body.find(".image-upload-and-crop-container"),{HiDPIMultiplier:1,onCrop:this.options.onCrop,onImageUpload:this._onImageUpload,onImageUploadError:this._onImageUploadError,fallbackUploadOptions:{uploadURL:E.tmp().avatars().build(),uploadFieldName:"avatar",responseHandler:function(L,M){var K=C(L),J=K.find("#json-response");if(J.length){var I;try{I=JSON.parse(J.html())}catch(N){M.reject()}if(I&&I.url){M.resolve(I.url)}else{M.reject()}}else{var H=K.find(".error-image + h2").text();H=H.replace(/; nested exception.*$/,".").replace(/(\d+) bytes/,function(O,P){return B.formatSizeInBytes(P)});M.reject(H)}},cancelTrigger:this.$doneButton.add(this.$cancelButton)}});if(this.options.trigger){this.$trigger=C(this.options.trigger);this.$trigger.click(A.bind(function(H){H.preventDefault();this.show()},this))}return this};D.prototype.initDialogContent=function(){this.$dialog.addHeader(this.options.dialogTitle).addPanel().addSubmit("Done",this.chooseAvatar).addCancel("Cancel",this.hide).getCurrentPanel().body.append(stash.widget.imageTools.imageUploadAndCrop({description:stash_i18n("stash.web.avatar.picker.instructions","JPG, GIF or PNG image"),fallbackDescription:stash_i18n("stash.web.avatar.picker.instructions.fallback","JPG, GIF or PNG image up to 1MB in size")}));this.$doneButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-submit-button");this.$cancelButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-cancel-link")};D.prototype._onImageUpload=function(){this._toggleDoneButtonEnabled(true)};D.prototype._onImageUploadError=function(){this._toggleDoneButtonEnabled(false)};D.prototype._toggleDoneButtonEnabled=function(G){if(G==null){G=this.$doneButton.attr("disabled")!=null}if(G){this.$doneButton.removeAttr("disabled")}else{this.$doneButton.attr("disabled","disabled")}};D.prototype.chooseAvatar=function(){this.imageUploadAndCrop.crop();this.hide()};D.prototype.hide=function(){this.$dialog.hide();this.imageUploadAndCrop.resetState()};D.prototype.show=function(){this.$dialog.show()};return D});