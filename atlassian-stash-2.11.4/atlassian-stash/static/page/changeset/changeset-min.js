define("page/changeset/changeset",["jquery","underscore","memoir","util/events","layout/page-scrolling-manager","util/navbuilder","model/page-state","model/revision","model/commit-range","model/participant","model/participant-collection","model/stash-user","widget/unwatch-notification","feature/changeset/tree-and-diff-view","feature/comments","feature/discussion/participants-list","feature/watch","exports"],function(I,g,U,C,G,a,Q,N,J,O,d,V,F,D,K,e,b,f){var B="ROOT";var c,A,M,P;var Z,L;function E(h){L.each(function(){var k=I(this);var i=k.find("a");var j=i.attr("data-id")===h.getId();k.toggleClass("selected",j);if(j){Z.text(k.find(".changesetid").text())}})}function W(h){P=Object.prototype.hasOwnProperty.call(M,h)?M[h]:A[0];E(P)}function T(h){var i=a.currentRepo().changeset(c.getId()).withParams({to:h}).build();U.pushState(null,null,i)}function S(h){return a.parse(window.location.href).getQueryParamValue("to")||(h.length&&h[0].getId())||B}function Y(){var i=S(A);var h=i&&i!==P.getId();if(h){C.stop();W(i);D.updateCommitRange(new J({untilRevision:c,sinceRevision:P}))}}function X(){C.on("stash.widget.keyboard-shortcuts.register-contexts",function(h){h.enableContext("changeset");h.enableContext("diff-tree");h.enableContext("diff-view")});C.on("stash.keyboard.shortcuts.requestReturnToCommits",function(h){(this.execute?this:AJS.whenIType(h)).execute(function(){window.location.href=I("#repository-nav-commits").attr("href")})})}function H(){var k=Q.getChangeset();var h=a.rest().currentRepo().commit(k.getId()).watch().build();var i=I(".watch a");var j=new b(i,h,b.type.COMMIT);Q.getCommitParticipants().on("add",function(m){var l=Q.getCurrentUser();if(l&&l.getName()===m.getUser().getName()){j.setIsWatching(true)}})}function R(h){C.on("stash.feature.comments.commentAdded",function(j){var i=new V(j.author);if(i.getEmailAddress()!==Q.getChangeset().getAuthor().emailAddress&&!h.findByUser(i)){h.add(new O({user:i}))}});new e(h,I(".participants-dropdown ul"),I(".participants.plugin-item"))}f.onReady=function(t,x,q,u,r,w,y,k,o){var p=new d(g.reject(k,function(i){return i.user.emailAddress===y.author.emailAddress}));Q.extend("isWatching");Q.extend("commitParticipants");Q.setCommitParticipants(p);var m=I.Deferred();_PageDataPlugin.ready("com.atlassian.stash.stash-web-plugin:iswatching-provider","stash.page.changeset",function(i){Q.setIsWatching(i.isWatching);m.resolve(i.isWatching)});c=new N(t);Q.setRevisionRef(c.getRevisionReference());Q.setChangeset(c);A=g.map(x,function(i){return new N(i)});M={};if(A.length){for(var n=0,j=A.length,v;n<j;n++){v=A[n];M[v.getId()]=v}}else{M[B]=new N({id:B})}var h=I(".changeset-metadata-diff-to");L=h.find(".aui-dropdown2 .changeset-list-item");Z=h.find(".aui-dropdown2-trigger");if(U.nativeSupport()){L.click(function(z){z.preventDefault();var i=I(this);var l=i.find("a").attr("data-id");L.removeClass("selected").addClass("unselected");i.addClass("selected").removeClass("unselected");if(l!==P.getId()){T(l)}})}C.on("memoir.changestate",Y);G.acceptScrollForwardingRequests();if(!U.nativeSupport()){I(window).hashchange(Y)}W(S(A));D.init(new J({untilRevision:c,sinceRevision:P}),{maxChanges:q,relevantContextLines:u,numberOfParents:A.length,toolbarWebFragmentLocationPrimary:"stash.changeset.diff.toolbar.primary",toolbarWebFragmentLocationSecondary:"stash.changeset.diff.toolbar.secondary",commentMode:Q.getCurrentUser()?K.commentMode.CREATE_NEW:K.commentMode.NONE});X();I(r+" .plugin-section-primary").append(stash.page.changesetRelatedEntityWebPanels({project:w,changeset:y}));I(r+" .plugin-section-secondary").append(stash.page.changesetExtrasWebSectionsAndPanels({project:w,changeset:y}));if(Q.getCurrentUser()){R(p);m.done(H)}if(o){var s={dialogTitle:stash_i18n("stash.web.commit.unwatched.header","Stopped watching commit {0}",Q.getChangeset().getDisplayId()),dialogText:stash_i18n("stash.web.commit.unwatched.content","Notifications for this commit will no longer be sent to you.")};I(window).load(F.bind(null,s))}}});