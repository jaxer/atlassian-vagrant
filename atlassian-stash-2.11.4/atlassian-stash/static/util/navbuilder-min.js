define("util/navbuilder",["aui","jquery","underscore","lib/jsuri","util/deprecation","model/page-state","exports"],function(Ap,BQ,A1,X,A6,K,p){function B(Bj,Bk,Bi){this.components=(A1.isString(Bj)?[Bj]:Bj)||[];this.params=Bk||{};this.anchor=Bi||undefined}B.prototype.buildRelNoContext=function(){var Bj="/"+A1.map(this.components,encodeURIComponent).join("/");var Bk=A1.reduce(this.params,function(Bm,Bl,Bn){if(!(A1.isArray(Bl))){Bl=[Bl]}A1.forEach(Bl,function(Bo){Bm.push({key:Bn,value:Bo})});return Bm},[]);var Bi=A1.map(Bk,function(Bm){var Bl=encodeURIComponent(Bm.value);return encodeURIComponent(Bm.key)+(Bl?"="+Bl:"")}).join("&");return Bj+(Bi?"?"+Bi:"")+(this.anchor?"#"+this.anchor:"")};B.prototype.buildRelative=function(){return Ap.contextPath()+this.buildRelNoContext()};B.prototype.buildAbsolute=function(){return location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+this.buildRelative()};B.prototype.toString=function(){return this.buildRelative()};B.prototype.addParams=function(Bj){var Bi=new B(this.components,A1.extend({},this.params));if(A1.isString(Bj)){Bi.params[Bj]=""}else{if(Bj.hasOwnProperty("queryParams")){Bi.params=A1.extend(Bi.params,Bj.queryParams)}else{if(!Bj.hasOwnProperty("urlMode")){Bi.params=A1.extend(Bi.params,Bj)}}}return Bi};B.prototype.withFragment=function(Bi){return new B(this.components,this.params,Bi)};B.prototype.pushComponents=function(){var Bi=new B(this.components.slice(0),this.params);A1.each(A1.toArray(arguments).slice(0),function(Bj){if(Bj!==""){Bi.components.push(Bj)}});return Bi};B.prototype.makeBuilder=function(Bi){var Bj=this;return A1.extend({_path:function(){return Bj},build:function(){return Bj.buildRelative()},buildAbsolute:function(){return Bj.buildAbsolute()},parse:function(){return BE(this.build())},withParams:function(Bk){return Bj.addParams(Bk).makeBuilder(Bi)},withFragment:function(Bk){return Bj.withFragment(Bk).makeBuilder(Bi)},addPathComponents:function(){return Bj.pushComponents.apply(Bj,arguments).makeBuilder(Bi)},toString:function(){A6.getMessageLogger("navbuilder.toString()","navbuilder.build()","2.6","3.0")();return this.build()}},Bi)};function L(Bi){if(typeof (Bi)==="string"){return Bi}else{if(!Bi){throw new Error(stash_i18n("stash.web.error.no.project","No project key was provided."))}}return Bi.getKey?Bi.getKey():Bi.key}function BX(){if(K.getProject()){return K.getProject()}throw new Error(stash_i18n("stash.web.error.no.project.context","There is no project in this context."))}function C(Bi){if(typeof (Bi)==="string"){return Bi}else{if(!Bi){throw new Error(stash_i18n("stash.web.error.no.repo","No repository slug was provided."))}}return Bi.getSlug?Bi.getSlug():Bi.slug}function c(Bi){if(typeof (Bi)==="string"){return Bi}else{if(!Bi){throw new Error(stash_i18n("stash.web.error.no.hook.key","No hook key was provided."))}}return Bi.getDetails().getKey()}function W(){if(K.getRepository()){return K.getRepository()}throw new Error(stash_i18n("stash.web.error.no.repo.context","There is no repository in this context."))}function Aj(Bi){if(typeof Bi in {string:1,number:1}){return Bi}else{if(!Bi){throw new Error(stash_i18n("stash.web.error.no.pull-request.id","No pull request ID was provided."))}}return Bi.getId()}function BC(){if(K.getPullRequest()){return K.getPullRequest()}throw new Error(stash_i18n("stash.web.error.no.pull-request.context","There is no pull request in this context."))}function o(){return new B("login").makeBuilder({next:Az})}function BG(){return new B("tmp").makeBuilder({avatars:AI})}function F(){return new B("admin").makeBuilder({permissions:AK,users:Bb,groups:AO,licensing:BL,mailServer:Ab,db:BI})}function BK(){return this._path().pushComponents("admin").makeBuilder({users:T})}function u(){return new B("projects").makeBuilder()}function G(){return new B("repos").makeBuilder({visibility:H})}function H(Bi){return this._path().addParams({visibility:Bi}).makeBuilder()}function Z(){return new B("captcha").addParams({ts:new Date().getTime().toString()}).makeBuilder()}function BB(Bj){var Bi=new B(["projects",L(Bj)]);return AL(Bi).makeBuilder({allRepos:J,repo:BU,createRepo:AT,settings:BD,permissions:AK,remove:Ag,users:Bb,groups:AO,avatar:AS})}function AL(Bl){var Bk=Bl.components[1];var Bj=/~(.*)/;var Bi=Bj.exec(Bk);if(Bi){return new B(["users",Bi[1].toLowerCase()])}else{return Bl}}function AD(){return BB(BX())}function AP(){return new B("projects").addParams("create").makeBuilder()}function Ai(Bi){Bi=Bi?Bi:"api";return new B(["rest",Bi,"latest"]).makeBuilder({project:A,currentProject:Bg,currentRepo:s,currentPullRequest:w,markup:V,profile:M,users:A8,groups:AN,hooks:Am,allRepos:J,admin:BK})}function A0(){return new B(["plugins","servlet","upm"]).makeBuilder({requests:Bh})}function A5(){return new B(["plugins","servlet"]).makeBuilder({path:Av})}function Av(){var Bi=this._path();return Bi.pushComponents.apply(Bi,S(arguments)).makeBuilder()}function Bh(){return this._path().pushComponents("requests","popular").makeBuilder({category:function(Bi){return this._path().addParams({category:Bi}).makeBuilder()}})}function Az(Bi){return this._path().addParams({next:Bi}).makeBuilder()}function AI(){return this._path().pushComponents("avatars").makeBuilder()}function AK(){return this._path().pushComponents("permissions").makeBuilder({permission:Aq,users:Bb,groups:AO})}function Aq(Bi){return this._path().pushComponents(Bi).makeBuilder({users:A4,groups:BZ,all:AW})}function A4(){return this._path().pushComponents("users").makeBuilder()}function BZ(){return this._path().pushComponents("groups").makeBuilder()}function AW(){return this._path().pushComponents("all").makeBuilder()}function At(){return this._path().pushComponents("anon").makeBuilder()}function BN(){return this._path().pushComponents("none").makeBuilder()}function J(){return AL(this._path()).pushComponents("repos").makeBuilder()}function Bb(){return this._path().pushComponents("users").makeBuilder({create:N,deleteUser:AJ,captcha:e,view:t,filter:As,deleteSuccess:BA,permissions:AK,none:BN})}function T(){return this._path().pushComponents("users").makeBuilder()}function i(Bi){return new B(["users",Bi]).makeBuilder()}function AO(){return this._path().pushComponents("groups").makeBuilder({create:N,deleteGroup:AJ,view:t,filter:As,deleteSuccess:BA,permissions:AK,none:BN})}function BL(){return this._path().pushComponents("license").makeBuilder({edit:AZ})}function AZ(){return this._path().addParams({edit:""}).makeBuilder()}function Ab(){return this._path().pushComponents("mail-server").makeBuilder()}function BI(){return this._path().pushComponents("db").makeBuilder()}function N(){return this._path().addParams({create:""}).makeBuilder()}function AJ(Bi){return this._path().addParams({name:Bi}).makeBuilder()}function e(Bi){return this._path().pushComponents("captcha").addParams({name:Bi}).makeBuilder()}function t(Bi){return this._path().pushComponents("view").addParams({name:Bi}).makeBuilder()}function As(Bi){return this._path().addParams({filter:Bi}).makeBuilder()}function BA(Bi){return this._path().addParams({deleted:Bi}).makeBuilder()}function AT(){return AL(this._path()).pushComponents("repos").addParams("create").makeBuilder()}function Ag(){return this._path().makeBuilder()}function BD(){return this._path().pushComponents("settings").makeBuilder()}function AS(Bj){var Bi=this._path().pushComponents("avatar.png");if(Bj){Bi=Bi.addParams({s:Bj})}return Bi.makeBuilder()}function BU(Bi){return AL(this._path()).pushComponents("repos",C(Bi)).makeBuilder({browse:R,diff:n,commits:AR,branches:Af,commit:Ao,changeset:Ao,settings:f,permissions:AK,hooks:BR,clone:z,fork:A3,allPullRequests:BJ,createPullRequest:BP,pullRequest:AV,build:function(){return this._path().pushComponents("browse").toString()}})}function E(){return AD().repo(K.getRepository())}function S(Bi){if(Bi.length===1){if(Bi[0]&&Bi[0].getComponents){return Bi[0].getComponents()}else{if(BQ.isArray(Bi[0])){return Bi[0]}}}return A1.toArray(Bi)}function R(){return this._path().pushComponents("browse").makeBuilder({path:AX,at:Ay})}function AX(){var Bi=this._path();return Bi.pushComponents.apply(Bi,S(arguments)).makeBuilder({at:Ay,until:I,raw:BT})}function Ay(Bj){var Bi=this._path();if(Bj){if(typeof Bj!=="string"){Bj=Bj.displayId||Bj}Bi=Bi.addParams({at:Bj})}return Bi.makeBuilder({until:I,raw:BT})}function I(Bi){return this._path().addParams({until:Bi}).makeBuilder({at:Ay,raw:BT})}function BT(){return this._path().addParams({raw:""}).makeBuilder()}function n(Bj){var Bk=this._path(),Bm;var Bl=(Bj.getCommitRange&&Bj.getPath&&Bj.getSrcPath);if(Bl){var Bi=Bj.getCommitRange();Bm=Bj.getPath();if(Bi.getPullRequest()){Bk=Bk.pushComponents("pull-requests",Bi.getPullRequest().getId())}else{Bk=Bk.addParams(BQ.extend({},{until:Bi.getUntilRevision()&&Bi.getUntilRevision().getId()}));var Bn=Bi.getSinceRevision()&&Bi.getSinceRevision().getId();if(Bn){Bk=Bk.addParams({since:Bn})}}}else{Bm=Bj}Bk=Bk.pushComponents("diff");Bk=Bk.pushComponents.apply(Bk,Bm&&S([Bm]));if(Bl&&Bj.getSrcPath()){Bk=Bk.addParams(BQ.extend({},{srcPath:Bj.getSrcPath().toString()}))}return Bk.makeBuilder({at:BV})}function BV(Bi){return this._path().addParams({at:Bi}).makeBuilder()}function AR(){return this._path().pushComponents("commits").makeBuilder({until:BF})}function Af(Bj){var Bi=this._path().pushComponents("branches");if(Bj&&!Bj.isDefault){if(typeof Bj!=="string"){Bj=Bj.displayId||Bj.id||Bj}Bi=Bi.addParams({base:Bj})}return Bi.makeBuilder()}function BF(Bj){var Bi=this._path();if(Bj&&!Bj.isDefault){if(typeof Bj!=="string"){Bj=Bj.displayId||Bj}Bi=Bi.addParams({until:Bj})}return Bi.makeBuilder()}function Ao(Bi){return this._path().pushComponents("commits",Bi).makeBuilder({comment:AY})}function AY(Bi){return this._path().addParams({commentId:Bi}).makeBuilder()}function f(){return this._path().pushComponents("settings").makeBuilder()}function BR(){return this._path().pushComponents("settings","hooks").makeBuilder()}function z(Bj){var Bl=this._path(),Bi=Bl.components[1].toLowerCase(),Bk=Bl.components[3].toLowerCase();if(Bl.components[0]==="users"){Bi="~"+Bi}return new B(["scm",Bi,Bk+"."+Bj],Bl.params).makeBuilder()}function A3(){return this._path().addParams("fork").makeBuilder()}function BJ(){return this._path().pushComponents("pull-requests").makeBuilder()}var Bf={sourceBranch:d,targetBranch:Be,source:A6.fn(d,"navbuilder.project().repo().createPullRequest().source()","navbuilder.project().repo().createPullRequest().sourceBranch()","2.4","3.0"),target:A6.fn(Be,"navbuilder.project().repo().createPullRequest().target()","navbuilder.project().repo().createPullRequest().targetBranch()","2.4","3.0")};function BP(){return this._path().pushComponents("pull-requests").addParams("create").makeBuilder(Bf)}function d(Bi){return this._path().addParams({sourceBranch:Bi}).makeBuilder(Bf)}function Be(Bi){return this._path().addParams({targetBranch:Bi}).makeBuilder(Bf)}function AV(Bi){return this._path().pushComponents("pull-requests",Aj(Bi)).makeBuilder({unwatch:k,activity:Ba,changeset:Y,overview:AF,diff:AC,commits:Ak,build:function(){return this._path().pushComponents("overview").toString()}})}function Au(){return E.call(this).pullRequest(BC())}var Ba=A6.fn(AF,"navbuilder::activity()","navbuilder::overview()","2.0","3.0");function AF(){return this._path().pushComponents("overview").makeBuilder({comment:U})}function k(){return this._path().pushComponents("unwatch").makeBuilder()}function Y(Bi){return this._path().pushComponents("commits",Bi).makeBuilder()}function U(Bi){return this._path().addParams({commentId:Bi}).makeBuilder()}function AC(){return this._path().pushComponents("diff").makeBuilder({change:function(Bi){return this._path().withFragment(Bi).makeBuilder()}})}function Ak(){return this._path().pushComponents("commits").makeBuilder()}function A(Bj){var Bi=L(Bj);return this._path().pushComponents("projects",Bi).makeBuilder({allRepos:Aa,repo:BY,permissions:P})}function Bg(){return A.call(this,BX())}function A9(Bj){var Bi=c(Bj);return this._path().pushComponents("settings").pushComponents("hooks",Bi).makeBuilder({enabled:Ad,settings:A2})}function Ad(){return this._path().pushComponents("enabled").makeBuilder()}function A2(){return this._path().pushComponents("settings").makeBuilder()}function Aa(){return this._path().pushComponents("repos").makeBuilder()}function BY(Bj){var Bi=C(Bj);return this._path().pushComponents("repos",Bi).makeBuilder({tags:l,branches:y,commits:a,commit:BS,changeset:BS,changes:BH,browse:q,files:Aw,related:j,pullRequest:Bd,allPullRequests:x,hooks:BR,hook:A9})}function s(){return Bg.call(this).repo(W())}function BH(Bi){if(Bi.getPullRequest()){return A1.bind(Bd,this)(Bi.getPullRequest()).changes()}else{if(Bi.getUntilRevision()){return this.changeset(Bi).changes()}else{throw new Error("A valid commit-range is required to retrieve changes")}}}function j(){return this._path().pushComponents("related").makeBuilder()}function Bd(Bi){var Bj=Aj(Bi);return this._path().pushComponents("pull-requests",Bj).makeBuilder({activities:function(){return this._path().pushComponents("activities").makeBuilder()},approve:m,comment:AU,comments:function(){return this._path().pushComponents("comments").makeBuilder()},changes:v,diff:Ax,watch:BW,merge:h,reopen:AB,decline:AQ})}function w(){return s.call(this).pullRequest(BC())}function x(){return this._path().pushComponents("pull-requests").makeBuilder()}function AU(Bi){return this._path().pushComponents("comments",Bi).makeBuilder({comment:AU})}function v(){return this._path().pushComponents("changes").makeBuilder()}function m(){return this._path().pushComponents("approve").makeBuilder()}function BW(){return this._path().pushComponents("watch").makeBuilder()}function h(){return this._path().pushComponents("merge").makeBuilder()}function AQ(){return this._path().pushComponents("decline").makeBuilder()}function AB(){return this._path().pushComponents("reopen").makeBuilder()}function l(){return this._path().pushComponents("tags").makeBuilder()}function y(){return this._path().pushComponents("branches").makeBuilder()}function a(){return this._path().pushComponents("commits").makeBuilder()}function BS(Bi){var Bk=this._path().pushComponents("commits");if(typeof Bi==="string"){Bk=Bk.pushComponents(Bi)}else{if(Bi.getUntilRevision){Bk=Bk.pushComponents(Bi.getUntilRevision().getId());var Bj=Bi.getSinceRevision()&&Bi.getSinceRevision().getId();if(Bj){Bk=Bk.addParams({since:Bj})}}else{throw new Error(stash_i18n("stash.web.error.no.commit.or.commitRange","No commit id or commit range was provided."))}}return Bk.makeBuilder({diff:Ax,changes:AH,comments:BO,watch:D})}function D(){return this._path().pushComponents("watch").makeBuilder()}function AH(){return this._path().pushComponents("changes").makeBuilder({path:Ac})}function Ax(Bi){var Bj=this._path();Bj=Bj.pushComponents("diff");Bj=Bj.pushComponents.apply(Bj,S([Bi.getPath()]));if(Bi.getSrcPath()){Bj=Bj.addParams({srcPath:Bi.getSrcPath().toString()})}return Bj.makeBuilder()}function BO(){return this._path().pushComponents("comments").makeBuilder({path:Ac})}function Ac(Bi){return this._path().addParams({path:Bi.toString()}).makeBuilder()}function q(){return this._path().pushComponents("browse").makeBuilder({path:AX,at:Ay})}function Aw(){return this._path().pushComponents("files").makeBuilder({all:Ae,path:AE,at:Ay})}function Ae(){return this._path().addParams({limit:100000}).makeBuilder({path:AE,at:Ay})}function AE(){var Bi=this._path();return Bi.pushComponents.apply(Bi,S(arguments)).makeBuilder({at:Ay})}function P(){return this._path().pushComponents("permissions").makeBuilder({projectRead:O,projectWrite:AG})}function O(){return this._path().pushComponents("project-read").makeBuilder({all:Ah,anon:g})}function AG(){return this._path().pushComponents("project-write").makeBuilder({all:Ah})}function Ah(){return this._path().pushComponents("all").makeBuilder({allow:An})}function g(){return this._path().pushComponents("anon").makeBuilder({allow:An})}function An(Bi){return this._path().addParams({allow:Bi}).makeBuilder()}function V(){return this._path().pushComponents("markup").makeBuilder({preview:AM})}function AM(){return this._path().pushComponents("preview").makeBuilder()}function M(){return this._path().pushComponents("profile").makeBuilder({recent:A7})}function A7(){return this._path().pushComponents("recent").makeBuilder({repos:Ar})}function Ar(){return this._path().pushComponents("repos").makeBuilder()}function A8(){return this._path().pushComponents("users").makeBuilder()}function AN(){return this._path().pushComponents("groups").makeBuilder()}function Am(){return this._path().pushComponents("hooks").makeBuilder({hook:AA})}function AA(Bi){return this._path().pushComponents(Bi).makeBuilder({avatar:Bc})}function Bc(Bi){return this._path().pushComponents("avatar").addParams({version:Bi}).makeBuilder()}function b(){return this._path().pushComponents("repos").makeBuilder()}var Q=/(default-avatar-)\d+(\.png)/;function r(Bi,Bj){return{build:function(){var Bk=BE(Bi.avatarUrl);if(Bk.getQueryParamValue("s")){Bk.replaceQueryParam("s",Bj)}return Bk.toString().replace(Q,"$1"+Bj+"$2")}}}function BE(Bi){return new X(Bi)}function BM(Bi){if(typeof Bi!=="string"){return"/"}else{return Bi+((Bi.charAt(Bi.length-1)!=="/")?"/":"")}}function Al(Bi,Bj){return new B(Bi,Bj)}p.login=o;p.tmp=BG;p.captcha=Z;p.admin=F;p.user=i;p.project=BB;p.pluginServlets=A5;p.addons=A0;p.allProjects=u;p.allRepos=G;p.createProject=AP;p.currentProject=AD;p.currentRepo=E;p.currentPullRequest=Au;p.rest=Ai;p.parse=BE;p.appendSlashToUrl=BM;p.avatarUrl=r;p.newBuilder=Al});