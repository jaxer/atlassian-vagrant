define("util/handler-registry",["jquery","underscore"],function(C,A){function B(){this.handlers=[]}B.prototype.register=function(E){if(!A.isFunction(E.handle)){throw new Error("Handler must have a handle function")}E.weight=typeof E.weight==="number"&&!isNaN(E.weight)?E.weight:1000;this.handlers.push(E);this.handlers=A.sortBy(this.handlers,function(G){return G.weight});var F=this;return function D(){var G=F.handlers.indexOf(E);if(G>=0){F.handlers.splice(G,1)}}};B.prototype._handle=function(G){var F=C.Deferred();var I;var D;var E=this.handlers;function H(J){if(I){return F.reject(new Error("Handling aborted."))}if(J<E.length){D=E[J].handle(G)||C.Deferred().reject();return C.when(D).done(function(K){F.resolve(K||{})}).fail(function(){H(J+1)})}else{F.reject(new Error("No registered handlers were able to handle file"))}}H(0);return F.promise({abort:function(){if(!I&&D&&D.abort){D.abort()}I=true}})};B.prototype._clear=function(){this.handlers=[]};return B});