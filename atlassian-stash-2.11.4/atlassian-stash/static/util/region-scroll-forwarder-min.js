define("util/region-scroll-forwarder",["bacon","jquery","underscore","util/bacon","util/function"],function(D,C,A,F,B){function E(H,N){var L=new D.Bus();N=A.map(N,function(P){var O=null;return C.extend({},P,{getCachedHeight:function(){if(O==null){O=P.getHeight()}return O},invalidateCache:function(){O=null}})});var G;H.subscribe(function(Q){if(!Q.isInitial()){return }var O=Q.value().top;var R=0;var P;A.forEach(N,function(U){var S=U.getCachedHeight();var T=R+S>=O;if(!P&&T){P=U;U.setScrollTop(O-R)}else{U.setScrollTop(T?0:S)}R+=S})})();var M=H.takeUntil(L).slidingWindow(2,2).map(B.spread(function(O,V){var U=0;var Q;var T=V.top-O.top;var S;var P=0;A.some(N,function(X){var W=X.getCachedHeight();if(!S&&P+W>=V.top){S=X;U=P}if(!Q&&P+W>=O.top){Q=X}P+=W;return S&&Q});if(!S){throw new Error("No forwardee handles "+V.top)}var R={scrollInfo:V,localTop:V.top-U,diff:T,forwardTo:S,previousRegion:Q};return R}));function K(P,O){A.chain(P).filter(function(R,Q,S){return !A.some(S.slice(0,Q),function(T){return R.groupId&&R.groupId===T.groupId})}).forEach(function(Q){Q.setScrollTop(O(Q)==="bottom"?Q.getCachedHeight():0)})}var I=M.onValue(function(R){G=R;var O=R.previousRegion;if(O!==R.forwardTo){var P=F.toArray(F.takeBetween(D.fromArray(N),{start:O,end:R.forwardTo,startInclusive:true,endInclusive:false}));var Q=R.diff>0;K(Q?P.reverse():P,B.constant(Q?"bottom":"top"))}R.forwardTo.setScrollTop(R.localTop)});function J(){A.invoke(N,"invalidateCache");if(G){var O=A.indexOf(N,G.forwardTo);K(A.reject(N,function(P){return P===G.forwardTo||P.groupId===G.forwardTo.groupId}),function(P){return A.indexOf(N,P)<O?"bottom":"top"});G.forwardTo.setScrollTop(G.localTop)}}return{regionChanges:M.map(".forwardTo").skipDuplicates(),forwardingInfo:M,heightsChanged:J,destroy:function(){I();L.push(true);L.end()}}}return E});