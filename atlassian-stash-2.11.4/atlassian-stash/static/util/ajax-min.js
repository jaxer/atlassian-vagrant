define("util/ajax",["aui","jquery","underscore","util/error","util/function","util/navbuilder","widget/error-dialog","model/page-state","exports"],function(M,F,N,A,J,G,P,L,D){F.ajaxSetup({timeout:60000});var H=false;function C(W,X,V,U){var R=new Date();if(R<V){var T=function(){var Y=Math.ceil((+V-+new Date())/X);if(Y<=0){clearInterval(S);U()}else{W.text(Y)}},S=setInterval(T,X);T()}else{U()}}function Q(T,S,V,W,U){var R=new Date();if(R<U){T.addClass("hidden");T.before(S);C(V,W,U,function(){S.remove();T.removeClass("hidden")})}}function O(V,W,Z,a){var U,R,e;function b(f){R=f;e=R.abort;R.abort=Y}function Y(){e.apply(R,arguments)}function T(o,w,i,t,u,v,l){if(o.shouldLogin){window.onbeforeunload=null;window.location.href=G.login().next(window.location.href).build();return F.Deferred()}if(w){delete w.errors}var p;if(!H){p=new P()}var s=o.shouldRetry&&!H?F.Deferred():F.Deferred().rejectWith(this,[t,i,u,w,p]);if(!H){var m="",j=false;var q=stash.widget.errorContent(o);p.addHideListener(function(){H=false});var r={id:"ajax-error",titleText:o.title,titleClass:o.titleClass||"error-header",showCloseButton:N.isUndefined(o.canClose)?true:o.canClose,closeOnOutsideClick:false};if(o.fallbackUrl){r.okButtonText=M.escapeHtml(o.fallbackTitle);p.addOkListener(function(x){window.location.href=o.fallbackUrl;x.preventDefault()})}else{if(o.shouldReload){r.okButtonText=M.escapeHtml(stash_i18n("stash.web.ajax.reload","Reload the page"));p.addOkListener(function(x){window.location.reload();x.preventDefault()})}else{if(o.shouldRetry){s.notify("stalled");if(o.retryAfterDate){if(+o.retryAfterDate-+new Date()>60*60*1000){m=stash_i18n("stash.web.retry.later","Unfortunately, the server won't be available for over an hour.")}else{j=true}}r.okButtonText=M.escapeHtml(stash_i18n("stash.web.ajax.try.again","Try again"));var n;p.addOkListener(function(x){s.notify("unstalled");p.remove();n=K(v,l);b(n);n.done(function(){return s.resolveWith(this,arguments)});n.fail(function(){return s.rejectWith(this,arguments)});x.preventDefault()});p.addHideListener(function(){if(s.state()==="pending"&&!n){s.rejectWith(this,[t,i,u,w])}})}else{r.showCloseButton=false}}}r.panelContent="<p>"+q+m+"</p>";p.reinit(r).show();H=true;if(j){var f,k;if(+o.retryAfterDate-+new Date()>60*1000){k=stash_i18n("stash.web.retry.in.x.minutes","Retry in {0}m{1}","<time><span></span>","</time>");f=60*1000}else{k=stash_i18n("stash.web.retry.in.x.seconds","Retry in {0}s{1}","<time><span></span>","</time>");f=1000}var h=F("<span>"+k+"</span>"),g=h.children("time").children();Q(p.getOkButton(),h,g,f,o.retryAfterDate)}}return s}function c(h,f,g,i,n,m){var l=a?A.getDominantRESTError(h,g):A.getDominantAJAXError(g),j=true;if(n){var k=n(l);if(k&&typeof k.promise==="function"){return k.promise(g)}if(k&&N.isObject(k)){l=k}j=k!==false}if(j&&l){return T(l,h,f,g,i,W,a)}else{return m()}}function d(f){var g=Z[f];if(g===undefined||g===null){g=Z["*"]}if(typeof g==="function"){return g}else{return J.constant(g)}}function X(j,k,i){var g=this;var h=d(i.status),f=h?N.bind(h,g,j,k,i):null;return c(j,k,i,null,f,function(){return F.Deferred().resolveWith(g,[j,k,i])})}function S(i,m,l){var g=this;var j=i.responseText;try{j=JSON.parse(j)}catch(k){}var h=d(i.status),f=h?N.bind(h,g,i,m,l,j):null;return c(j,m,i,l,f,function(){return F.Deferred().rejectWith(g,[i,m,l,j])})}b(V);U=V.then(X,S);return U.promise(V)}function K(T,S){var R;if(T.statusCode){R=T.statusCode;delete T.statusCode}R=R||{};var U=O(F.ajax(T),T,R,S);U.statusCode=function(W){if(W){if(U.state()==="pending"){F.extend(R,W)}else{for(var X in W){if(W.hasOwnProperty(X)){M.log("xhr.statusCode() should not be called after the request has completed. Your handler will have no affect on the resolution of the request.");break}}var V=W[U.status];U.then(V,V)}}};return U}function B(R){var S={};if(L.getCurrentUser()){S["X-AUSERNAME"]=L.getCurrentUser().getName();S["X-AUSERID"]=L.getCurrentUser().getId()}R=F.extend(true,{dataType:"json",contentType:"application/json",headers:S,jsonp:false,type:"GET"},R);if(R.type.toUpperCase()!=="GET"&&(F.isPlainObject(R.data)||F.isArray(R.data))){R.data=JSON.stringify(R.data)}return K(R,true)}function E(R){var S=N.reduce(R.find("input[type=checkbox]:checked"),function(V,U){var T=F(U);if(T.attr("value")==="on"){V[T.attr("name")]=true}return V},{});return N.reduce(R.serializeArray(),function(W,U){var V=W[U.name],T=U.value===undefined?"":U.value;if(S[U.name]){T=true}if(V!==undefined){if(!F.isArray(V)){W[U.name]=[V]}W[U.name].push(T)}else{W[U.name]=T}return W},{})}function I(S){S=F.extend({pollTimeout:60000,interval:500,tick:F.noop},S);var T=false;var V=false;var X=F.Deferred(),U=new Date().getTime(),R=function(){if(T||V){return }V=true;B(S).done(function(Z,b,a){var Y=S.tick(Z,b,a);if(Y){X.resolveWith(this,[Z,b,a])}else{if((new Date().getTime()-U)>S.pollTimeout||typeof Y!=="undefined"){X.rejectWith(this,[a,b,null,Z])}else{setTimeout(R,S.interval)}}}).fail(function(a,b,Z,Y){X.rejectWith(this,[a,b,Z,Y])}).always(function(){V=false})};setTimeout(R,S.interval);var W=X.promise();W.resume=function(){if(T){T=false;R()}};W.pause=function(){T=true};return W}D.ignore404WithinRepository=function(R){return{"404":function(X,S,W,U,V){var T=U&&U.errors&&U.errors.length&&U.errors[0];if(A.isErrorEntityWithinRepository(T)){return R&&R(U)||false}}}};D.ajax=K;D.rest=B;D.poll=I;D.formToJSON=E});